/* webpackIgnore: true */
import * as fs from 'fs';
import { RenderingStrategy, } from './ssr-optimization-options';
import { RenderingCache } from './rendering-cache';
/**
 * The rendered pages are kept in memory to be served on next request. If the `cache` is set to `false`, the
 * response is evicted as soon as the first successful response is successfully returned.
 */
export class OptimizedSsrEngine {
    constructor(expressEngine, ssrOptions) {
        this.expressEngine = expressEngine;
        this.ssrOptions = ssrOptions;
        this.currentConcurrency = 0;
        this.renderingCache = new RenderingCache(this.ssrOptions);
        this.templateCache = new Map();
    }
    get engineInstance() {
        return this.renderResponse.bind(this);
    }
    /**
     * When SSR page can not be returned in time, we're returning index.html of
     * the CSR application.
     * The CSR application is returned with the "Cache-Control: no-store" response-header. This notifies external cache systems to not use the CSR application for the subsequent request.
     */
    fallbackToCsr(response, filePath, callback) {
        response.set('Cache-Control', 'no-store');
        callback(undefined, this.getDocument(filePath));
    }
    getRenderingKey(request) {
        var _a;
        return ((_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.renderKeyResolver) ? this.ssrOptions.renderKeyResolver(request)
            : request.originalUrl;
    }
    getRenderingStrategy(request) {
        var _a;
        return ((_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.renderingStrategyResolver) ? this.ssrOptions.renderingStrategyResolver(request)
            : RenderingStrategy.DEFAULT;
    }
    shouldRender(request) {
        var _a, _b;
        const concurrencyLimitExceed = ((_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.concurrency) ? this.currentConcurrency >= this.ssrOptions.concurrency
            : false;
        const isRendering = this.renderingCache.isRendering(this.getRenderingKey(request));
        if (isRendering) {
            this.log(`CSR fallback: rendering in progress (${request.url})`);
        }
        else if (concurrencyLimitExceed) {
            this.log(`CSR fallback: Concurrency limit exceeded (${(_b = this.ssrOptions) === null || _b === void 0 ? void 0 : _b.concurrency})`);
        }
        return ((!isRendering &&
            !concurrencyLimitExceed &&
            this.getRenderingStrategy(request) !== RenderingStrategy.ALWAYS_CSR) ||
            this.getRenderingStrategy(request) === RenderingStrategy.ALWAYS_SSR);
    }
    shouldTimeout(request) {
        var _a;
        return (!!((_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.timeout) ||
            this.getRenderingStrategy(request) === RenderingStrategy.ALWAYS_SSR);
    }
    getTimeout(request) {
        var _a, _b, _c, _d;
        return this.getRenderingStrategy(request) === RenderingStrategy.ALWAYS_SSR
            ? (_b = (_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.forcedSsrTimeout) !== null && _b !== void 0 ? _b : 60000 : (_d = (_c = this.ssrOptions) === null || _c === void 0 ? void 0 : _c.timeout) !== null && _d !== void 0 ? _d : 0;
    }
    returnCachedRender(request, callback) {
        var _a;
        const key = this.getRenderingKey(request);
        if (this.renderingCache.isReady(key)) {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const cached = this.renderingCache.get(key);
            callback(cached.err, cached.html);
            if (!((_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.cache)) {
                // we drop cached rendering if caching is disabled
                this.renderingCache.clear(key);
            }
            return true;
        }
        return false;
    }
    renderResponse(filePath, options, callback) {
        const request = options.req;
        const response = options.res || options.req.res;
        const renderingKey = this.getRenderingKey(request);
        if (!this.returnCachedRender(request, callback)) {
            if (this.shouldRender(request)) {
                this.currentConcurrency++;
                let waitingForRender;
                if (this.shouldTimeout(request)) {
                    // establish timeout for rendering
                    const timeout = this.getTimeout(request);
                    waitingForRender = setTimeout(() => {
                        waitingForRender = undefined;
                        this.fallbackToCsr(response, filePath, callback);
                        this.log(`SSR rendering exceeded timeout ${timeout}, fallbacking to CSR for ${request === null || request === void 0 ? void 0 : request.url}`, false);
                    }, timeout);
                }
                else {
                    this.fallbackToCsr(response, filePath, callback);
                }
                // start rendering
                this.renderingCache.setAsRendering(renderingKey);
                this.log(`Rendering started (${request === null || request === void 0 ? void 0 : request.url})`);
                this.expressEngine(filePath, options, (err, html) => {
                    var _a;
                    this.currentConcurrency--;
                    this.log(`Rendering completed (${request === null || request === void 0 ? void 0 : request.url})`);
                    if (waitingForRender) {
                        // if request is still waiting for render, return it
                        clearTimeout(waitingForRender);
                        callback(err, html);
                        // store the render only if caching is enabled
                        if ((_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.cache) {
                            this.renderingCache.store(renderingKey, err, html);
                        }
                        else {
                            this.renderingCache.clear(renderingKey);
                        }
                    }
                    else {
                        // store the render for future use
                        this.renderingCache.store(renderingKey, err, html);
                    }
                });
            }
            else {
                // if there is already rendering in progress, return the fallback
                this.fallbackToCsr(response, filePath, callback);
            }
        }
        else {
            this.log(`Render from cache (${request === null || request === void 0 ? void 0 : request.url})`);
        }
    }
    log(message, debug = true) {
        var _a;
        if (!debug || ((_a = this.ssrOptions) === null || _a === void 0 ? void 0 : _a.debug)) {
            console.log(message);
        }
    }
    /** Retrieve the document from the cache or the filesystem */
    getDocument(filePath) {
        let doc = this.templateCache.get(filePath);
        if (!doc) {
            // fs.readFileSync could be missing in a browser, specifically
            // in a unit tests with { node: { fs: 'empty' } } webpack configuration
            doc = (fs === null || fs === void 0 ? void 0 : fs.readFileSync) ? fs.readFileSync(filePath, 'utf-8') : '';
            this.templateCache.set(filePath, doc);
        }
        return doc;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW1pemVkLXNzci1lbmdpbmUuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvUGF0cnlrL0Rlc2t0b3Avc3BhcnRhY3VzL2NvcmUtbGlicy9zZXR1cC9zc3IvIiwic291cmNlcyI6WyJvcHRpbWl6ZWQtZW5naW5lL29wdGltaXplZC1zc3ItZW5naW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHlCQUF5QjtBQUN6QixPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEVBQ0wsaUJBQWlCLEdBRWxCLE1BQU0sNEJBQTRCLENBQUM7QUFDcEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBSW5EOzs7R0FHRztBQUNILE1BQU0sT0FBTyxrQkFBa0I7SUFTN0IsWUFDWSxhQUFzQyxFQUN0QyxVQUFtQztRQURuQyxrQkFBYSxHQUFiLGFBQWEsQ0FBeUI7UUFDdEMsZUFBVSxHQUFWLFVBQVUsQ0FBeUI7UUFWckMsdUJBQWtCLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLG1CQUFjLEdBQUcsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3ZELGtCQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7SUFTL0MsQ0FBQztJQVBKLElBQUksY0FBYztRQUNoQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFPRDs7OztPQUlHO0lBQ08sYUFBYSxDQUNyQixRQUFrQixFQUNsQixRQUFnQixFQUNoQixRQUFxRDtRQUVyRCxRQUFRLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUMxQyxRQUFRLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRVMsZUFBZSxDQUFDLE9BQWdCOztRQUN4QyxPQUFPLE9BQUEsSUFBSSxDQUFD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U0FDakQ7SUFDSCxDQUFDO0lBRVMsR0FBRyxDQUFDLE9BQWUsRUFBRSxLQUFLLEdBQUcsSUFBSTs7UUFDekMsSUFBSSxDQUFDLEtBQUssV0FBSSxJQUFJLENBQUMsVUFBVSwwQ0FBRSxLQUFLLENBQUEsRUFBRTtZQUNwQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUVELDZEQUE2RDtJQUNuRCxXQUFXLENBQUMsUUFBZ0I7UUFDcEMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFM0MsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNSLDhEQUE4RDtZQUM5RCx1RUFBdUU7WUFDdkUsR0FBRyxHQUFHLENBQUEsRUFBRSxhQUFGLEVBQUUsdUJBQUYsRUFBRSxDQUFFLFlBQVksRUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNqRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDdkM7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qIHdlYnBhY2tJZ25vcmU6IHRydWUgKi9cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7XG4gIFJlbmRlcmluZ1N0cmF0ZWd5LFxuICBTc3JPcHRpbWl6YXRpb25PcHRpb25zLFxufSBmcm9tICcuL3Nzci1vcHRpbWl6YXRpb24tb3B0aW9ucyc7XG5pbXBvcnQgeyBSZW5kZXJpbmdDYWNoZSB9IGZyb20gJy4vcmVuZGVyaW5nLWNhY2hlJztcbmltcG9ydCB7IE5nRXhwcmVzc0VuZ2luZUluc3RhbmNlIH0gZnJvbSAnLi4vZW5naW5lLWRlY29yYXRvci9uZy1leHByZXNzLWVuZ2luZS1kZWNvcmF0b3InO1xuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcblxuLyoqXG4gKiBUaGUgcmVuZGVyZWQgcGFnZXMgYXJlIGtlcHQgaW4gbWVtb3J5IHRvIGJlIHNlcnZlZCBvbiBuZXh0IHJlcXVlc3QuIElmIHRoZSBgY2FjaGVgIGlzIHNldCB0byBgZmFsc2VgLCB0aGVcbiAqIHJlc3BvbnNlIGlzIGV2aWN0ZWQgYXMgc29vbiBhcyB0aGUgZmlyc3Qgc3VjY2Vzc2Z1bCByZXNwb25zZSBpcyBzdWNjZXNzZnVsbHkgcmV0dXJuZWQuXG4gKi9cbmV4cG9ydCBjbGFzcyBPcHRpbWl6ZWRTc3JFbmdpbmUge1xuICBwcm90ZWN0ZWQgY3VycmVudENvbmN1cnJlbmN5ID0gMDtcbiAgcHJvdGVjdGVkIHJlbmRlcmluZ0NhY2hlID0gbmV3IFJlbmRlcmluZ0NhY2hlKHRoaXMuc3NyT3B0aW9ucyk7XG4gIHByaXZhdGUgdGVtcGxhdGVDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG5cbiAgZ2V0IGVuZ2luZUluc3RhbmNlKCk6IE5nRXhwcmVzc0VuZ2luZUluc3RhbmNlIHtcbiAgICByZXR1cm4gdGhpcy5yZW5kZXJSZXNwb25zZS5iaW5kKHRoaXMpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGV4cHJlc3NFbmdpbmU6IE5nRXhwcmVzc0VuZ2luZUluc3RhbmNlLFxuICAgIHByb3RlY3RlZCBzc3JPcHRpb25zPzogU3NyT3B0aW1pemF0aW9uT3B0aW9uc1xuICApIHt9XG5cbiAgLyoqXG4gICAqIFdoZW4gU1NSIHBhZ2UgY2FuIG5vdCBiZSByZXR1cm5lZCBpbiB0aW1lLCB3ZSdyZSByZXR1cm5pbmcgaW5kZXguaHRtbCBvZlxuICAgKiB0aGUgQ1NSIGFwcGxpY2F0aW9uLlxuICAgKiBUaGUgQ1NSIGFwcGxpY2F0aW9uIGlzIHJldHVybmVkIHdpdGggdGhlIFwiQ2FjaGUtQ29udHJvbDogbm8tc3RvcmVcIiByZXNwb25zZS1oZWFkZXIuIFRoaXMgbm90aWZpZXMgZXh0ZXJuYWwgY2FjaGUgc3lzdGVtcyB0byBub3QgdXNlIHRoZSBDU1IgYXBwbGljYXRpb24gZm9yIHRoZSBzdWJzZXF1ZW50IHJlcXVlc3QuXG4gICAqL1xuICBwcm90ZWN0ZWQgZmFsbGJhY2tUb0NzcihcbiAgICByZXNwb25zZTogUmVzcG9uc2UsXG4gICAgZmlsZVBhdGg6IHN0cmluZyxcbiAgICBjYWxsYmFjazogKGVycj86IEVycm9yIHwgbnVsbCwgaHRtbD86IHN0cmluZykgPT4gdm9pZFxuICApIHtcbiAgICByZXNwb25zZS5zZXQoJ0NhY2hlLUNvbnRyb2wnLCAnbm8tc3RvcmUnKTtcbiAgICBjYWxsYmFjayh1bmRlZmluZWQsIHRoaXMuZ2V0RG9jdW1lbnQoZmlsZVBhdGgpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRSZW5kZXJpbmdLZXkocmVxdWVzdDogUmVxdWVzdCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc3NyT3B0aW9ucz8ucmVuZGVyS2V5UmVzb2x2ZXJcbiAgICAgID8gdGhpcy5zc3JPcHRpb25zLnJlbmRlcktleVJlc29sdmVyKHJlcXVlc3QpXG4gICAgICA6IHJlcXVlc3Qub3JpZ2luYWxVcmw7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0UmVuZGVyaW5nU3RyYXRlZ3kocmVxdWVzdDogUmVxdWVzdCk6IFJlbmRlcmluZ1N0cmF0ZWd5IHtcbiAgICByZXR1cm4gdGhpcy5zc3JPcHRpb25zPy5yZW5kZXJpbmdTdHJhdGVneVJlc29sdmVyXG4gICAgICA/IHRoaXMuc3NyT3B0aW9ucy5yZW5kZXJpbmdTdHJhdGVneVJlc29sdmVyKHJlcXVlc3QpXG4gICAgICA6IFJlbmRlcmluZ1N0cmF0ZWd5LkRFRkFVTFQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2hvdWxkUmVuZGVyKHJlcXVlc3Q6IFJlcXVlc3QpOiBib29sZWFuIHtcbiAgICBjb25zdCBjb25jdXJyZW5jeUxpbWl0RXhjZWVkID0gdGhpcy5zc3JPcHRpb25zPy5jb25jdXJyZW5jeVxuICAgICAgPyB0aGlzLmN1cnJlbnRDb25jdXJyZW5jeSA+PSB0aGlzLnNzck9wdGlvbnMuY29uY3VycmVuY3lcbiAgICAgIDogZmFsc2U7XG5cbiAgICBjb25zdCBpc1JlbmRlcmluZyA9IHRoaXMucmVuZGVyaW5nQ2FjaGUuaXNSZW5kZXJpbmcoXG4gICAgICB0aGlzLmdldFJlbmRlcmluZ0tleShyZXF1ZXN0KVxuICAgICk7XG5cbiAgICBpZiAoaXNSZW5kZXJpbmcpIHtcbiAgICAgIHRoaXMubG9nKGBDU1IgZmFsbGJhY2s6IHJlbmRlcmluZyBpbiBwcm9ncmVzcyAoJHtyZXF1ZXN0LnVybH0pYCk7XG4gICAgfSBlbHNlIGlmIChjb25jdXJyZW5jeUxpbWl0RXhjZWVkKSB7XG4gICAgICB0aGlzLmxvZyhcbiAgICAgICAgYENTUiBmYWxsYmFjazogQ29uY3VycmVuY3kgbGltaXQgZXhjZWVkZWQgKCR7dGhpcy5zc3JPcHRpb25zPy5jb25jdXJyZW5jeX0pYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gKFxuICAgICAgKCFpc1JlbmRlcmluZyAmJlxuICAgICAgICAhY29uY3VycmVuY3lMaW1pdEV4Y2VlZCAmJlxuICAgICAgICB0aGlzLmdldFJlbmRlcmluZ1N0cmF0ZWd5KHJlcXVlc3QpICE9PSBSZW5kZXJpbmdTdHJhdGVneS5BTFdBWVNfQ1NSKSB8fFxuICAgICAgdGhpcy5nZXRSZW5kZXJpbmdTdHJhdGVneShyZXF1ZXN0KSA9PT0gUmVuZGVyaW5nU3RyYXRlZ3kuQUxXQVlTX1NTUlxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2hvdWxkVGltZW91dChyZXF1ZXN0OiBSZXF1ZXN0KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgICEhdGhpcy5zc3JPcHRpb25zPy50aW1lb3V0IHx8XG4gICAgICB0aGlzLmdldFJlbmRlcmluZ1N0cmF0ZWd5KHJlcXVlc3QpID09PSBSZW5kZXJpbmdTdHJhdGVneS5BTFdBWVNfU1NSXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRUaW1lb3V0KHJlcXVlc3Q6IFJlcXVlc3QpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmdldFJlbmRlcmluZ1N0cmF0ZWd5KHJlcXVlc3QpID09PSBSZW5kZXJpbmdTdHJhdGVneS5BTFdBWVNfU1NSXG4gICAgICA/IHRoaXMuc3NyT3B0aW9ucz8uZm9yY2VkU3NyVGltZW91dCA/PyA2MDAwMFxuICAgICAgOiB0aGlzLnNzck9wdGlvbnM/LnRpbWVvdXQgPz8gMDtcbiAgfVxuXG4gIHByb3RlY3RlZCByZXR1cm5DYWNoZWRSZW5kZXIoXG4gICAgcmVxdWVzdDogUmVxdWVzdCxcbiAgICBjYWxsYmFjazogKGVycj86IEVycm9yIHwgbnVsbCwgaHRtbD86IHN0cmluZykgPT4gdm9pZFxuICApOiBib29sZWFuIHtcbiAgICBjb25zdCBrZXkgPSB0aGlzLmdldFJlbmRlcmluZ0tleShyZXF1ZXN0KTtcblxuICAgIGlmICh0aGlzLnJlbmRlcmluZ0NhY2hlLmlzUmVhZHkoa2V5KSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMucmVuZGVyaW5nQ2FjaGUuZ2V0KGtleSkhO1xuICAgICAgY2FsbGJhY2soY2FjaGVkLmVyciwgY2FjaGVkLmh0bWwpO1xuXG4gICAgICBpZiAoIXRoaXMuc3NyT3B0aW9ucz8uY2FjaGUpIHtcbiAgICAgICAgLy8gd2UgZHJvcCBjYWNoZWQgcmVuZGVyaW5nIGlmIGNhY2hpbmcgaXMgZGlzYWJsZWRcbiAgICAgICAgdGhpcy5yZW5kZXJpbmdDYWNoZS5jbGVhcihrZXkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByb3RlY3RlZCByZW5kZXJSZXNwb25zZShcbiAgICBmaWxlUGF0aDogc3RyaW5nLFxuICAgIG9wdGlvbnM6IGFueSxcbiAgICBjYWxsYmFjazogKGVycj86IEVycm9yIHwgbnVsbCwgaHRtbD86IHN0cmluZykgPT4gdm9pZFxuICApOiB2b2lkIHtcbiAgICBjb25zdCByZXF1ZXN0OiBSZXF1ZXN0ID0gb3B0aW9ucy5yZXE7XG4gICAgY29uc3QgcmVzcG9uc2U6IFJlc3BvbnNlID0gb3B0aW9ucy5yZXMgfHwgb3B0aW9ucy5yZXEucmVzO1xuXG4gICAgY29uc3QgcmVuZGVyaW5nS2V5ID0gdGhpcy5nZXRSZW5kZXJpbmdLZXkocmVxdWVzdCk7XG5cbiAgICBpZiAoIXRoaXMucmV0dXJuQ2FjaGVkUmVuZGVyKHJlcXVlc3QsIGNhbGxiYWNrKSkge1xuICAgICAgaWYgKHRoaXMuc2hvdWxkUmVuZGVyKHJlcXVlc3QpKSB7XG4gICAgICAgIHRoaXMuY3VycmVudENvbmN1cnJlbmN5Kys7XG4gICAgICAgIGxldCB3YWl0aW5nRm9yUmVuZGVyOiBOb2RlSlMuVGltZW91dCB8IHVuZGVmaW5lZDtcblxuICAgICAgICBpZiAodGhpcy5zaG91bGRUaW1lb3V0KHJlcXVlc3QpKSB7XG4gICAgICAgICAgLy8gZXN0YWJsaXNoIHRpbWVvdXQgZm9yIHJlbmRlcmluZ1xuICAgICAgICAgIGNvbnN0IHRpbWVvdXQgPSB0aGlzLmdldFRpbWVvdXQocmVxdWVzdCk7XG4gICAgICAgICAgd2FpdGluZ0ZvclJlbmRlciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgd2FpdGluZ0ZvclJlbmRlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHRoaXMuZmFsbGJhY2tUb0NzcihyZXNwb25zZSwgZmlsZVBhdGgsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgIHRoaXMubG9nKFxuICAgICAgICAgICAgICBgU1NSIHJlbmRlcmluZyBleGNlZWRlZCB0aW1lb3V0ICR7dGltZW91dH0sIGZhbGxiYWNraW5nIHRvIENTUiBmb3IgJHtyZXF1ZXN0Py51cmx9YCxcbiAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSwgdGltZW91dCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5mYWxsYmFja1RvQ3NyKHJlc3BvbnNlLCBmaWxlUGF0aCwgY2FsbGJhY2spO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gc3RhcnQgcmVuZGVyaW5nXG4gICAgICAgIHRoaXMucmVuZGVyaW5nQ2FjaGUuc2V0QXNSZW5kZXJpbmcocmVuZGVyaW5nS2V5KTtcbiAgICAgICAgdGhpcy5sb2coYFJlbmRlcmluZyBzdGFydGVkICgke3JlcXVlc3Q/LnVybH0pYCk7XG4gICAgICAgIHRoaXMuZXhwcmVzc0VuZ2luZShmaWxlUGF0aCwgb3B0aW9ucywgKGVyciwgaHRtbCkgPT4ge1xuICAgICAgICAgIHRoaXMuY3VycmVudENvbmN1cnJlbmN5LS07XG5cbiAgICAgICAgICB0aGlzLmxvZyhgUmVuZGVyaW5nIGNvbXBsZXRlZCAoJHtyZXF1ZXN0Py51cmx9KWApO1xuXG4gICAgICAgICAgaWYgKHdhaXRpbmdGb3JSZW5kZXIpIHtcbiAgICAgICAgICAgIC8vIGlmIHJlcXVlc3QgaXMgc3RpbGwgd2FpdGluZyBmb3IgcmVuZGVyLCByZXR1cm4gaXRcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh3YWl0aW5nRm9yUmVuZGVyKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgaHRtbCk7XG5cbiAgICAgICAgICAgIC8vIHN0b3JlIHRoZSByZW5kZXIgb25seSBpZiBjYWNoaW5nIGlzIGVuYWJsZWRcbiAgICAgICAgICAgIGlmICh0aGlzLnNzck9wdGlvbnM/LmNhY2hlKSB7XG4gICAgICAgICAgICAgIHRoaXMucmVuZGVyaW5nQ2FjaGUuc3RvcmUocmVuZGVyaW5nS2V5LCBlcnIsIGh0bWwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJpbmdDYWNoZS5jbGVhcihyZW5kZXJpbmdLZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBzdG9yZSB0aGUgcmVuZGVyIGZvciBmdXR1cmUgdXNlXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmluZ0NhY2hlLnN0b3JlKHJlbmRlcmluZ0tleSwgZXJyLCBodG1sKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gaWYgdGhlcmUgaXMgYWxyZWFkeSByZW5kZXJpbmcgaW4gcHJvZ3Jlc3MsIHJldHVybiB0aGUgZmFsbGJhY2tcbiAgICAgICAgdGhpcy5mYWxsYmFja1RvQ3NyKHJlc3BvbnNlLCBmaWxlUGF0aCwgY2FsbGJhY2spO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZyhgUmVuZGVyIGZyb20gY2FjaGUgKCR7cmVxdWVzdD8udXJsfSlgKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgbG9nKG1lc3NhZ2U6IHN0cmluZywgZGVidWcgPSB0cnVlKSB7XG4gICAgaWYgKCFkZWJ1ZyB8fCB0aGlzLnNzck9wdGlvbnM/LmRlYnVnKSB7XG4gICAgICBjb25zb2xlLmxvZyhtZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICAvKiogUmV0cmlldmUgdGhlIGRvY3VtZW50IGZyb20gdGhlIGNhY2hlIG9yIHRoZSBmaWxlc3lzdGVtICovXG4gIHByb3RlY3RlZCBnZXREb2N1bWVudChmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBsZXQgZG9jID0gdGhpcy50ZW1wbGF0ZUNhY2hlLmdldChmaWxlUGF0aCk7XG5cbiAgICBpZiAoIWRvYykge1xuICAgICAgLy8gZnMucmVhZEZpbGVTeW5jIGNvdWxkIGJlIG1pc3NpbmcgaW4gYSBicm93c2VyLCBzcGVjaWZpY2FsbHlcbiAgICAgIC8vIGluIGEgdW5pdCB0ZXN0cyB3aXRoIHsgbm9kZTogeyBmczogJ2VtcHR5JyB9IH0gd2VicGFjayBjb25maWd1cmF0aW9uXG4gICAgICBkb2MgPSBmcz8ucmVhZEZpbGVTeW5jID8gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCAndXRmLTgnKSA6ICcnO1xuICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlLnNldChmaWxlUGF0aCwgZG9jKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZG9jO1xuICB9XG59XG4iXX0=