import { Injectable, Optional } from '@angular/core';
import { select, Store } from '@ngrx/store';
import { filter, tap } from 'rxjs/operators';
import { UserIdService } from '../../auth/user-auth/facade/user-id.service';
import { OCC_USER_ID_ANONYMOUS } from '../../occ/utils/occ-constants';
import { getProcessErrorFactory, getProcessLoadingFactory, getProcessSuccessFactory, } from '../../process/store/selectors/process.selectors';
import { UserActions } from '../store/actions/index';
import { UsersSelectors } from '../store/selectors/index';
import { REGISTER_USER_PROCESS_ID, REMOVE_USER_PROCESS_ID, UPDATE_EMAIL_PROCESS_ID, UPDATE_PASSWORD_PROCESS_ID, UPDATE_USER_DETAILS_PROCESS_ID, USER_FEATURE, } from '../store/user-state';
import { UserAccountFacadeTransitionalToken, UserProfileFacadeTransitionalToken, UserRegisterFacadeTransitionalToken, } from '../user-transitional-tokens';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/store";
import * as i2 from "../../auth/user-auth/facade/user-id.service";
import * as i3 from "../user-transitional-tokens";
export class UserService {
    constructor(store, userIdService, 
    // TODO: Remove transitional tokens in 4.0 with #11607
    userAccountFacade, userProfileFacade, userRegisterFacade) {
        this.store = store;
        this.userIdService = userIdService;
        this.userAccountFacade = userAccountFacade;
        this.userProfileFacade = userProfileFacade;
        this.userRegisterFacade = userRegisterFacade;
    }
    /**
     * Returns a user.
     *
     * @deprecated since 3.2, use `UserAccountFacade.get()` from `@spartacus/user` package.
     */
    get() {
        if (this.userAccountFacade) {
            return this.userAccountFacade.get();
        }
        return this.store.pipe(
        // workaround for using lazy loaded user/account library
        filter((state) => state[USER_FEATURE]), select(UsersSelectors.getDetails), tap((details) => {
            if (Object.keys(details).length === 0) {
                this.load();
            }
        }));
    }
    /**
     * Loads the user's details.
     *
     * @deprecated since 3.2, use `UserAccountFacade.get()` from `@spartacus/user` package.
     */
    load() {
        this.userIdService.invokeWithUserId((userId) => {
            if (userId !== OCC_USER_ID_ANONYMOUS) {
                this.store.dispatch(new UserActions.LoadUserDetails(userId));
            }
        });
    }
    /**
     * Register a new user.
     *
     * @param submitFormData as UserRegisterFormData
     *
     * @deprecated since 3.2, use `UserRegisterFacade.register()` from `@spartacus/user` package.
     */
    register(userRegisterFormData) {
        this.store.dispatch(new UserActions.RegisterUser(userRegisterFormData));
    }
    /**
     * Register a new user from guest.
     *
     * @param guid
     * @param password
     */
    registerGuest(guid, password) {
        if (this.userRegisterFacade) {
            this.userRegisterFacade.registerGuest(guid, password);
        }
        else {
            this.store.dispatch(new UserActions.RegisterGuest({ guid, password }));
        }
    }
    /**
     * Returns the register user process loading flag.
     *
     * @deprecated since 3.2, subscribe to `UserRegisterFacade.register()` from `@spartacus/user` package
     * to get the loading state.
     */
    getRegisterUserResultLoading() {
        return this.store.pipe(select(getProcessLoadingFactory(REGISTER_USER_PROCESS_ID)));
    }
    /**
     * Returns the register user process success flag.
     *
     * @deprecated since 3.2, subscribe to `UserRegisterFacade.register()` from `@spartacus/user` package
     * to get the success state.
     */
    getRegisterUserResultSuccess() {
        return this.store.pipe(select(getProcessSuccessFactory(REGISTER_USER_PROCESS_ID)));
    }
    /**
     * Returns the register user process error flag
     *
     * @deprecated since 3.2, subscribe to `UserRegisterFacade.register()` from `@spartacus/user` package
     * to get the error state.
     */
    getRegisterUserResultError() {
        return this.store.pipe(select(getProcessErrorFactory(REGISTER_USER_PROCESS_ID)));
    }
    /**
     * Resets the register user process flags
     *
     * @deprecated since 3.2, no longer needed when you use `UserRegisterFacade.register()`
     * from `@spartacus/user` package.
     */
    resetRegisterUserProcessState() {
        return this.store.dispatch(new UserActions.ResetRegisterUserProcess());
    }
    /**
     * Remove user account, that's also called close user's account.
     *
     * @deprecated since 3.2, use `UserProfileFacade.close()` from `@spartacus/user` package.
     */
    remove() {
        this.userIdService.invokeWithUserId((userId) => {
            this.store.dispatch(new UserActions.RemoveUser(userId));
        });
    }
    /**
     * Returns the remove user loading flag.
     *
     * @deprecated since 3.2, subscribe to `UserProfileFacade.close()` from `@spartacus/user` package
     * to get the loading state.
     */
    getRemoveUserResultLoading() {
        return this.store.pipe(select(getProcessLoadingFactory(REMOVE_USER_PROCESS_ID)));
    }
    /**
     * Returns the remove user failure outcome.
     *
     * @deprecated since 3.2, subscribe to `UserProfileFacade.close()` from `@spartacus/user` package
     * to get the error state.
     */
    getRemoveUserResultError() {
        return this.store.pipe(select(getProcessErrorFactory(REMOVE_USER_PROCESS_ID)));
    }
    /**
     * Returns the remove user process success outcome.
     *
     * @deprecated since 3.2, subscribe to `UserProfileFacade.close()` from `@spartacus/user` package
     * to get the success state.
     */
    getRemoveUserResultSuccess() {
        return this.store.pipe(select(getProcessSuccessFactory(REMOVE_USER_PROCESS_ID)));
    }
    /**
     * Resets the remove user process state. The state needs to be reset after the process
     * concludes, regardless if it's a success or an error
     *
     * @deprecated since 3.2, no longer needed when you use `UserProfileFacade.close()`
     * from `@spartacus/user` package.
     *
     */
    resetRemoveUserProcessState() {
        this.store.dispatch(new UserActions.RemoveUserReset());
    }
    /**
     * Returns titles.
     *
     * @deprecated since 3.2, use `UserProfileFacade.getTitles()` from `@spartacus/user` package.
     */
    getTitles() {
        if (this.userProfileFacade) {
            return this.userProfileFacade.getTitles();
        }
        return this.store.pipe(
        // workaround for using lazy loaded user/account library
        filter((state) => state[USER_FEATURE]), select(UsersSelectors.getAllTitles), tap((titles) => {
            if (Object.keys(titles).length === 0) {
                this.loadTitles();
            }
        }));
    }
    /**
     * Retrieves titles.
     *
     * @deprecated since 3.2, use `UserProfileFacade.getTitles()` from `@spartacus/user` package.
     */
    loadTitles() {
        this.store.dispatch(new UserActions.LoadTitles());
    }
    /**
     * Return whether user's password is successfully reset.
     *
     * @deprecated since 3.2, subscribe to `UserPasswordFacade.reset()` from `@spartacus/user` package
     * to get the success state.
     *
     */
    isPasswordReset() {
        return this.store.pipe(
        // workaround for using lazy loaded user/account library
        filter((state) => state[USER_FEATURE]), select(UsersSelectors.getResetPassword));
    }
    /**
     * Updates the user's details.
     *
     * @param userDetails to be updated
     *
     * @deprecated since 3.2, use `UserProfileFacade.update()` from `@spartacus/user` package.
     */
    updatePersonalDetails(userDetails) {
        this.userIdService.invokeWithUserId((userId) => {
            this.store.dispatch(new UserActions.UpdateUserDetails({
                username: userId,
                userDetails,
            }));
        });
    }
    /**
     * Returns the update user's personal details loading flag.
     *
     * @deprecated since 3.2, subscribe to `UserProfileFacade.update()` from `@spartacus/user` package
     * to get the loading state.
     */
    getUpdatePersonalDetailsResultLoading() {
        return this.store.pipe(select(getProcessLoadingFactory(UPDATE_USER_DETAILS_PROCESS_ID)));
    }
    /**
     * Returns the update user's personal details error flag.
     *
     * @deprecated since 3.2, subscribe to `UserProfileFacade.update()` from `@spartacus/user` package
     * to get the error state.
     */
    getUpdatePersonalDetailsResultError() {
        return this.store.pipe(select(getProcessErrorFactory(UPDATE_USER_DETAILS_PROCESS_ID)));
    }
    /**
     * Returns the update user's personal details success flag.
     *
     * @deprecated since 3.2, subscribe to `UserProfileFacade.update()` from `@spartacus/user` package
     * to get the success state.
     */
    getUpdatePersonalDetailsResultSuccess() {
        return this.store.pipe(select(getProcessSuccessFactory(UPDATE_USER_DETAILS_PROCESS_ID)));
    }
    /**
     * Resets the update user details processing state.
     *
     * @deprecated since 3.2, no longer needed when you use `UserProfileFacade.update()`
     * from `@spartacus/user` package.
     */
    resetUpdatePersonalDetailsProcessingState() {
        this.store.dispatch(new UserActions.ResetUpdateUserDetails());
    }
    /**
     * Reset new password.  Part of the forgot password flow.
     *
     * @param token
     * @param password
     *
     * @deprecated since 3.2, use `UserPasswordFacade.reset()` from `@spartacus/user` package.
     */
    resetPassword(token, password) {
        this.store.dispatch(new UserActions.ResetPassword({ token, password }));
    }
    /**
     * Request an email to reset a forgotten password.
     *
     * @deprecated since 3.2, use `UserPasswordFacade.requestForgotPasswordEmail()`
     * from `@spartacus/user` package.
     */
    requestForgotPasswordEmail(userEmailAddress) {
        this.store.dispatch(new UserActions.ForgotPasswordEmailRequest(userEmailAddress));
    }
    /**
     * Updates the user's email.
     *
     * @deprecated since 3.2, use `UserEmailFacade.update()` from `@spartacus/user` package.
     */
    updateEmail(password, newUid) {
        this.userIdService.invokeWithUserId((userId) => {
            this.store.dispatch(new UserActions.UpdateEmailAction({
                uid: userId,
                password,
                newUid,
            }));
        });
    }
    /**
     * Returns the update user's email success flag.
     *
     * @deprecated since 3.2, subscribe to `UserEmailFacade.update()` from `@spartacus/user` package
     * to get the success state.
     */
    getUpdateEmailResultSuccess() {
        return this.store.pipe(select(getProcessSuccessFactory(UPDATE_EMAIL_PROCESS_ID)));
    }
    /**
     * Returns the update user's email error flag.
     *
     * @deprecated since 3.2, subscribe to `UserEmailFacade.update()` from `@spartacus/user` package
     * to get the error state.
     */
    getUpdateEmailResultError() {
        return this.store.pipe(select(getProcessErrorFactory(UPDATE_EMAIL_PROCESS_ID)));
    }
    /**
     * Returns the update user's email loading flag.
     *
     * @deprecated since 3.2, subscribe to `UserEmailFacade.update()` from `@spartacus/user` package
     * to get the loading state.
     */
    getUpdateEmailResultLoading() {
        return this.store.pipe(select(getProcessLoadingFactory(UPDATE_EMAIL_PROCESS_ID)));
    }
    /**
     * Resets the update user's email processing state.
     *
     * @deprecated since 3.2, no longer needed when you use `UserEmailFacade.update()`
     * from `@spartacus/user` package.
     */
    resetUpdateEmailResultState() {
        this.store.dispatch(new UserActions.ResetUpdateEmailAction());
    }
    /**
     * Updates the password for the user.
     *
     * @param oldPassword the current password that will be changed
     * @param newPassword the new password
     *
     * @deprecated since 3.2, use `UserPasswordFacade.update()` from `@spartacus/user` package.
     */
    updatePassword(oldPassword, newPassword) {
        this.userIdService.invokeWithUserId((userId) => {
            this.store.dispatch(new UserActions.UpdatePassword({
                userId,
                oldPassword,
                newPassword,
            }));
        });
    }
    /**
     * Returns the update password loading flag.
     *
     * @deprecated since 3.2, subscribe to `UserPasswordFacade.update()` from `@spartacus/user` package
     * to get the loading state.
     */
    getUpdatePasswordResultLoading() {
        return this.store.pipe(select(getProcessLoadingFactory(UPDATE_PASSWORD_PROCESS_ID)));
    }
    /**
     * Returns the update password failure outcome.
     *
     * @deprecated since 3.2, subscribe to `UserPasswordFacade.update()` from `@spartacus/user` package
     * to get the error state.
     */
    getUpdatePasswordResultError() {
        return this.store.pipe(select(getProcessErrorFactory(UPDATE_PASSWORD_PROCESS_ID)));
    }
    /**
     * Returns the update password process success outcome.
     *
     * @deprecated since 3.2, subscribe to `UserPasswordFacade.update()` from `@spartacus/user` package
     * to get the success state.
     */
    getUpdatePasswordResultSuccess() {
        return this.store.pipe(select(getProcessSuccessFactory(UPDATE_PASSWORD_PROCESS_ID)));
    }
    /**
     * Resets the update password process state. The state needs to be reset after the process
     * concludes, regardless if it's a success or an error
     *
     * @deprecated since 3.2, no longer needed when you use `UserPasswordFacade.update()`
     * from `@spartacus/user` package.
     */
    resetUpdatePasswordProcessState() {
        this.store.dispatch(new UserActions.UpdatePasswordReset());
    }
}
UserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function UserService_Factory() { return new UserService(i0.ɵɵinject(i1.Store), i0.ɵɵinject(i2.UserIdService), i0.ɵɵinject(i3.UserAccountFacadeTransitionalToken, 8), i0.ɵɵinject(i3.UserProfileFacadeTransitionalToken, 8), i0.ɵɵinject(i3.UserRegisterFacadeTransitionalToken, 8)); }, token: UserService, providedIn: "root" });
UserService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
UserService.ctorParameters = () => [
    { type: Store },
    { type: UserIdService },
    { type: UserAccountFacadeTransitionalToken, decorators: [{ type: Optional }] },
    { type: UserProfileFacadeTransitionalToken, decorators: [{ type: Optional }] },
    { type: UserRegisterFacadeTransitionalToken, decorators: [{ type: Optional }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL1BhdHJ5ay9EZXNrdG9wL3NwYXJ0YWN1cy9wcm9qZWN0cy9jb3JlLyIsInNvdXJjZXMiOlsic3JjL3VzZXIvZmFjYWRlL3VzZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUU1QyxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQUU1RSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV0RSxPQUFPLEVBQ0wsc0JBQXNCLEVBQ3RCLHdCQUF3QixFQUN4Qix3QkFBd0IsR0FDekIsTUFBTSxpREFBaUQsQ0FBQztBQUN6RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDckQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzFELE9BQU8sRUFDTCx3QkFBd0IsRUFDeEIsc0JBQXNCLEVBRXRCLHVCQUF1QixFQUN2QiwwQkFBMEIsRUFDMUIsOEJBQThCLEVBQzlCLFlBQVksR0FDYixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFDTCxrQ0FBa0MsRUFDbEMsa0NBQWtDLEVBQ2xDLG1DQUFtQyxHQUNwQyxNQUFNLDZCQUE2QixDQUFDOzs7OztBQUdyQyxNQUFNLE9BQU8sV0FBVztJQUN0QixZQUNZLEtBQW9ELEVBQ3BELGFBQTRCO0lBQ3RDLHNEQUFzRDtJQUU1QyxpQkFBc0QsRUFFdEQsaUJBQXNELEVBRXRELGtCQUF3RDtRQVJ4RCxVQUFLLEdBQUwsS0FBSyxDQUErQztRQUNwRCxrQkFBYSxHQUFi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Ozs7O09BS0c7SUFDSCw4QkFBOEI7UUFDNUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FDcEIsTUFBTSxDQUFDLHdCQUF3QixDQUFDLDBCQUEwQixDQUFDLENBQUMsQ0FDN0QsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSCwrQkFBK0I7UUFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxXQUFXLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7Ozs7WUF2YkYsVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7O1lBN0JqQixLQUFLO1lBR2IsYUFBYTtZQXFCcEIsa0NBQWtDLHVCQVcvQixRQUFRO1lBVlgsa0NBQWtDLHVCQVkvQixRQUFRO1lBWFgsbUNBQW1DLHVCQWFoQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHNlbGVjdCwgU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFVzZXJJZFNlcnZpY2UgfSBmcm9tICcuLi8uLi9hdXRoL3VzZXItYXV0aC9mYWNhZGUvdXNlci1pZC5zZXJ2aWNlJztcbmltcG9ydCB7IFRpdGxlLCBVc2VyLCBVc2VyU2lnblVwIH0gZnJvbSAnLi4vLi4vbW9kZWwvbWlzYy5tb2RlbCc7XG5pbXBvcnQgeyBPQ0NfVVNFUl9JRF9BTk9OWU1PVVMgfSBmcm9tICcuLi8uLi9vY2MvdXRpbHMvb2NjLWNvbnN0YW50cyc7XG5pbXBvcnQgeyBTdGF0ZVdpdGhQcm9jZXNzIH0gZnJvbSAnLi4vLi4vcHJvY2Vzcy9zdG9yZS9wcm9jZXNzLXN0YXRlJztcbmltcG9ydCB7XG4gIGdldFByb2Nlc3NFcnJvckZhY3RvcnksXG4gIGdldFByb2Nlc3NMb2FkaW5nRmFjdG9yeSxcbiAgZ2V0UHJvY2Vzc1N1Y2Nlc3NGYWN0b3J5LFxufSBmcm9tICcuLi8uLi9wcm9jZXNzL3N0b3JlL3NlbGVjdG9ycy9wcm9jZXNzLnNlbGVjdG9ycyc7XG5pbXBvcnQgeyBVc2VyQWN0aW9ucyB9IGZyb20gJy4uL3N0b3JlL2FjdGlvbnMvaW5kZXgnO1xuaW1wb3J0IHsgVXNlcnNTZWxlY3RvcnMgfSBmcm9tICcuLi9zdG9yZS9zZWxlY3RvcnMvaW5kZXgnO1xuaW1wb3J0IHtcbiAgUkVHSVNURVJfVVNFUl9QUk9DRVNTX0lELFxuICBSRU1PVkVfVVNFUl9QUk9DRVNTX0lELFxuICBTdGF0ZVdpdGhVc2VyLFxuICBVUERBVEVfRU1BSUxfUFJPQ0VTU19JRCxcbiAgVVBEQVRFX1BBU1NXT1JEX1BST0NFU1NfSUQsXG4gIFVQREFURV9VU0VSX0RFVEFJTFNfUFJPQ0VTU19JRCxcbiAgVVNFUl9GRUFUVVJFLFxufSBmcm9tICcuLi9zdG9yZS91c2VyLXN0YXRlJztcbmltcG9ydCB7XG4gIFVzZXJBY2NvdW50RmFjYWRlVHJhbnNpdGlvbmFsVG9rZW4sXG4gIFVzZXJQcm9maWxlRmFjYWRlVHJhbnNpdGlvbmFsVG9rZW4sXG4gIFVzZXJSZWdpc3RlckZhY2FkZVRyYW5zaXRpb25hbFRva2VuLFxufSBmcm9tICcuLi91c2VyLXRyYW5zaXRpb25hbC10b2tlbnMnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIFVzZXJTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIHN0b3JlOiBTdG9yZTxTdGF0ZVdpdGhVc2VyIHwgU3RhdGVXaXRoUHJvY2Vzczx2b2lkPj4sXG4gICAgcHJvdGVjdGVkIHVzZXJJZFNlcnZpY2U6IFVzZXJJZFNlcnZpY2UsXG4gICAgLy8gVE9ETzogUmVtb3ZlIHRyYW5zaXRpb25hbCB0b2tlbnMgaW4gNC4wIHdpdGggIzExNjA3XG4gICAgQE9wdGlvbmFsKClcbiAgICBwcm90ZWN0ZWQgdXNlckFjY291bnRGYWNhZGU/OiBVc2VyQWNjb3VudEZhY2FkZVRyYW5zaXRpb25hbFRva2VuLFxuICAgIEBPcHRpb25hbCgpXG4gICAgcHJvdGVjdGVkIHVzZXJQcm9maWxlRmFjYWRlPzogVXNlclByb2ZpbGVGYWNhZGVUcmFuc2l0aW9uYWxUb2tlbixcbiAgICBAT3B0aW9uYWwoKVxuICAgIHByb3RlY3RlZCB1c2VyUmVnaXN0ZXJGYWNhZGU/OiBVc2VyUmVnaXN0ZXJGYWNhZGVUcmFuc2l0aW9uYWxUb2tlblxuICApIHt9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSB1c2VyLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHVzZSBgVXNlckFjY291bnRGYWNhZGUuZ2V0KClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZS5cbiAgICovXG4gIGdldCgpOiBPYnNlcnZhYmxlPFVzZXI+IHtcbiAgICBpZiAodGhpcy51c2VyQWNjb3VudEZhY2FkZSkge1xuICAgICAgcmV0dXJuIHRoaXMudXNlckFjY291bnRGYWNhZGUuZ2V0KCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICAvLyB3b3JrYXJvdW5kIGZvciB1c2luZyBsYXp5IGxvYWRlZCB1c2VyL2FjY291bnQgbGlicmFyeVxuICAgICAgZmlsdGVyKChzdGF0ZSkgPT4gc3RhdGVbVVNFUl9GRUFUVVJFXSksXG4gICAgICBzZWxlY3QoVXNlcnNTZWxlY3RvcnMuZ2V0RGV0YWlscyksXG4gICAgICB0YXAoKGRldGFpbHMpID0+IHtcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKGRldGFpbHMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMubG9hZCgpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogTG9hZHMgdGhlIHVzZXIncyBkZXRhaWxzLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHVzZSBgVXNlckFjY291bnRGYWNhZGUuZ2V0KClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZS5cbiAgICovXG4gIGxvYWQoKTogdm9pZCB7XG4gICAgdGhpcy51c2VySWRTZXJ2aWNlLmludm9rZVdpdGhVc2VySWQoKHVzZXJJZCkgPT4ge1xuICAgICAgaWYgKHVzZXJJZCAhPT0gT0NDX1VTRVJfSURfQU5PTllNT1VTKSB7XG4gICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gobmV3IFVzZXJBY3Rpb25zLkxvYWRVc2VyRGV0YWlscyh1c2VySWQpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIG5ldyB1c2VyLlxuICAgKlxuICAgKiBAcGFyYW0gc3VibWl0Rm9ybURhdGEgYXMgVXNlclJlZ2lzdGVyRm9ybURhdGFcbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCB1c2UgYFVzZXJSZWdpc3RlckZhY2FkZS5yZWdpc3RlcigpYCBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2UuXG4gICAqL1xuICByZWdpc3Rlcih1c2VyUmVnaXN0ZXJGb3JtRGF0YTogVXNlclNpZ25VcCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gobmV3IFVzZXJBY3Rpb25zLlJlZ2lzdGVyVXNlcih1c2VyUmVnaXN0ZXJGb3JtRGF0YSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGEgbmV3IHVzZXIgZnJvbSBndWVzdC5cbiAgICpcbiAgICogQHBhcmFtIGd1aWRcbiAgICogQHBhcmFtIHBhc3N3b3JkXG4gICAqL1xuICByZWdpc3Rlckd1ZXN0KGd1aWQ6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLnVzZXJSZWdpc3RlckZhY2FkZSkge1xuICAgICAgdGhpcy51c2VyUmVnaXN0ZXJGYWNhZGUucmVnaXN0ZXJHdWVzdChndWlkLCBwYXNzd29yZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2gobmV3IFVzZXJBY3Rpb25zLlJlZ2lzdGVyR3Vlc3QoeyBndWlkLCBwYXNzd29yZCB9KSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHJlZ2lzdGVyIHVzZXIgcHJvY2VzcyBsb2FkaW5nIGZsYWcuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgc3Vic2NyaWJlIHRvIGBVc2VyUmVnaXN0ZXJGYWNhZGUucmVnaXN0ZXIoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlXG4gICAqIHRvIGdldCB0aGUgbG9hZGluZyBzdGF0ZS5cbiAgICovXG4gIGdldFJlZ2lzdGVyVXNlclJlc3VsdExvYWRpbmcoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgIHNlbGVjdChnZXRQcm9jZXNzTG9hZGluZ0ZhY3RvcnkoUkVHSVNURVJfVVNFUl9QUk9DRVNTX0lEKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHJlZ2lzdGVyIHVzZXIgcHJvY2VzcyBzdWNjZXNzIGZsYWcuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgc3Vic2NyaWJlIHRvIGBVc2VyUmVnaXN0ZXJGYWNhZGUucmVnaXN0ZXIoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlXG4gICAqIHRvIGdldCB0aGUgc3VjY2VzcyBzdGF0ZS5cbiAgICovXG4gIGdldFJlZ2lzdGVyVXNlclJlc3VsdFN1Y2Nlc3MoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgIHNlbGVjdChnZXRQcm9jZXNzU3VjY2Vzc0ZhY3RvcnkoUkVHSVNURVJfVVNFUl9QUk9DRVNTX0lEKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHJlZ2lzdGVyIHVzZXIgcHJvY2VzcyBlcnJvciBmbGFnXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgc3Vic2NyaWJlIHRvIGBVc2VyUmVnaXN0ZXJGYWNhZGUucmVnaXN0ZXIoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlXG4gICAqIHRvIGdldCB0aGUgZXJyb3Igc3RhdGUuXG4gICAqL1xuICBnZXRSZWdpc3RlclVzZXJSZXN1bHRFcnJvcigpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5waXBlKFxuICAgICAgc2VsZWN0KGdldFByb2Nlc3NFcnJvckZhY3RvcnkoUkVHSVNURVJfVVNFUl9QUk9DRVNTX0lEKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0cyB0aGUgcmVnaXN0ZXIgdXNlciBwcm9jZXNzIGZsYWdzXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgbm8gbG9uZ2VyIG5lZWRlZCB3aGVuIHlvdSB1c2UgYFVzZXJSZWdpc3RlckZhY2FkZS5yZWdpc3RlcigpYFxuICAgKiBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2UuXG4gICAqL1xuICByZXNldFJlZ2lzdGVyVXNlclByb2Nlc3NTdGF0ZSgpOiB2b2lkIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5kaXNwYXRjaChuZXcgVXNlckFjdGlvbnMuUmVzZXRSZWdpc3RlclVzZXJQcm9jZXNzKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSB1c2VyIGFjY291bnQsIHRoYXQncyBhbHNvIGNhbGxlZCBjbG9zZSB1c2VyJ3MgYWNjb3VudC5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCB1c2UgYFVzZXJQcm9maWxlRmFjYWRlLmNsb3NlKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZS5cbiAgICovXG4gIHJlbW92ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UuaW52b2tlV2l0aFVzZXJJZCgodXNlcklkKSA9PiB7XG4gICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKG5ldyBVc2VyQWN0aW9ucy5SZW1vdmVVc2VyKHVzZXJJZCkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHJlbW92ZSB1c2VyIGxvYWRpbmcgZmxhZy5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBzdWJzY3JpYmUgdG8gYFVzZXJQcm9maWxlRmFjYWRlLmNsb3NlKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZVxuICAgKiB0byBnZXQgdGhlIGxvYWRpbmcgc3RhdGUuXG4gICAqL1xuICBnZXRSZW1vdmVVc2VyUmVzdWx0TG9hZGluZygpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5waXBlKFxuICAgICAgc2VsZWN0KGdldFByb2Nlc3NMb2FkaW5nRmFjdG9yeShSRU1PVkVfVVNFUl9QUk9DRVNTX0lEKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHJlbW92ZSB1c2VyIGZhaWx1cmUgb3V0Y29tZS5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBzdWJzY3JpYmUgdG8gYFVzZXJQcm9maWxlRmFjYWRlLmNsb3NlKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZVxuICAgKiB0byBnZXQgdGhlIGVycm9yIHN0YXRlLlxuICAgKi9cbiAgZ2V0UmVtb3ZlVXNlclJlc3VsdEVycm9yKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc0Vycm9yRmFjdG9yeShSRU1PVkVfVVNFUl9QUk9DRVNTX0lEKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHJlbW92ZSB1c2VyIHByb2Nlc3Mgc3VjY2VzcyBvdXRjb21lLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHN1YnNjcmliZSB0byBgVXNlclByb2ZpbGVGYWNhZGUuY2xvc2UoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlXG4gICAqIHRvIGdldCB0aGUgc3VjY2VzcyBzdGF0ZS5cbiAgICovXG4gIGdldFJlbW92ZVVzZXJSZXN1bHRTdWNjZXNzKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc1N1Y2Nlc3NGYWN0b3J5KFJFTU9WRV9VU0VSX1BST0NFU1NfSUQpKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRzIHRoZSByZW1vdmUgdXNlciBwcm9jZXNzIHN0YXRlLiBUaGUgc3RhdGUgbmVlZHMgdG8gYmUgcmVzZXQgYWZ0ZXIgdGhlIHByb2Nlc3NcbiAgICogY29uY2x1ZGVzLCByZWdhcmRsZXNzIGlmIGl0J3MgYSBzdWNjZXNzIG9yIGFuIGVycm9yXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgbm8gbG9uZ2VyIG5lZWRlZCB3aGVuIHlvdSB1c2UgYFVzZXJQcm9maWxlRmFjYWRlLmNsb3NlKClgXG4gICAqIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZS5cbiAgICpcbiAgICovXG4gIHJlc2V0UmVtb3ZlVXNlclByb2Nlc3NTdGF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKG5ldyBVc2VyQWN0aW9ucy5SZW1vdmVVc2VyUmVzZXQoKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aXRsZXMuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgdXNlIGBVc2VyUHJvZmlsZUZhY2FkZS5nZXRUaXRsZXMoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlLlxuICAgKi9cbiAgZ2V0VGl0bGVzKCk6IE9ic2VydmFibGU8VGl0bGVbXT4ge1xuICAgIGlmICh0aGlzLnVzZXJQcm9maWxlRmFjYWRlKSB7XG4gICAgICByZXR1cm4gdGhpcy51c2VyUHJvZmlsZUZhY2FkZS5nZXRUaXRsZXMoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgIC8vIHdvcmthcm91bmQgZm9yIHVzaW5nIGxhenkgbG9hZGVkIHVzZXIvYWNjb3VudCBsaWJyYXJ5XG4gICAgICBmaWx0ZXIoKHN0YXRlKSA9PiBzdGF0ZVtVU0VSX0ZFQVRVUkVdKSxcbiAgICAgIHNlbGVjdChVc2Vyc1NlbGVjdG9ycy5nZXRBbGxUaXRsZXMpLFxuICAgICAgdGFwKCh0aXRsZXM6IFRpdGxlW10pID0+IHtcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKHRpdGxlcykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5sb2FkVGl0bGVzKCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgdGl0bGVzLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHVzZSBgVXNlclByb2ZpbGVGYWNhZGUuZ2V0VGl0bGVzKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZS5cbiAgICovXG4gIGxvYWRUaXRsZXMoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9yZS5kaXNwYXRjaChuZXcgVXNlckFjdGlvbnMuTG9hZFRpdGxlcygpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gd2hldGhlciB1c2VyJ3MgcGFzc3dvcmQgaXMgc3VjY2Vzc2Z1bGx5IHJlc2V0LlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHN1YnNjcmliZSB0byBgVXNlclBhc3N3b3JkRmFjYWRlLnJlc2V0KClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZVxuICAgKiB0byBnZXQgdGhlIHN1Y2Nlc3Mgc3RhdGUuXG4gICAqXG4gICAqL1xuICBpc1Bhc3N3b3JkUmVzZXQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgIC8vIHdvcmthcm91bmQgZm9yIHVzaW5nIGxhenkgbG9hZGVkIHVzZXIvYWNjb3VudCBsaWJyYXJ5XG4gICAgICBmaWx0ZXIoKHN0YXRlKSA9PiBzdGF0ZVtVU0VSX0ZFQVRVUkVdKSxcbiAgICAgIHNlbGVjdChVc2Vyc1NlbGVjdG9ycy5nZXRSZXNldFBhc3N3b3JkKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgdXNlcidzIGRldGFpbHMuXG4gICAqXG4gICAqIEBwYXJhbSB1c2VyRGV0YWlscyB0byBiZSB1cGRhdGVkXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgdXNlIGBVc2VyUHJvZmlsZUZhY2FkZS51cGRhdGUoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlLlxuICAgKi9cbiAgdXBkYXRlUGVyc29uYWxEZXRhaWxzKHVzZXJEZXRhaWxzOiBVc2VyKTogdm9pZCB7XG4gICAgdGhpcy51c2VySWRTZXJ2aWNlLmludm9rZVdpdGhVc2VySWQoKHVzZXJJZCkgPT4ge1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgbmV3IFVzZXJBY3Rpb25zLlVwZGF0ZVVzZXJEZXRhaWxzKHtcbiAgICAgICAgICB1c2VybmFtZTogdXNlcklkLFxuICAgICAgICAgIHVzZXJEZXRhaWxzLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB1cGRhdGUgdXNlcidzIHBlcnNvbmFsIGRldGFpbHMgbG9hZGluZyBmbGFnLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHN1YnNjcmliZSB0byBgVXNlclByb2ZpbGVGYWNhZGUudXBkYXRlKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZVxuICAgKiB0byBnZXQgdGhlIGxvYWRpbmcgc3RhdGUuXG4gICAqL1xuICBnZXRVcGRhdGVQZXJzb25hbERldGFpbHNSZXN1bHRMb2FkaW5nKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc0xvYWRpbmdGYWN0b3J5KFVQREFURV9VU0VSX0RFVEFJTFNfUFJPQ0VTU19JRCkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB1cGRhdGUgdXNlcidzIHBlcnNvbmFsIGRldGFpbHMgZXJyb3IgZmxhZy5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBzdWJzY3JpYmUgdG8gYFVzZXJQcm9maWxlRmFjYWRlLnVwZGF0ZSgpYCBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2VcbiAgICogdG8gZ2V0IHRoZSBlcnJvciBzdGF0ZS5cbiAgICovXG4gIGdldFVwZGF0ZVBlcnNvbmFsRGV0YWlsc1Jlc3VsdEVycm9yKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc0Vycm9yRmFjdG9yeShVUERBVEVfVVNFUl9ERVRBSUxTX1BST0NFU1NfSUQpKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdXBkYXRlIHVzZXIncyBwZXJzb25hbCBkZXRhaWxzIHN1Y2Nlc3MgZmxhZy5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBzdWJzY3JpYmUgdG8gYFVzZXJQcm9maWxlRmFjYWRlLnVwZGF0ZSgpYCBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2VcbiAgICogdG8gZ2V0IHRoZSBzdWNjZXNzIHN0YXRlLlxuICAgKi9cbiAgZ2V0VXBkYXRlUGVyc29uYWxEZXRhaWxzUmVzdWx0U3VjY2VzcygpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5waXBlKFxuICAgICAgc2VsZWN0KGdldFByb2Nlc3NTdWNjZXNzRmFjdG9yeShVUERBVEVfVVNFUl9ERVRBSUxTX1BST0NFU1NfSUQpKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRzIHRoZSB1cGRhdGUgdXNlciBkZXRhaWxzIHByb2Nlc3Npbmcgc3RhdGUuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgbm8gbG9uZ2VyIG5lZWRlZCB3aGVuIHlvdSB1c2UgYFVzZXJQcm9maWxlRmFjYWRlLnVwZGF0ZSgpYFxuICAgKiBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2UuXG4gICAqL1xuICByZXNldFVwZGF0ZVBlcnNvbmFsRGV0YWlsc1Byb2Nlc3NpbmdTdGF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKG5ldyBVc2VyQWN0aW9ucy5SZXNldFVwZGF0ZVVzZXJEZXRhaWxzKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IG5ldyBwYXNzd29yZC4gIFBhcnQgb2YgdGhlIGZvcmdvdCBwYXNzd29yZCBmbG93LlxuICAgKlxuICAgKiBAcGFyYW0gdG9rZW5cbiAgICogQHBhcmFtIHBhc3N3b3JkXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgdXNlIGBVc2VyUGFzc3dvcmRGYWNhZGUucmVzZXQoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlLlxuICAgKi9cbiAgcmVzZXRQYXNzd29yZCh0b2tlbjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5zdG9yZS5kaXNwYXRjaChuZXcgVXNlckFjdGlvbnMuUmVzZXRQYXNzd29yZCh7IHRva2VuLCBwYXNzd29yZCB9KSk7XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdCBhbiBlbWFpbCB0byByZXNldCBhIGZvcmdvdHRlbiBwYXNzd29yZC5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCB1c2UgYFVzZXJQYXNzd29yZEZhY2FkZS5yZXF1ZXN0Rm9yZ290UGFzc3dvcmRFbWFpbCgpYFxuICAgKiBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2UuXG4gICAqL1xuICByZXF1ZXN0Rm9yZ290UGFzc3dvcmRFbWFpbCh1c2VyRW1haWxBZGRyZXNzOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgbmV3IFVzZXJBY3Rpb25zLkZvcmdvdFBhc3N3b3JkRW1haWxSZXF1ZXN0KHVzZXJFbWFpbEFkZHJlc3MpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSB1c2VyJ3MgZW1haWwuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgdXNlIGBVc2VyRW1haWxGYWNhZGUudXBkYXRlKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZS5cbiAgICovXG4gIHVwZGF0ZUVtYWlsKHBhc3N3b3JkOiBzdHJpbmcsIG5ld1VpZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy51c2VySWRTZXJ2aWNlLmludm9rZVdpdGhVc2VySWQoKHVzZXJJZCkgPT4ge1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgbmV3IFVzZXJBY3Rpb25zLlVwZGF0ZUVtYWlsQWN0aW9uKHtcbiAgICAgICAgICB1aWQ6IHVzZXJJZCxcbiAgICAgICAgICBwYXNzd29yZCxcbiAgICAgICAgICBuZXdVaWQsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHVwZGF0ZSB1c2VyJ3MgZW1haWwgc3VjY2VzcyBmbGFnLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHN1YnNjcmliZSB0byBgVXNlckVtYWlsRmFjYWRlLnVwZGF0ZSgpYCBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2VcbiAgICogdG8gZ2V0IHRoZSBzdWNjZXNzIHN0YXRlLlxuICAgKi9cbiAgZ2V0VXBkYXRlRW1haWxSZXN1bHRTdWNjZXNzKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc1N1Y2Nlc3NGYWN0b3J5KFVQREFURV9FTUFJTF9QUk9DRVNTX0lEKSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHVwZGF0ZSB1c2VyJ3MgZW1haWwgZXJyb3IgZmxhZy5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBzdWJzY3JpYmUgdG8gYFVzZXJFbWFpbEZhY2FkZS51cGRhdGUoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlXG4gICAqIHRvIGdldCB0aGUgZXJyb3Igc3RhdGUuXG4gICAqL1xuICBnZXRVcGRhdGVFbWFpbFJlc3VsdEVycm9yKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc0Vycm9yRmFjdG9yeShVUERBVEVfRU1BSUxfUFJPQ0VTU19JRCkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB1cGRhdGUgdXNlcidzIGVtYWlsIGxvYWRpbmcgZmxhZy5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBzdWJzY3JpYmUgdG8gYFVzZXJFbWFpbEZhY2FkZS51cGRhdGUoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlXG4gICAqIHRvIGdldCB0aGUgbG9hZGluZyBzdGF0ZS5cbiAgICovXG4gIGdldFVwZGF0ZUVtYWlsUmVzdWx0TG9hZGluZygpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5waXBlKFxuICAgICAgc2VsZWN0KGdldFByb2Nlc3NMb2FkaW5nRmFjdG9yeShVUERBVEVfRU1BSUxfUFJPQ0VTU19JRCkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldHMgdGhlIHVwZGF0ZSB1c2VyJ3MgZW1haWwgcHJvY2Vzc2luZyBzdGF0ZS5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBubyBsb25nZXIgbmVlZGVkIHdoZW4geW91IHVzZSBgVXNlckVtYWlsRmFjYWRlLnVwZGF0ZSgpYFxuICAgKiBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2UuXG4gICAqL1xuICByZXNldFVwZGF0ZUVtYWlsUmVzdWx0U3RhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9yZS5kaXNwYXRjaChuZXcgVXNlckFjdGlvbnMuUmVzZXRVcGRhdGVFbWFpbEFjdGlvbigpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSBwYXNzd29yZCBmb3IgdGhlIHVzZXIuXG4gICAqXG4gICAqIEBwYXJhbSBvbGRQYXNzd29yZCB0aGUgY3VycmVudCBwYXNzd29yZCB0aGF0IHdpbGwgYmUgY2hhbmdlZFxuICAgKiBAcGFyYW0gbmV3UGFzc3dvcmQgdGhlIG5ldyBwYXNzd29yZFxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIHVzZSBgVXNlclBhc3N3b3JkRmFjYWRlLnVwZGF0ZSgpYCBmcm9tIGBAc3BhcnRhY3VzL3VzZXJgIHBhY2thZ2UuXG4gICAqL1xuICB1cGRhdGVQYXNzd29yZChvbGRQYXNzd29yZDogc3RyaW5nLCBuZXdQYXNzd29yZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy51c2VySWRTZXJ2aWNlLmludm9rZVdpdGhVc2VySWQoKHVzZXJJZCkgPT4ge1xuICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgbmV3IFVzZXJBY3Rpb25zLlVwZGF0ZVBhc3N3b3JkKHtcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgb2xkUGFzc3dvcmQsXG4gICAgICAgICAgbmV3UGFzc3dvcmQsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHVwZGF0ZSBwYXNzd29yZCBsb2FkaW5nIGZsYWcuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgc3Vic2NyaWJlIHRvIGBVc2VyUGFzc3dvcmRGYWNhZGUudXBkYXRlKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZVxuICAgKiB0byBnZXQgdGhlIGxvYWRpbmcgc3RhdGUuXG4gICAqL1xuICBnZXRVcGRhdGVQYXNzd29yZFJlc3VsdExvYWRpbmcoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgIHNlbGVjdChnZXRQcm9jZXNzTG9hZGluZ0ZhY3RvcnkoVVBEQVRFX1BBU1NXT1JEX1BST0NFU1NfSUQpKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdXBkYXRlIHBhc3N3b3JkIGZhaWx1cmUgb3V0Y29tZS5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCBzdWJzY3JpYmUgdG8gYFVzZXJQYXNzd29yZEZhY2FkZS51cGRhdGUoKWAgZnJvbSBgQHNwYXJ0YWN1cy91c2VyYCBwYWNrYWdlXG4gICAqIHRvIGdldCB0aGUgZXJyb3Igc3RhdGUuXG4gICAqL1xuICBnZXRVcGRhdGVQYXNzd29yZFJlc3VsdEVycm9yKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICBzZWxlY3QoZ2V0UHJvY2Vzc0Vycm9yRmFjdG9yeShVUERBVEVfUEFTU1dPUkRfUFJPQ0VTU19JRCkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSB1cGRhdGUgcGFzc3dvcmQgcHJvY2VzcyBzdWNjZXNzIG91dGNvbWUuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMiwgc3Vic2NyaWJlIHRvIGBVc2VyUGFzc3dvcmRGYWNhZGUudXBkYXRlKClgIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZVxuICAgKiB0byBnZXQgdGhlIHN1Y2Nlc3Mgc3RhdGUuXG4gICAqL1xuICBnZXRVcGRhdGVQYXNzd29yZFJlc3VsdFN1Y2Nlc3MoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgIHNlbGVjdChnZXRQcm9jZXNzU3VjY2Vzc0ZhY3RvcnkoVVBEQVRFX1BBU1NXT1JEX1BST0NFU1NfSUQpKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRzIHRoZSB1cGRhdGUgcGFzc3dvcmQgcHJvY2VzcyBzdGF0ZS4gVGhlIHN0YXRlIG5lZWRzIHRvIGJlIHJlc2V0IGFmdGVyIHRoZSBwcm9jZXNzXG4gICAqIGNvbmNsdWRlcywgcmVnYXJkbGVzcyBpZiBpdCdzIGEgc3VjY2VzcyBvciBhbiBlcnJvclxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAzLjIsIG5vIGxvbmdlciBuZWVkZWQgd2hlbiB5b3UgdXNlIGBVc2VyUGFzc3dvcmRGYWNhZGUudXBkYXRlKClgXG4gICAqIGZyb20gYEBzcGFydGFjdXMvdXNlcmAgcGFja2FnZS5cbiAgICovXG4gIHJlc2V0VXBkYXRlUGFzc3dvcmRQcm9jZXNzU3RhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5zdG9yZS5kaXNwYXRjaChuZXcgVXNlckFjdGlvbnMuVXBkYXRlUGFzc3dvcmRSZXNldCgpKTtcbiAgfVxufVxuIl19