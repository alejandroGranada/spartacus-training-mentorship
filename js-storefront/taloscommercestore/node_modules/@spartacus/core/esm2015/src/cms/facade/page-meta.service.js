import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, isDevMode, PLATFORM_ID } from '@angular/core';
import { defer, of } from 'rxjs';
import { filter, map, shareReplay, switchMap } from 'rxjs/operators';
import { UnifiedInjector } from '../../lazy-loading/unified-injector';
import { resolveApplicable } from '../../util/applicable';
import { uniteLatest } from '../../util/rxjs/unite-latest';
import { PageMetaConfig } from '../page/config/page-meta.config';
import { PageMetaResolver } from '../page/page-meta.resolver';
import { CmsService } from './cms.service';
import * as i0 from "@angular/core";
import * as i1 from "./cms.service";
import * as i2 from "../../lazy-loading/unified-injector";
import * as i3 from "../page/config/page-meta.config";
/**
 * Service that collects the page meta data by using injected page resolvers.
 *
 * Deprecation note: with version 4.0, we'll make the optional constructor arguments mandatory.
 */
// TODO(#10467): Remove and deprecated note.
export class PageMetaService {
    // TODO(#10467): Drop optional constructor arguments.
    constructor(cms, unifiedInjector, pageMetaConfig, platformId) {
        this.cms = cms;
        this.unifiedInjector = unifiedInjector;
        this.pageMetaConfig = pageMetaConfig;
        this.platformId = platformId;
        this.resolvers$ = this.unifiedInjector
            ? this.unifiedInjector
                .getMulti(PageMetaResolver)
                .pipe(shareReplay({ bufferSize: 1, refCount: true }))
            : of();
        /**
         * The list of resolver interfaces will be evaluated for the pageResolvers.
         *
         * @deprecated since 3.1, use the configured resolvers instead from `PageMetaConfig.resolvers`.
         */
        // TODO(#10467): Remove and migrate property
        this.resolverMethods = {
            title: 'resolveTitle',
            heading: 'resolveHeading',
            description: 'resolveDescription',
            breadcrumbs: 'resolveBreadcrumbs',
            image: 'resolveImage',
            robots: 'resolveRobots',
        };
        this.meta$ = defer(() => this.cms.getCurrentPage()).pipe(filter((page) => Boolean(page)), switchMap((page) => this.getMetaResolver(page)), switchMap((metaResolver) => metaResolver ? this.resolve(metaResolver) : of(null)), shareReplay({ bufferSize: 1, refCount: true }));
    }
    /**
     * Returns the observed page meta data for the current page.
     *
     * The data is resolved by various PageResolvers, which are configurable.
     */
    getMeta() {
        return this.meta$;
    }
    /**
     * If a `PageResolver` has implemented a resolver interface, the resolved data
     * is merged into the `PageMeta` object.
     * @param metaResolver
     */
    resolve(metaResolver) {
        const resolverMethods = this.getResolverMethods();
        const resolvedData = Object.keys(resolverMethods)
            .filter((key) => metaResolver[resolverMethods[key]])
            .map((key) => {
            return metaResolver[resolverMethods[key]]().pipe(map((data) => ({ [key]: data })));
        });
        return uniteLatest(resolvedData).pipe(map((data) => Object.assign({}, ...data)));
    }
    /**
     * Returns an object with resolvers. The object properties represent the `PageMeta` property, i.e.:
     *
     * ```
     * {
     *   title: 'resolveTitle',
     *   robots: 'resolveRobots'
     * }
     * ```
     *
     * This list of resolvers is filtered for CSR vs SSR processing since not all resolvers are
     * relevant during browsing.
     */
    getResolverMethods() {
        var _a, _b;
        let resolverMethods = {};
        const configured = (_b = (_a = this.pageMetaConfig) === null || _a === void 0 ? void 0 : _a.pageMeta) === null || _b === void 0 ? void 0 : _b.resolvers;
        if (configured) {
            configured
                // filter the resolvers to avoid unnecessary processing in CSR
                .filter((resolver) => {
                var _a, _b, _c;
                return (
                // always resolve in SSR
                !isPlatformBrowser((_a = this.platformId) !== null && _a !== void 0 ? _a : '') ||
                    // resolve in CSR when it's not disabled
                    !resolver.disabledInCsr ||
                    // resolve in CSR when resolver is enabled in devMode
                    (isDevMode() && ((_c = (_b = this.pageMetaConfig) === null || _b === void 0 ? void 0 : _b.pageMeta) === null || _c === void 0 ? void 0 : _c.enableInDevMode)));
            })
                .forEach((resolver) => (resolverMethods[resolver.property] = resolver.method));
        }
        else {
            resolverMethods = this.resolverMethods;
        }
        return resolverMethods;
    }
    /**
     * Return the resolver with the best match, based on a score
     * generated by the resolver.
     *
     * Resolvers match by default on `PageType` and `page.template`.
     */
    getMetaResolver(page) {
        return this.resolvers$.pipe(map((resolvers) => resolveApplicable(resolvers, [page], [page])));
    }
}
PageMetaService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PageMetaService_Factory() { return new PageMetaService(i0.ɵɵinject(i1.CmsService), i0.ɵɵinject(i2.UnifiedInjector), i0.ɵɵinject(i3.PageMetaConfig), i0.ɵɵinject(i0.PLATFORM_ID)); }, token: PageMetaService, providedIn: "root" });
PageMetaService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
PageMetaService.ctorParameters = () => [
    { type: CmsService },
    { type: UnifiedInjector },
    { type: PageMetaConfig },
    { type: String, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS1tZXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvUGF0cnlrL0Rlc2t0b3Avc3BhcnRhY3VzL3Byb2plY3RzL2NvcmUvIiwic291cmNlcyI6WyJzcmMvY21zL2ZhY2FkZS9wYWdlLW1ldGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxLQUFLLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDdEUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRTNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNqRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7OztBQUUzQzs7OztHQUlHO0FBQ0gsNENBQTRDO0FBSTVDLE1BQU0sT0FBTyxlQUFlO0lBUzFCLHFEQUFxRDtJQUNyRCxZQUNZLEdBQWUsRUFDZixlQUFpQyxFQUNqQyxjQUErQixFQUNWLFVBQW1CO1FBSHhDLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDZixvQkFBZSxHQUFmLGVBQWUsQ0FBa0I7UUFDakMsbUJBQWMsR0FBZCxjQUFjLENBQWlCO1FBQ1YsZUFBVSxHQUFWLFVBQVUsQ0FBUztR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LENBQUMsUUFBUSxDQUFDLGFBQWE7b0JBQ3ZCLHFEQUFxRDtvQkFDckQsQ0FBQyxTQUFTLEVBQUUsaUJBQUksSUFBSSxDQUFDLGNBQWMsMENBQUUsUUFBUSwwQ0FBRSxlQUFlLENBQUEsQ0FBQyxDQUNoRSxDQUFDO1lBQ0osQ0FBQyxDQUFDO2lCQUNELE9BQU8sQ0FDTixDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FDckUsQ0FBQztTQUNMO2FBQU07WUFDTCxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztTQUN4QztRQUNELE9BQU8sZUFBZSxDQUFDO0lBQ3pCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLGVBQWUsQ0FDdkIsSUFBVTtRQUVWLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQ3pCLEdBQUcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQ2pFLENBQUM7SUFDSixDQUFDOzs7O1lBN0hGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBVlEsVUFBVTtZQU5WLGVBQWU7WUFJZixjQUFjO3lDQTJCbEIsTUFBTSxTQUFDLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIGlzRGV2TW9kZSwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGRlZmVyLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBVbmlmaWVkSW5qZWN0b3IgfSBmcm9tICcuLi8uLi9sYXp5LWxvYWRpbmcvdW5pZmllZC1pbmplY3Rvcic7XG5pbXBvcnQgeyByZXNvbHZlQXBwbGljYWJsZSB9IGZyb20gJy4uLy4uL3V0aWwvYXBwbGljYWJsZSc7XG5pbXBvcnQgeyB1bml0ZUxhdGVzdCB9IGZyb20gJy4uLy4uL3V0aWwvcnhqcy91bml0ZS1sYXRlc3QnO1xuaW1wb3J0IHsgUGFnZSwgUGFnZU1ldGEgfSBmcm9tICcuLi9tb2RlbC9wYWdlLm1vZGVsJztcbmltcG9ydCB7IFBhZ2VNZXRhQ29uZmlnIH0gZnJvbSAnLi4vcGFnZS9jb25maWcvcGFnZS1tZXRhLmNvbmZpZyc7XG5pbXBvcnQgeyBQYWdlTWV0YVJlc29sdmVyIH0gZnJvbSAnLi4vcGFnZS9wYWdlLW1ldGEucmVzb2x2ZXInO1xuaW1wb3J0IHsgQ21zU2VydmljZSB9IGZyb20gJy4vY21zLnNlcnZpY2UnO1xuXG4vKipcbiAqIFNlcnZpY2UgdGhhdCBjb2xsZWN0cyB0aGUgcGFnZSBtZXRhIGRhdGEgYnkgdXNpbmcgaW5qZWN0ZWQgcGFnZSByZXNvbHZlcnMuXG4gKlxuICogRGVwcmVjYXRpb24gbm90ZTogd2l0aCB2ZXJzaW9uIDQuMCwgd2UnbGwgbWFrZSB0aGUgb3B0aW9uYWwgY29uc3RydWN0b3IgYXJndW1lbnRzIG1hbmRhdG9yeS5cbiAqL1xuLy8gVE9ETygjMTA0NjcpOiBSZW1vdmUgYW5kIGRlcHJlY2F0ZWQgbm90ZS5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBQYWdlTWV0YVNlcnZpY2Uge1xuICBwcml2YXRlIHJlc29sdmVycyQ6IE9ic2VydmFibGU8UGFnZU1ldGFSZXNvbHZlcltdPiA9IHRoaXMudW5pZmllZEluamVjdG9yXG4gICAgPyAodGhpcy51bmlmaWVkSW5qZWN0b3JcbiAgICAgICAgLmdldE11bHRpKFBhZ2VNZXRhUmVzb2x2ZXIpXG4gICAgICAgIC5waXBlKHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWUgfSkpIGFzIE9ic2VydmFibGU8XG4gICAgICAgIFBhZ2VNZXRhUmVzb2x2ZXJbXVxuICAgICAgPilcbiAgICA6IG9mKCk7XG5cbiAgLy8gVE9ETygjMTA0NjcpOiBEcm9wIG9wdGlvbmFsIGNvbnN0cnVjdG9yIGFyZ3VtZW50cy5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGNtczogQ21zU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgdW5pZmllZEluamVjdG9yPzogVW5pZmllZEluamVjdG9yLFxuICAgIHByb3RlY3RlZCBwYWdlTWV0YUNvbmZpZz86IFBhZ2VNZXRhQ29uZmlnLFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByb3RlY3RlZCBwbGF0Zm9ybUlkPzogc3RyaW5nXG4gICkge31cblxuICAvKipcbiAgICogVGhlIGxpc3Qgb2YgcmVzb2x2ZXIgaW50ZXJmYWNlcyB3aWxsIGJlIGV2YWx1YXRlZCBmb3IgdGhlIHBhZ2VSZXNvbHZlcnMuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDMuMSwgdXNlIHRoZSBjb25maWd1cmVkIHJlc29sdmVycyBpbnN0ZWFkIGZyb20gYFBhZ2VNZXRhQ29uZmlnLnJlc29sdmVyc2AuXG4gICAqL1xuICAvLyBUT0RPKCMxMDQ2Nyk6IFJlbW92ZSBhbmQgbWlncmF0ZSBwcm9wZXJ0eVxuICBwcm90ZWN0ZWQgcmVzb2x2ZXJNZXRob2RzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge1xuICAgIHRpdGxlOiAncmVzb2x2ZVRpdGxlJyxcbiAgICBoZWFkaW5nOiAncmVzb2x2ZUhlYWRpbmcnLFxuICAgIGRlc2NyaXB0aW9uOiAncmVzb2x2ZURlc2NyaXB0aW9uJyxcbiAgICBicmVhZGNydW1iczogJ3Jlc29sdmVCcmVhZGNydW1icycsXG4gICAgaW1hZ2U6ICdyZXNvbHZlSW1hZ2UnLFxuICAgIHJvYm90czogJ3Jlc29sdmVSb2JvdHMnLFxuICB9O1xuXG4gIHByb3RlY3RlZCBtZXRhJDogT2JzZXJ2YWJsZTxQYWdlTWV0YSB8IG51bGw+ID0gZGVmZXIoKCkgPT5cbiAgICB0aGlzLmNtcy5nZXRDdXJyZW50UGFnZSgpXG4gICkucGlwZShcbiAgICBmaWx0ZXIoKHBhZ2UpID0+IEJvb2xlYW4ocGFnZSkpLFxuICAgIHN3aXRjaE1hcCgocGFnZTogUGFnZSkgPT4gdGhpcy5nZXRNZXRhUmVzb2x2ZXIocGFnZSkpLFxuICAgIHN3aXRjaE1hcCgobWV0YVJlc29sdmVyOiBQYWdlTWV0YVJlc29sdmVyKSA9PlxuICAgICAgbWV0YVJlc29sdmVyID8gdGhpcy5yZXNvbHZlKG1ldGFSZXNvbHZlcikgOiBvZihudWxsKVxuICAgICksXG4gICAgc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogdHJ1ZSB9KVxuICApO1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBvYnNlcnZlZCBwYWdlIG1ldGEgZGF0YSBmb3IgdGhlIGN1cnJlbnQgcGFnZS5cbiAgICpcbiAgICogVGhlIGRhdGEgaXMgcmVzb2x2ZWQgYnkgdmFyaW91cyBQYWdlUmVzb2x2ZXJzLCB3aGljaCBhcmUgY29uZmlndXJhYmxlLlxuICAgKi9cbiAgZ2V0TWV0YSgpOiBPYnNlcnZhYmxlPFBhZ2VNZXRhIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLm1ldGEkO1xuICB9XG5cbiAgLyoqXG4gICAqIElmIGEgYFBhZ2VSZXNvbHZlcmAgaGFzIGltcGxlbWVudGVkIGEgcmVzb2x2ZXIgaW50ZXJmYWNlLCB0aGUgcmVzb2x2ZWQgZGF0YVxuICAgKiBpcyBtZXJnZWQgaW50byB0aGUgYFBhZ2VNZXRhYCBvYmplY3QuXG4gICAqIEBwYXJhbSBtZXRhUmVzb2x2ZXJcbiAgICovXG4gIHByb3RlY3RlZCByZXNvbHZlKG1ldGFSZXNvbHZlcjogUGFnZU1ldGFSZXNvbHZlcik6IE9ic2VydmFibGU8UGFnZU1ldGE+IHtcbiAgICBjb25zdCByZXNvbHZlck1ldGhvZHMgPSB0aGlzLmdldFJlc29sdmVyTWV0aG9kcygpO1xuICAgIGNvbnN0IHJlc29sdmVkRGF0YTogT2JzZXJ2YWJsZTxQYWdlTWV0YT5bXSA9IE9iamVjdC5rZXlzKHJlc29sdmVyTWV0aG9kcylcbiAgICAgIC5maWx0ZXIoKGtleSkgPT4gbWV0YVJlc29sdmVyW3Jlc29sdmVyTWV0aG9kc1trZXldXSlcbiAgICAgIC5tYXAoKGtleSkgPT4ge1xuICAgICAgICByZXR1cm4gbWV0YVJlc29sdmVyW3Jlc29sdmVyTWV0aG9kc1trZXldXSgpLnBpcGUoXG4gICAgICAgICAgbWFwKChkYXRhKSA9PiAoeyBba2V5XTogZGF0YSB9KSlcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgcmV0dXJuIHVuaXRlTGF0ZXN0KHJlc29sdmVkRGF0YSkucGlwZShcbiAgICAgIG1hcCgoZGF0YSkgPT4gT2JqZWN0LmFzc2lnbih7fSwgLi4uZGF0YSkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIG9iamVjdCB3aXRoIHJlc29sdmVycy4gVGhlIG9iamVjdCBwcm9wZXJ0aWVzIHJlcHJlc2VudCB0aGUgYFBhZ2VNZXRhYCBwcm9wZXJ0eSwgaS5lLjpcbiAgICpcbiAgICogYGBgXG4gICAqIHtcbiAgICogICB0aXRsZTogJ3Jlc29sdmVUaXRsZScsXG4gICAqICAgcm9ib3RzOiAncmVzb2x2ZVJvYm90cydcbiAgICogfVxuICAgKiBgYGBcbiAgICpcbiAgICogVGhpcyBsaXN0IG9mIHJlc29sdmVycyBpcyBmaWx0ZXJlZCBmb3IgQ1NSIHZzIFNTUiBwcm9jZXNzaW5nIHNpbmNlIG5vdCBhbGwgcmVzb2x2ZXJzIGFyZVxuICAgKiByZWxldmFudCBkdXJpbmcgYnJvd3NpbmcuXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0UmVzb2x2ZXJNZXRob2RzKCk6IHsgW3Byb3BlcnR5OiBzdHJpbmddOiBzdHJpbmcgfSB7XG4gICAgbGV0IHJlc29sdmVyTWV0aG9kcyA9IHt9O1xuICAgIGNvbnN0IGNvbmZpZ3VyZWQgPSB0aGlzLnBhZ2VNZXRhQ29uZmlnPy5wYWdlTWV0YT8ucmVzb2x2ZXJzO1xuICAgIGlmIChjb25maWd1cmVkKSB7XG4gICAgICBjb25maWd1cmVkXG4gICAgICAgIC8vIGZpbHRlciB0aGUgcmVzb2x2ZXJzIHRvIGF2b2lkIHVubmVjZXNzYXJ5IHByb2Nlc3NpbmcgaW4gQ1NSXG4gICAgICAgIC5maWx0ZXIoKHJlc29sdmVyKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIC8vIGFsd2F5cyByZXNvbHZlIGluIFNTUlxuICAgICAgICAgICAgIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCA/PyAnJykgfHxcbiAgICAgICAgICAgIC8vIHJlc29sdmUgaW4gQ1NSIHdoZW4gaXQncyBub3QgZGlzYWJsZWRcbiAgICAgICAgICAgICFyZXNvbHZlci5kaXNhYmxlZEluQ3NyIHx8XG4gICAgICAgICAgICAvLyByZXNvbHZlIGluIENTUiB3aGVuIHJlc29sdmVyIGlzIGVuYWJsZWQgaW4gZGV2TW9kZVxuICAgICAgICAgICAgKGlzRGV2TW9kZSgpICYmIHRoaXMucGFnZU1ldGFDb25maWc/LnBhZ2VNZXRhPy5lbmFibGVJbkRldk1vZGUpXG4gICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmZvckVhY2goXG4gICAgICAgICAgKHJlc29sdmVyKSA9PiAocmVzb2x2ZXJNZXRob2RzW3Jlc29sdmVyLnByb3BlcnR5XSA9IHJlc29sdmVyLm1ldGhvZClcbiAgICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzb2x2ZXJNZXRob2RzID0gdGhpcy5yZXNvbHZlck1ldGhvZHM7XG4gICAgfVxuICAgIHJldHVybiByZXNvbHZlck1ldGhvZHM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIHRoZSByZXNvbHZlciB3aXRoIHRoZSBiZXN0IG1hdGNoLCBiYXNlZCBvbiBhIHNjb3JlXG4gICAqIGdlbmVyYXRlZCBieSB0aGUgcmVzb2x2ZXIuXG4gICAqXG4gICAqIFJlc29sdmVycyBtYXRjaCBieSBkZWZhdWx0IG9uIGBQYWdlVHlwZWAgYW5kIGBwYWdlLnRlbXBsYXRlYC5cbiAgICovXG4gIHByb3RlY3RlZCBnZXRNZXRhUmVzb2x2ZXIoXG4gICAgcGFnZTogUGFnZVxuICApOiBPYnNlcnZhYmxlPFBhZ2VNZXRhUmVzb2x2ZXIgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gdGhpcy5yZXNvbHZlcnMkLnBpcGUoXG4gICAgICBtYXAoKHJlc29sdmVycykgPT4gcmVzb2x2ZUFwcGxpY2FibGUocmVzb2x2ZXJzLCBbcGFnZV0sIFtwYWdlXSkpXG4gICAgKTtcbiAgfVxufVxuIl19