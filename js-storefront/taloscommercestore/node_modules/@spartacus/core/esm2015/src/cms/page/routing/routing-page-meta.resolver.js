import { Injectable, Injector } from '@angular/core';
import { combineLatest, of } from 'rxjs';
import { map, shareReplay, switchMap } from 'rxjs/operators';
import { ActivatedRoutesService } from '../../../routing/services/activated-routes.service';
import { DefaultRoutePageMetaResolver } from './default-route-page-meta.resolver';
import * as i0 from "@angular/core";
import * as i1 from "../../../routing/services/activated-routes.service";
/**
 * Resolves the page meta based on the Angular Activated Routes
 */
export class RoutingPageMetaResolver {
    constructor(activatedRoutesService, injector) {
        this.activatedRoutesService = activatedRoutesService;
        this.injector = injector;
        /**
         * Array of activated routes, excluding the special Angular `root` route.
         */
        this.routes$ = this.activatedRoutesService.routes$.pipe(
        // drop the first route - the special `root` route:
        map((routes) => (routes = routes.slice(1, routes.length))));
        /**
         * Array of activated routes together with precalculated extras:
         *
         * - route's page meta resolver
         * - route's absolute string URL
         *
         * In case when there is no page meta resolver configured for a specific route,
         * it inherits its parent's resolver.
         *
         * When there is no page meta resolver configured for the highest parent in the hierarchy,
         * it uses the `DefaultRoutePageMetaResolver`.
         */
        this.routesWithExtras$ = this.routes$.pipe(map((routes) => routes.reduce((results, route) => {
            var _a;
            const parent = results.length
                ? results[results.length - 1]
                : {
                    route: null,
                    resolver: this.injector.get(DefaultRoutePageMetaResolver),
                    url: '',
                };
            const resolver = (_a = this.getResolver(route)) !== null && _a !== void 0 ? _a : parent.resolver; // fallback to parent's resolver
            const urlPart = this.getUrlPart(route);
            const url = parent.url + (urlPart ? `/${urlPart}` : ''); // don't add slash for a route with path '', to avoid double slash ...//...
            return results.concat({ route, resolver, url });
        }, [])), shareReplay({ bufferSize: 1, refCount: true }));
    }
    /**
     * Array of breadcrumbs defined for all the activated routes (from the root route to the leaf route).
     * It emits on every completed routing navigation.
     */
    resolveBreadcrumbs(options) {
        return this.routesWithExtras$.pipe(map((routesWithExtras) => (options === null || options === void 0 ? void 0 : options.includeCurrentRoute) ? routesWithExtras
            : this.trimCurrentRoute(routesWithExtras)), switchMap((routesWithExtras) => routesWithExtras.length
            ? combineLatest(routesWithExtras.map((routeWithExtras) => this.resolveRouteBreadcrumb(routeWithExtras)))
            : of([])), map((breadcrumbArrays) => breadcrumbArrays.flat()));
    }
    /**
     * Returns the instance of the RoutePageMetaResolver configured for the given activated route.
     * Returns null in case there the resolver can't be injected or is undefined.
     *
     * @param route route to resolve
     */
    getResolver(route) {
        const pageMetaConfig = this.getPageMetaConfig(route);
        if (typeof pageMetaConfig !== 'string' && (pageMetaConfig === null || pageMetaConfig === void 0 ? void 0 : pageMetaConfig.resolver)) {
            return this.injector.get(pageMetaConfig.resolver, null);
        }
        return null;
    }
    /**
     * Resolvers breadcrumb for a specific route
     */
    resolveRouteBreadcrumb({ route, resolver, url, }) {
        const breadcrumbResolver = resolver;
        if (typeof breadcrumbResolver.resolveBreadcrumbs === 'function') {
            return breadcrumbResolver.resolveBreadcrumbs({
                route,
                url,
                pageMetaConfig: this.getPageMetaConfig(route),
            });
        }
        return of([]);
    }
    /**
     * By default in breadcrumbs list we don't want to show a link to the current page, so this function
     * trims the last breadcrumb (the breadcrumb of the current route).
     *
     * This function also handles special case when the current route has a configured empty path ('' route).
     * The '' routes are often a _technical_ routes to organize other routes, assign common guards for its children, etc.
     * It shouldn't happen that '' route has a defined breadcrumb config.
     *
     * In that case, we trim not only the last route ('' route), but also its parent route with non-empty path
     * (which likely defines the breadcrumb config).
     */
    trimCurrentRoute(routesWithExtras) {
        // If the last route is '', we trim:
        // - the '' route
        // - all parent '' routes (until we meet route with non-empty path)
        var _a, _b;
        let i = routesWithExtras.length - 1;
        while (((_b = (_a = routesWithExtras[i]) === null || _a === void 0 ? void 0 : _a.route) === null || _b === void 0 ? void 0 : _b.url.length) === 0 && i >= 0) {
            i--;
        }
        // Finally we trim the last route (the one with non-empty path)
        return routesWithExtras.slice(0, i);
    }
    /**
     * Returns the URL path for the given activated route in a string format.
     * (ActivatedRouteSnapshot#url contains an array of `UrlSegment`s, not a string)
     */
    getUrlPart(route) {
        return route.url.map((urlSegment) => urlSegment.path).join('/');
    }
    /**
     * Returns the breadcrumb config placed in the route's `data` configuration.
     */
    getPageMetaConfig(route) {
        var _a, _b;
        // Note: we use `route.routeConfig.data` (not `route.data`) to save us from
        // an edge case bug. In Angular, by design the `data` of ActivatedRoute is inherited
        // from the parent route, if only the child has an empty path ''.
        // But in any case we don't want the page meta configs to be inherited, so we
        // read data from the original `routeConfig` which is static.
        //
        // Note: we may inherit the parent's page meta resolver in case we don't define it,
        // but we don't want to inherit parent's page meta config!
        return (_b = (_a = route === null || route === void 0 ? void 0 : route.routeConfig) === null || _a === void 0 ? void 0 : _a.data) === null || _b === void 0 ? void 0 : _b.cxPageMeta;
    }
}
RoutingPageMetaResolver.ɵprov = i0.ɵɵdefineInjectable({ factory: function RoutingPageMetaResolver_Factory() { return new RoutingPageMetaResolver(i0.ɵɵinject(i1.ActivatedRoutesService), i0.ɵɵinject(i0.INJECTOR)); }, token: RoutingPageMetaResolver, providedIn: "root" });
RoutingPageMetaResolver.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
RoutingPageMetaResolver.ctorParameters = () => [
    { type: ActivatedRoutesService },
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGluZy1wYWdlLW1ldGEucmVzb2x2ZXIuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvUGF0cnlrL0Rlc2t0b3Avc3BhcnRhY3VzL3Byb2plY3RzL2NvcmUvIiwic291cmNlcyI6WyJzcmMvY21zL3BhZ2Uvcm91dGluZy9yb3V0aW5nLXBhZ2UtbWV0YS5yZXNvbHZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyRCxPQUFPLEVBQUUsYUFBYSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvREFBb0QsQ0FBQztBQUU1RixPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQzs7O0FBcUJsRjs7R0FFRztBQUVILE1BQU0sT0FBTyx1QkFBdUI7SUFDbEMsWUFDWSxzQkFBOEMsRUFDOUMsUUFBa0I7UUFEbEIsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUM5QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRzlCOztXQUVHO1FBQ2dCLFlBQU8sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDLElBQUk7UUFDbkUsbURBQW1EO1FBQ25ELEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FDM0QsQ0FBQztRQUVGOzs7Ozs7Ozs7OztXQVdHO1FBQ2dCLHNCQUFpQixHQUVoQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FDbkIsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FDYixNQUFNLENB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bnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlc1NlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9yb3V0aW5nL3NlcnZpY2VzL2FjdGl2YXRlZC1yb3V0ZXMuc2VydmljZSc7XG5pbXBvcnQgeyBCcmVhZGNydW1iTWV0YSB9IGZyb20gJy4uLy4uL21vZGVsL3BhZ2UubW9kZWwnO1xuaW1wb3J0IHsgRGVmYXVsdFJvdXRlUGFnZU1ldGFSZXNvbHZlciB9IGZyb20gJy4vZGVmYXVsdC1yb3V0ZS1wYWdlLW1ldGEucmVzb2x2ZXInO1xuaW1wb3J0IHtcbiAgQWN0aXZhdGVkUm91dGVTbmFwc2hvdFdpdGhQYWdlTWV0YSxcbiAgUm91dGVCcmVhZGNydW1iUmVzb2x2ZXIsXG4gIFJvdXRlUGFnZU1ldGFDb25maWcsXG59IGZyb20gJy4vcm91dGUtcGFnZS1tZXRhLm1vZGVsJztcblxuLy8gUFJJVkFURVxuZXhwb3J0IGludGVyZmFjZSBSb3V0ZVdpdGhFeHRyYXMge1xuICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdFdpdGhQYWdlTWV0YTtcbiAgcmVzb2x2ZXI6IGFueTtcbiAgdXJsOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUm91dGluZ1Jlc29sdmVCcmVhZGNydW1ic09wdGlvbnMge1xuICAvKipcbiAgICogSW5jbHVkZXMgdGhlIGN1cnJlbnQgcm91dGUgaW4gdGhlIGJyZWFkY3J1bWJzLlxuICAgKi9cbiAgaW5jbHVkZUN1cnJlbnRSb3V0ZT86IGJvb2xlYW47XG59XG5cbi8qKlxuICogUmVzb2x2ZXMgdGhlIHBhZ2UgbWV0YSBiYXNlZCBvbiB0aGUgQW5ndWxhciBBY3RpdmF0ZWQgUm91dGVzXG4gKi9cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgUm91dGluZ1BhZ2VNZXRhUmVzb2x2ZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgYWN0aXZhdGVkUm91dGVzU2VydmljZTogQWN0aXZhdGVkUm91dGVzU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yXG4gICkge31cblxuICAvKipcbiAgICogQXJyYXkgb2YgYWN0aXZhdGVkIHJvdXRlcywgZXhjbHVkaW5nIHRoZSBzcGVjaWFsIEFuZ3VsYXIgYHJvb3RgIHJvdXRlLlxuICAgKi9cbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHJvdXRlcyQgPSB0aGlzLmFjdGl2YXRlZFJvdXRlc1NlcnZpY2Uucm91dGVzJC5waXBlKFxuICAgIC8vIGRyb3AgdGhlIGZpcnN0IHJvdXRlIC0gdGhlIHNwZWNpYWwgYHJvb3RgIHJvdXRlOlxuICAgIG1hcCgocm91dGVzKSA9PiAocm91dGVzID0gcm91dGVzLnNsaWNlKDEsIHJvdXRlcy5sZW5ndGgpKSlcbiAgKTtcblxuICAvKipcbiAgICogQXJyYXkgb2YgYWN0aXZhdGVkIHJvdXRlcyB0b2dldGhlciB3aXRoIHByZWNhbGN1bGF0ZWQgZXh0cmFzOlxuICAgKlxuICAgKiAtIHJvdXRlJ3MgcGFnZSBtZXRhIHJlc29sdmVyXG4gICAqIC0gcm91dGUncyBhYnNvbHV0ZSBzdHJpbmcgVVJMXG4gICAqXG4gICAqIEluIGNhc2Ugd2hlbiB0aGVyZSBpcyBubyBwYWdlIG1ldGEgcmVzb2x2ZXIgY29uZmlndXJlZCBmb3IgYSBzcGVjaWZpYyByb3V0ZSxcbiAgICogaXQgaW5oZXJpdHMgaXRzIHBhcmVudCdzIHJlc29sdmVyLlxuICAgKlxuICAgKiBXaGVuIHRoZXJlIGlzIG5vIHBhZ2UgbWV0YSByZXNvbHZlciBjb25maWd1cmVkIGZvciB0aGUgaGlnaGVzdCBwYXJlbnQgaW4gdGhlIGhpZXJhcmNoeSxcbiAgICogaXQgdXNlcyB0aGUgYERlZmF1bHRSb3V0ZVBhZ2VNZXRhUmVzb2x2ZXJgLlxuICAgKi9cbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHJvdXRlc1dpdGhFeHRyYXMkOiBPYnNlcnZhYmxlPFxuICAgIFJvdXRlV2l0aEV4dHJhc1tdXG4gID4gPSB0aGlzLnJvdXRlcyQucGlwZShcbiAgICBtYXAoKHJvdXRlcykgPT5cbiAgICAgIHJvdXRlcy5yZWR1Y2U8Um91dGVXaXRoRXh0cmFzW10+KChyZXN1bHRzLCByb3V0ZSkgPT4ge1xuICAgICAgICBjb25zdCBwYXJlbnQgPSByZXN1bHRzLmxlbmd0aFxuICAgICAgICAgID8gcmVzdWx0c1tyZXN1bHRzLmxlbmd0aCAtIDFdXG4gICAgICAgICAgOiB7XG4gICAgICAgICAgICAgIHJvdXRlOiBudWxsLFxuICAgICAgICAgICAgICByZXNvbHZlcjogdGhpcy5pbmplY3Rvci5nZXQoRGVmYXVsdFJvdXRlUGFnZU1ldGFSZXNvbHZlciksXG4gICAgICAgICAgICAgIHVybDogJycsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlc29sdmVyID0gdGhpcy5nZXRSZXNvbHZlcihyb3V0ZSkgPz8gcGFyZW50LnJlc29sdmVyOyAvLyBmYWxsYmFjayB0byBwYXJlbnQncyByZXNvbHZlclxuXG4gICAgICAgIGNvbnN0IHVybFBhcnQgPSB0aGlzLmdldFVybFBhcnQocm91dGUpO1xuICAgICAgICBjb25zdCB1cmwgPSBwYXJlbnQudXJsICsgKHVybFBhcnQgPyBgLyR7dXJsUGFydH1gIDogJycpOyAvLyBkb24ndCBhZGQgc2xhc2ggZm9yIGEgcm91dGUgd2l0aCBwYXRoICcnLCB0byBhdm9pZCBkb3VibGUgc2xhc2ggLi4uLy8uLi5cblxuICAgICAgICByZXR1cm4gcmVzdWx0cy5jb25jYXQoeyByb3V0ZSwgcmVzb2x2ZXIsIHVybCB9KTtcbiAgICAgIH0sIFtdKVxuICAgICksXG4gICAgc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogdHJ1ZSB9KVxuICApO1xuXG4gIC8qKlxuICAgKiBBcnJheSBvZiBicmVhZGNydW1icyBkZWZpbmVkIGZvciBhbGwgdGhlIGFjdGl2YXRlZCByb3V0ZXMgKGZyb20gdGhlIHJvb3Qgcm91dGUgdG8gdGhlIGxlYWYgcm91dGUpLlxuICAgKiBJdCBlbWl0cyBvbiBldmVyeSBjb21wbGV0ZWQgcm91dGluZyBuYXZpZ2F0aW9uLlxuICAgKi9cbiAgcmVzb2x2ZUJyZWFkY3J1bWJzKFxuICAgIG9wdGlvbnM/OiBSb3V0aW5nUmVzb2x2ZUJyZWFkY3J1bWJzT3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPEJyZWFkY3J1bWJNZXRhW10+IHtcbiAgICByZXR1cm4gdGhpcy5yb3V0ZXNXaXRoRXh0cmFzJC5waXBlKFxuICAgICAgbWFwKChyb3V0ZXNXaXRoRXh0cmFzKSA9PlxuICAgICAgICBvcHRpb25zPy5pbmNsdWRlQ3VycmVudFJvdXRlXG4gICAgICAgICAgPyByb3V0ZXNXaXRoRXh0cmFzXG4gICAgICAgICAgOiB0aGlzLnRyaW1DdXJyZW50Um91dGUocm91dGVzV2l0aEV4dHJhcylcbiAgICAgICksXG4gICAgICBzd2l0Y2hNYXAoKHJvdXRlc1dpdGhFeHRyYXMpID0+XG4gICAgICAgIHJvdXRlc1dpdGhFeHRyYXMubGVuZ3RoXG4gICAgICAgICAgPyBjb21iaW5lTGF0ZXN0KFxuICAgICAgICAgICAgICByb3V0ZXNXaXRoRXh0cmFzLm1hcCgocm91dGVXaXRoRXh0cmFzKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZVJvdXRlQnJlYWRjcnVtYihyb3V0ZVdpdGhFeHRyYXMpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgICA6IG9mKFtdKVxuICAgICAgKSxcbiAgICAgIG1hcCgoYnJlYWRjcnVtYkFycmF5cykgPT4gYnJlYWRjcnVtYkFycmF5cy5mbGF0KCkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBpbnN0YW5jZSBvZiB0aGUgUm91dGVQYWdlTWV0YVJlc29sdmVyIGNvbmZpZ3VyZWQgZm9yIHRoZSBnaXZlbiBhY3RpdmF0ZWQgcm91dGUuXG4gICAqIFJldHVybnMgbnVsbCBpbiBjYXNlIHRoZXJlIHRoZSByZXNvbHZlciBjYW4ndCBiZSBpbmplY3RlZCBvciBpcyB1bmRlZmluZWQuXG4gICAqXG4gICAqIEBwYXJhbSByb3V0ZSByb3V0ZSB0byByZXNvbHZlXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0UmVzb2x2ZXIocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3RXaXRoUGFnZU1ldGEpOiBhbnkge1xuICAgIGNvbnN0IHBhZ2VNZXRhQ29uZmlnID0gdGhpcy5nZXRQYWdlTWV0YUNvbmZpZyhyb3V0ZSk7XG5cbiAgICBpZiAodHlwZW9mIHBhZ2VNZXRhQ29uZmlnICE9PSAnc3RyaW5nJyAmJiBwYWdlTWV0YUNvbmZpZz8ucmVzb2x2ZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLmluamVjdG9yLmdldChwYWdlTWV0YUNvbmZpZy5yZXNvbHZlciwgbnVsbCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc29sdmVycyBicmVhZGNydW1iIGZvciBhIHNwZWNpZmljIHJvdXRlXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVzb2x2ZVJvdXRlQnJlYWRjcnVtYih7XG4gICAgcm91dGUsXG4gICAgcmVzb2x2ZXIsXG4gICAgdXJsLFxuICB9OiBSb3V0ZVdpdGhFeHRyYXMpOiBPYnNlcnZhYmxlPEJyZWFkY3J1bWJNZXRhW10+IHtcbiAgICBjb25zdCBicmVhZGNydW1iUmVzb2x2ZXIgPSByZXNvbHZlciBhcyBSb3V0ZUJyZWFkY3J1bWJSZXNvbHZlcjtcblxuICAgIGlmICh0eXBlb2YgYnJlYWRjcnVtYlJlc29sdmVyLnJlc29sdmVCcmVhZGNydW1icyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgcmV0dXJuIGJyZWFkY3J1bWJSZXNvbHZlci5yZXNvbHZlQnJlYWRjcnVtYnMoe1xuICAgICAgICByb3V0ZSxcbiAgICAgICAgdXJsLFxuICAgICAgICBwYWdlTWV0YUNvbmZpZzogdGhpcy5nZXRQYWdlTWV0YUNvbmZpZyhyb3V0ZSksXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG9mKFtdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCeSBkZWZhdWx0IGluIGJyZWFkY3J1bWJzIGxpc3Qgd2UgZG9uJ3Qgd2FudCB0byBzaG93IGEgbGluayB0byB0aGUgY3VycmVudCBwYWdlLCBzbyB0aGlzIGZ1bmN0aW9uXG4gICAqIHRyaW1zIHRoZSBsYXN0IGJyZWFkY3J1bWIgKHRoZSBicmVhZGNydW1iIG9mIHRoZSBjdXJyZW50IHJvdXRlKS5cbiAgICpcbiAgICogVGhpcyBmdW5jdGlvbiBhbHNvIGhhbmRsZXMgc3BlY2lhbCBjYXNlIHdoZW4gdGhlIGN1cnJlbnQgcm91dGUgaGFzIGEgY29uZmlndXJlZCBlbXB0eSBwYXRoICgnJyByb3V0ZSkuXG4gICAqIFRoZSAnJyByb3V0ZXMgYXJlIG9mdGVuIGEgX3RlY2huaWNhbF8gcm91dGVzIHRvIG9yZ2FuaXplIG90aGVyIHJvdXRlcywgYXNzaWduIGNvbW1vbiBndWFyZHMgZm9yIGl0cyBjaGlsZHJlbiwgZXRjLlxuICAgKiBJdCBzaG91bGRuJ3QgaGFwcGVuIHRoYXQgJycgcm91dGUgaGFzIGEgZGVmaW5lZCBicmVhZGNydW1iIGNvbmZpZy5cbiAgICpcbiAgICogSW4gdGhhdCBjYXNlLCB3ZSB0cmltIG5vdCBvbmx5IHRoZSBsYXN0IHJvdXRlICgnJyByb3V0ZSksIGJ1dCBhbHNvIGl0cyBwYXJlbnQgcm91dGUgd2l0aCBub24tZW1wdHkgcGF0aFxuICAgKiAod2hpY2ggbGlrZWx5IGRlZmluZXMgdGhlIGJyZWFkY3J1bWIgY29uZmlnKS5cbiAgICovXG4gIHByaXZhdGUgdHJpbUN1cnJlbnRSb3V0ZShcbiAgICByb3V0ZXNXaXRoRXh0cmFzOiBSb3V0ZVdpdGhFeHRyYXNbXVxuICApOiBSb3V0ZVdpdGhFeHRyYXNbXSB7XG4gICAgLy8gSWYgdGhlIGxhc3Qgcm91dGUgaXMgJycsIHdlIHRyaW06XG4gICAgLy8gLSB0aGUgJycgcm91dGVcbiAgICAvLyAtIGFsbCBwYXJlbnQgJycgcm91dGVzICh1bnRpbCB3ZSBtZWV0IHJvdXRlIHdpdGggbm9uLWVtcHR5IHBhdGgpXG5cbiAgICBsZXQgaSA9IHJvdXRlc1dpdGhFeHRyYXMubGVuZ3RoIC0gMTtcbiAgICB3aGlsZSAocm91dGVzV2l0aEV4dHJhc1tpXT8ucm91dGU/LnVybC5sZW5ndGggPT09IDAgJiYgaSA+PSAwKSB7XG4gICAgICBpLS07XG4gICAgfVxuXG4gICAgLy8gRmluYWxseSB3ZSB0cmltIHRoZSBsYXN0IHJvdXRlICh0aGUgb25lIHdpdGggbm9uLWVtcHR5IHBhdGgpXG4gICAgcmV0dXJuIHJvdXRlc1dpdGhFeHRyYXMuc2xpY2UoMCwgaSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgVVJMIHBhdGggZm9yIHRoZSBnaXZlbiBhY3RpdmF0ZWQgcm91dGUgaW4gYSBzdHJpbmcgZm9ybWF0LlxuICAgKiAoQWN0aXZhdGVkUm91dGVTbmFwc2hvdCN1cmwgY29udGFpbnMgYW4gYXJyYXkgb2YgYFVybFNlZ21lbnRgcywgbm90IGEgc3RyaW5nKVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRVcmxQYXJ0KHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogc3RyaW5nIHtcbiAgICByZXR1cm4gcm91dGUudXJsLm1hcCgodXJsU2VnbWVudCkgPT4gdXJsU2VnbWVudC5wYXRoKS5qb2luKCcvJyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgYnJlYWRjcnVtYiBjb25maWcgcGxhY2VkIGluIHRoZSByb3V0ZSdzIGBkYXRhYCBjb25maWd1cmF0aW9uLlxuICAgKi9cbiAgcHJvdGVjdGVkIGdldFBhZ2VNZXRhQ29uZmlnKFxuICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90V2l0aFBhZ2VNZXRhXG4gICk6IFJvdXRlUGFnZU1ldGFDb25maWcge1xuICAgIC8vIE5vdGU6IHdlIHVzZSBgcm91dGUucm91dGVDb25maWcuZGF0YWAgKG5vdCBgcm91dGUuZGF0YWApIHRvIHNhdmUgdXMgZnJvbVxuICAgIC8vIGFuIGVkZ2UgY2FzZSBidWcuIEluIEFuZ3VsYXIsIGJ5IGRlc2lnbiB0aGUgYGRhdGFgIG9mIEFjdGl2YXRlZFJvdXRlIGlzIGluaGVyaXRlZFxuICAgIC8vIGZyb20gdGhlIHBhcmVudCByb3V0ZSwgaWYgb25seSB0aGUgY2hpbGQgaGFzIGFuIGVtcHR5IHBhdGggJycuXG4gICAgLy8gQnV0IGluIGFueSBjYXNlIHdlIGRvbid0IHdhbnQgdGhlIHBhZ2UgbWV0YSBjb25maWdzIHRvIGJlIGluaGVyaXRlZCwgc28gd2VcbiAgICAvLyByZWFkIGRhdGEgZnJvbSB0aGUgb3JpZ2luYWwgYHJvdXRlQ29uZmlnYCB3aGljaCBpcyBzdGF0aWMuXG4gICAgLy9cbiAgICAvLyBOb3RlOiB3ZSBtYXkgaW5oZXJpdCB0aGUgcGFyZW50J3MgcGFnZSBtZXRhIHJlc29sdmVyIGluIGNhc2Ugd2UgZG9uJ3QgZGVmaW5lIGl0LFxuICAgIC8vIGJ1dCB3ZSBkb24ndCB3YW50IHRvIGluaGVyaXQgcGFyZW50J3MgcGFnZSBtZXRhIGNvbmZpZyFcbiAgICByZXR1cm4gcm91dGU/LnJvdXRlQ29uZmlnPy5kYXRhPy5jeFBhZ2VNZXRhO1xuICB9XG59XG4iXX0=