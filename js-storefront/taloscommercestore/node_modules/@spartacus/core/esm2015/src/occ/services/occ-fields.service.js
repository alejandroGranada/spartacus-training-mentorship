import { Injectable } from '@angular/core';
import { mergeFields, parseFields } from '../utils/occ-fields';
import { HttpClient } from '@angular/common/http';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * Helper service for optimizing endpoint calls to occ backend
 */
export class OccFieldsService {
    constructor(http) {
        this.http = http;
        this.FIELDS_PARAM = 'fields';
    }
    /**
     * Merge similar occ endpoints calls by merging fields parameter
     *
     * We assume that different scopes are defined by different fields parameters,
     * so we are grouping all requests with the same urls (except fields definition)
     * and merging into one request with fields that will satisfy all separate ones.
     *
     * @param models
     */
    getOptimalUrlGroups(models) {
        const groupedByUrls = {};
        for (const model of models) {
            const [urlPart, fields] = this.splitFields(model.url);
            if (!groupedByUrls[urlPart]) {
                groupedByUrls[urlPart] = {};
            }
            model.fields = fields ? parseFields(fields) : {};
            groupedByUrls[urlPart][model.scopedData.scope] = model;
        }
        const mergedUrls = {};
        for (const [url, group] of Object.entries(groupedByUrls)) {
            const urlWithFields = this.getUrlWithFields(url, Object.values(group).map((lo) => lo.fields));
            mergedUrls[urlWithFields] = group;
        }
        return mergedUrls;
    }
    /**
     * Extract fields parameter from occ endpoint url
     *
     * @param urlWithFields
     */
    splitFields(urlWithFields) {
        const [url, params] = urlWithFields.split('?');
        const paramsMap = {};
        if (params) {
            params.split('&').forEach((param) => {
                const keyValue = param.split('=');
                paramsMap[keyValue[0]] = keyValue[1];
            });
        }
        const nonFieldsParams = Object.keys(paramsMap)
            .sort()
            .reduce((id, par) => {
            if (par !== this.FIELDS_PARAM) {
                id.push(paramsMap[par] ? `${par}=${paramsMap[par]}` : par);
            }
            return id;
        }, []);
        const nonFields = nonFieldsParams.join('&');
        return [
            nonFields ? `${url}?${nonFields}` : url,
            paramsMap[this.FIELDS_PARAM],
        ];
    }
    /**
     * Combine url with field parameters
     *
     * @param url
     * @param fields
     */
    getUrlWithFields(url, fields) {
        const mergedFields = mergeFields(fields);
        if (mergedFields) {
            url += url.includes('?') ? '&' : '?';
            url += `${this.FIELDS_PARAM}=${mergedFields}`;
        }
        return url;
    }
}
OccFieldsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function OccFieldsService_Factory() { return new OccFieldsService(i0.ɵɵinject(i1.HttpClient)); }, token: OccFieldsService, providedIn: "root" });
OccFieldsService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
OccFieldsService.ctorParameters = () => [
    { type: HttpClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2NjLWZpZWxkcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL1BhdHJ5ay9EZXNrdG9wL3NwYXJ0YWN1cy9wcm9qZWN0cy9jb3JlLyIsInNvdXJjZXMiOlsic3JjL29jYy9zZXJ2aWNlcy9vY2MtZmllbGRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRS9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7O0FBNkJsRDs7R0FFRztBQUlILE1BQU0sT0FBTyxnQkFBZ0I7SUFDM0IsWUFBc0IsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUU1QixpQkFBWSxHQUFHLFFBQVEsQ0FBQztJQUZPLENBQUM7SUFJMUM7Ozs7Ozs7O09BUUc7SUFDSCxtQkFBbUIsQ0FBQyxNQUEyQjtRQUM3QyxNQUFNLGFBQWEsR0FBMEIsRUFBRSxDQUFDO1FBQ2hELEtBQUssTUFBTSxLQUFLLElBQUksTUFBMEIsRUFBRTtZQUM5QyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQzNCLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7YUFDN0I7WUFDRCxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDakQsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBQ3hEO1FBRUQsTUFBTSxVQUFVLEdBQTBCLEVBQUUsQ0FBQztRQUM3QyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUN4RCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQ3pDLEdBQUcsRUFDSCxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUM1QyxDQUFDO1lBQ0YsVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEtBQUssQ0FBQztTQUNuQztRQUVELE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssV0FBVyxDQUFDLGFBQXFCO1FBQ3ZDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUvQyxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFFckIsSUFBSSxNQUFNLEVBQUU7WUFDVixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO2dCQUNsQyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNsQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQzthQUMzQyxJQUFJLEVBQUU7YUFDTixNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDbEIsSUFBSSxHQUFHLEtBQUssSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDN0IsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUM1RDtZQUNELE9BQU8sRUFBRSxDQUFDO1FBQ1osQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRVQsTUFBTSxTQUFTLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU1QyxPQUFPO1lBQ0wsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRztZQUN2QyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztTQUM3QixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssZ0JBQWdCLENBQUMsR0FBVyxFQUFFLE1BQTJCO1FBQy9ELE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV6QyxJQUFJLFlBQVksRUFBRTtZQUNoQixHQUFHLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7WUFDckMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxZQUFZLEVBQUUsQ0FBQztTQUMvQztRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQzs7OztZQXpGRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQWxDUSxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbWVyZ2VGaWVsZHMsIHBhcnNlRmllbGRzIH0gZnJvbSAnLi4vdXRpbHMvb2NjLWZpZWxkcyc7XG5pbXBvcnQgeyBTY29wZWREYXRhIH0gZnJvbSAnLi4vLi4vbW9kZWwvc2NvcGVkLWRhdGEnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuZXhwb3J0IGludGVyZmFjZSBTY29wZWREYXRhV2l0aFVybCB7XG4gIC8qKiBVcmwgKHdpdGggZmllbGRzKSB0byBsb2FkIHNjb3BlZCBkYXRhICovXG4gIHVybD86IHN0cmluZztcbiAgLyoqIHNjb3BlZCBkYXRhIG1vZGVsICovXG4gIHNjb3BlZERhdGE6IFNjb3BlZERhdGE8YW55Pjtcbn1cblxuLyoqXG4gKiBJbnRlcm1lZGlhdGUgbW9kZWwgdG8gYWNjb21tb2RhdGUgYWxsIGRhdGEgbmVlZGVkIHRvIHBlcmZvcm0gb2NjIGZpZWxkcyBvcHRpbWl6YXRpb25zXG4gKiB3cmFwcGluZyBTY29wZWREYXRhIHdpdGggdXJsIGFuZCBmaWVsZHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBPY2NGaWVsZHNNb2RlbCBleHRlbmRzIFNjb3BlZERhdGFXaXRoVXJsIHtcbiAgLyoqIGV4dHJhY3RlZCBmaWVsZHMgb2JqZWN0LCB1c2VkIHRvIGV4dHJhY3QgZGF0YSBmcm9tIGJyb2FkZXIgbW9kZWwgKi9cbiAgZmllbGRzPzogb2JqZWN0O1xufVxuXG4vKipcbiAqIEdyb3VwZWQgcmVzdCBjYWxscyB3aXRoIG9wdGltYWwgdXJsc1xuICpcbiAqIE9uZSB1cmwgZ3JvdXBzIGFsbCBzY29wZXMgaXQgY292ZXJzIHdpdGggcmVsYXRlZCBvY2NGaWVsZHNNb2RlbHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBPY2NPcHRpbWltYWxVcmxHcm91cHMge1xuICBbb3B0aW1hbFVybDogc3RyaW5nXToge1xuICAgIFtzY29wZTogc3RyaW5nXTogT2NjRmllbGRzTW9kZWw7XG4gIH07XG59XG5cbi8qKlxuICogSGVscGVyIHNlcnZpY2UgZm9yIG9wdGltaXppbmcgZW5kcG9pbnQgY2FsbHMgdG8gb2NjIGJhY2tlbmRcbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIE9jY0ZpZWxkc1NlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudCkge31cblxuICBwcm90ZWN0ZWQgRklFTERTX1BBUkFNID0gJ2ZpZWxkcyc7XG5cbiAgLyoqXG4gICAqIE1lcmdlIHNpbWlsYXIgb2NjIGVuZHBvaW50cyBjYWxscyBieSBtZXJnaW5nIGZpZWxkcyBwYXJhbWV0ZXJcbiAgICpcbiAgICogV2UgYXNzdW1lIHRoYXQgZGlmZmVyZW50IHNjb3BlcyBhcmUgZGVmaW5lZCBieSBkaWZmZXJlbnQgZmllbGRzIHBhcmFtZXRlcnMsXG4gICAqIHNvIHdlIGFyZSBncm91cGluZyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgc2FtZSB1cmxzIChleGNlcHQgZmllbGRzIGRlZmluaXRpb24pXG4gICAqIGFuZCBtZXJnaW5nIGludG8gb25lIHJlcXVlc3Qgd2l0aCBmaWVsZHMgdGhhdCB3aWxsIHNhdGlzZnkgYWxsIHNlcGFyYXRlIG9uZXMuXG4gICAqXG4gICAqIEBwYXJhbSBtb2RlbHNcbiAgICovXG4gIGdldE9wdGltYWxVcmxHcm91cHMobW9kZWxzOiBTY29wZWREYXRhV2l0aFVybFtdKTogT2NjT3B0aW1pbWFsVXJsR3JvdXBzIHtcbiAgICBjb25zdCBncm91cGVkQnlVcmxzOiBPY2NPcHRpbWltYWxVcmxHcm91cHMgPSB7fTtcbiAgICBmb3IgKGNvbnN0IG1vZGVsIG9mIG1vZGVscyBhcyBPY2NGaWVsZHNNb2RlbFtdKSB7XG4gICAgICBjb25zdCBbdXJsUGFydCwgZmllbGRzXSA9IHRoaXMuc3BsaXRGaWVsZHMobW9kZWwudXJsKTtcbiAgICAgIGlmICghZ3JvdXBlZEJ5VXJsc1t1cmxQYXJ0XSkge1xuICAgICAgICBncm91cGVkQnlVcmxzW3VybFBhcnRdID0ge307XG4gICAgICB9XG4gICAgICBtb2RlbC5maWVsZHMgPSBmaWVsZHMgPyBwYXJzZUZpZWxkcyhmaWVsZHMpIDoge307XG4gICAgICBncm91cGVkQnlVcmxzW3VybFBhcnRdW21vZGVsLnNjb3BlZERhdGEuc2NvcGVdID0gbW9kZWw7XG4gICAgfVxuXG4gICAgY29uc3QgbWVyZ2VkVXJsczogT2NjT3B0aW1pbWFsVXJsR3JvdXBzID0ge307XG4gICAgZm9yIChjb25zdCBbdXJsLCBncm91cF0gb2YgT2JqZWN0LmVudHJpZXMoZ3JvdXBlZEJ5VXJscykpIHtcbiAgICAgIGNvbnN0IHVybFdpdGhGaWVsZHMgPSB0aGlzLmdldFVybFdpdGhGaWVsZHMoXG4gICAgICAgIHVybCxcbiAgICAgICAgT2JqZWN0LnZhbHVlcyhncm91cCkubWFwKChsbykgPT4gbG8uZmllbGRzKVxuICAgICAgKTtcbiAgICAgIG1lcmdlZFVybHNbdXJsV2l0aEZpZWxkc10gPSBncm91cDtcbiAgICB9XG5cbiAgICByZXR1cm4gbWVyZ2VkVXJscztcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHRyYWN0IGZpZWxkcyBwYXJhbWV0ZXIgZnJvbSBvY2MgZW5kcG9pbnQgdXJsXG4gICAqXG4gICAqIEBwYXJhbSB1cmxXaXRoRmllbGRzXG4gICAqL1xuICBwcml2YXRlIHNwbGl0RmllbGRzKHVybFdpdGhGaWVsZHM6IHN0cmluZyk6IFtzdHJpbmcsIHN0cmluZ10ge1xuICAgIGNvbnN0IFt1cmwsIHBhcmFtc10gPSB1cmxXaXRoRmllbGRzLnNwbGl0KCc/Jyk7XG5cbiAgICBjb25zdCBwYXJhbXNNYXAgPSB7fTtcblxuICAgIGlmIChwYXJhbXMpIHtcbiAgICAgIHBhcmFtcy5zcGxpdCgnJicpLmZvckVhY2goKHBhcmFtKSA9PiB7XG4gICAgICAgIGNvbnN0IGtleVZhbHVlID0gcGFyYW0uc3BsaXQoJz0nKTtcbiAgICAgICAgcGFyYW1zTWFwW2tleVZhbHVlWzBdXSA9IGtleVZhbHVlWzFdO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3Qgbm9uRmllbGRzUGFyYW1zID0gT2JqZWN0LmtleXMocGFyYW1zTWFwKVxuICAgICAgLnNvcnQoKVxuICAgICAgLnJlZHVjZSgoaWQsIHBhcikgPT4ge1xuICAgICAgICBpZiAocGFyICE9PSB0aGlzLkZJRUxEU19QQVJBTSkge1xuICAgICAgICAgIGlkLnB1c2gocGFyYW1zTWFwW3Bhcl0gPyBgJHtwYXJ9PSR7cGFyYW1zTWFwW3Bhcl19YCA6IHBhcik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGlkO1xuICAgICAgfSwgW10pO1xuXG4gICAgY29uc3Qgbm9uRmllbGRzID0gbm9uRmllbGRzUGFyYW1zLmpvaW4oJyYnKTtcblxuICAgIHJldHVybiBbXG4gICAgICBub25GaWVsZHMgPyBgJHt1cmx9PyR7bm9uRmllbGRzfWAgOiB1cmwsXG4gICAgICBwYXJhbXNNYXBbdGhpcy5GSUVMRFNfUEFSQU1dLFxuICAgIF07XG4gIH1cblxuICAvKipcbiAgICogQ29tYmluZSB1cmwgd2l0aCBmaWVsZCBwYXJhbWV0ZXJzXG4gICAqXG4gICAqIEBwYXJhbSB1cmxcbiAgICogQHBhcmFtIGZpZWxkc1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRVcmxXaXRoRmllbGRzKHVybDogc3RyaW5nLCBmaWVsZHM6IChzdHJpbmcgfCBvYmplY3QpW10pOiBzdHJpbmcge1xuICAgIGNvbnN0IG1lcmdlZEZpZWxkcyA9IG1lcmdlRmllbGRzKGZpZWxkcyk7XG5cbiAgICBpZiAobWVyZ2VkRmllbGRzKSB7XG4gICAgICB1cmwgKz0gdXJsLmluY2x1ZGVzKCc/JykgPyAnJicgOiAnPyc7XG4gICAgICB1cmwgKz0gYCR7dGhpcy5GSUVMRFNfUEFSQU19PSR7bWVyZ2VkRmllbGRzfWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVybDtcbiAgfVxufVxuIl19