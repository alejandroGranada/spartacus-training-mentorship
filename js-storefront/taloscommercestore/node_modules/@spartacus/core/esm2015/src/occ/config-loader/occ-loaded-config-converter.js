import { Injectable } from '@angular/core';
import { BASE_SITE_CONTEXT_ID, CURRENCY_CONTEXT_ID, LANGUAGE_CONTEXT_ID, THEME_CONTEXT_ID, } from '../../site-context/providers/context-ids';
import { JavaRegExpConverter } from '../../util/java-reg-exp-converter/java-reg-exp-converter';
import * as i0 from "@angular/core";
import * as i1 from "../../util/java-reg-exp-converter/java-reg-exp-converter";
/**
 * @deprecated since 3.2 - use `SiteContextConfigInitializer` instead
 */
// TODO(#11515): drop it in 4.0
export class OccLoadedConfigConverter {
    constructor(javaRegExpConverter) {
        this.javaRegExpConverter = javaRegExpConverter;
    }
    fromOccBaseSites(baseSites, currentUrl) {
        const baseSite = baseSites === null || baseSites === void 0 ? void 0 : baseSites.find((site) => this.isCurrentBaseSite(site, currentUrl));
        if (!baseSite) {
            throw this.getError(`Current url (${currentUrl}) doesn't match with any of url patterns of any base site.`);
        }
        // Although `stores` property is an array, typically there is only one store. So we return the first store from the list.
        const baseStore = baseSite.stores && baseSite.stores[0];
        if (!baseStore) {
            throw this.getError(`Current base site (${baseSite.uid}) doesn't have any base store.`);
        }
        return {
            baseSite: baseSite.uid,
            languages: this.getIsoCodes(baseStore.languages, baseSite.defaultLanguage || baseStore.defaultLanguage),
            currencies: this.getIsoCodes(baseStore.currencies, baseStore.defaultCurrency),
            urlParameters: this.getUrlParams(baseSite.urlEncodingAttributes),
            theme: baseSite.theme,
        };
    }
    toSiteContextConfig({ baseSite, languages, currencies, urlParameters: urlEncodingAttributes, theme, }) {
        const result = {
            context: {
                urlParameters: urlEncodingAttributes,
                [BASE_SITE_CONTEXT_ID]: [baseSite],
                [LANGUAGE_CONTEXT_ID]: languages,
                [CURRENCY_CONTEXT_ID]: currencies,
                [THEME_CONTEXT_ID]: [theme],
            },
        };
        return result;
    }
    toI18nConfig({ languages }) {
        return { i18n: { fallbackLang: languages[0] } };
    }
    isCurrentBaseSite(site, currentUrl) {
        const index = (site.urlPatterns || []).findIndex((javaRegexp) => {
            const jsRegexp = this.javaRegExpConverter.toJsRegExp(javaRegexp);
            if (jsRegexp) {
                const result = jsRegexp.test(currentUrl);
                return result;
            }
        });
        return index !== -1;
    }
    /**
     * Returns an array of url encoded site context parameters.
     *
     * It maps the string "storefront" (used in OCC) to the "baseSite" (used in Spartacus)
     */
    getUrlParams(params) {
        const STOREFRONT_PARAM = 'storefront';
        return (params || []).map((param) => param === STOREFRONT_PARAM ? BASE_SITE_CONTEXT_ID : param);
    }
    /**
     * Returns iso codes in a array, where the first element is the default iso code.
     */
    getIsoCodes(elements, defaultElement) {
        const result = this.moveToFirst(elements, (el) => el.isocode === defaultElement.isocode).map((el) => el.isocode);
        return result;
    }
    /**
     * Moves to the start of the array the first element that satisfies the given predicate.
     *
     * @param array array to modify
     * @param predicate function called on elements
     */
    moveToFirst(array, predicate) {
        array = [...array];
        const index = array.findIndex(predicate);
        if (index !== -1) {
            const [el] = array.splice(index, 1);
            array.unshift(el);
        }
        return array;
    }
    getError(message) {
        return new Error(`Error: Cannot get base site config! ${message}`);
    }
}
OccLoadedConfigConverter.ɵprov = i0.ɵɵdefineInjectable({ factory: function OccLoadedConfigConverter_Factory() { return new OccLoadedConfigConverter(i0.ɵɵinject(i1.JavaRegExpConverter)); }, token: OccLoadedConfigConverter, providedIn: "root" });
OccLoadedConfigConverter.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
OccLoadedConfigConverter.ctorParameters = () => [
    { type: JavaRegExpConverter }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2NjLWxvYWRlZC1jb25maWctY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL1BhdHJ5ay9EZXNrdG9wL3NwYXJ0YWN1cy9wcm9qZWN0cy9jb3JlLyIsInNvdXJjZXMiOlsic3JjL29jYy9jb25maWctbG9hZGVyL29jYy1sb2FkZWQtY29uZmlnLWNvbnZlcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTNDLE9BQU8sRUFDTCxvQkFBb0IsRUFDcEIsbUJBQW1CLEVBQ25CLG1CQUFtQixFQUNuQixnQkFBZ0IsR0FDakIsTUFBTSwwQ0FBMEMsQ0FBQztBQUNsRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwREFBMEQsQ0FBQzs7O0FBSS9GOztHQUVHO0FBQ0gsK0JBQStCO0FBRS9CLE1BQU0sT0FBTyx3QkFBd0I7SUFDbkMsWUFBb0IsbUJBQXdDO1FBQXhDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7SUFBRyxDQUFDO0lBRWhFLGdCQUFnQixDQUNkLFNBQWlDLEVBQ2pDLFVBQWtCO1FBRWxCLE1BQU0sUUFBUSxHQUFHLFNBQVMsYUFBVCxTQUFTLHVCQUFULFNBQVMsQ0FBRSxJQUFJLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUM3QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUN6QyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FDakIsZ0JBQWdCLFVBQVUsNERBQTRELENBQ3ZGLENBQUM7U0FDSDtRQUVELHlIQUF5SDtRQUN6SCxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FDakIs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LFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN6QyxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsRUFBRTtZQUNoQixNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDcEMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNuQjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVPLFFBQVEsQ0FBQyxPQUFlO1FBQzlCLE9BQU8sSUFBSSxLQUFLLENBQUMsdUNBQXVDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDckUsQ0FBQzs7OztZQXhIRixVQUFVLFNBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzs7WUFSekIsbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSTE4bkNvbmZpZyB9IGZyb20gJy4uLy4uL2kxOG4nO1xuaW1wb3J0IHsgQmFzZVNpdGUgfSBmcm9tICcuLi8uLi9tb2RlbC9taXNjLm1vZGVsJztcbmltcG9ydCB7IFNpdGVDb250ZXh0Q29uZmlnIH0gZnJvbSAnLi4vLi4vc2l0ZS1jb250ZXh0L2NvbmZpZy9zaXRlLWNvbnRleHQtY29uZmlnJztcbmltcG9ydCB7XG4gIEJBU0VfU0lURV9DT05URVhUX0lELFxuICBDVVJSRU5DWV9DT05URVhUX0lELFxuICBMQU5HVUFHRV9DT05URVhUX0lELFxuICBUSEVNRV9DT05URVhUX0lELFxufSBmcm9tICcuLi8uLi9zaXRlLWNvbnRleHQvcHJvdmlkZXJzL2NvbnRleHQtaWRzJztcbmltcG9ydCB7IEphdmFSZWdFeHBDb252ZXJ0ZXIgfSBmcm9tICcuLi8uLi91dGlsL2phdmEtcmVnLWV4cC1jb252ZXJ0ZXIvamF2YS1yZWctZXhwLWNvbnZlcnRlcic7XG5pbXBvcnQgeyBPY2MgfSBmcm9tICcuLi9vY2MtbW9kZWxzL29jYy5tb2RlbHMnO1xuaW1wb3J0IHsgT2NjTG9hZGVkQ29uZmlnIH0gZnJvbSAnLi9vY2MtbG9hZGVkLWNvbmZpZyc7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yIC0gdXNlIGBTaXRlQ29udGV4dENvbmZpZ0luaXRpYWxpemVyYCBpbnN0ZWFkXG4gKi9cbi8vIFRPRE8oIzExNTE1KTogZHJvcCBpdCBpbiA0LjBcbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgT2NjTG9hZGVkQ29uZmlnQ29udmVydGVyIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBqYXZhUmVnRXhwQ29udmVydGVyOiBKYXZhUmVnRXhwQ29udmVydGVyKSB7fVxuXG4gIGZyb21PY2NCYXNlU2l0ZXMoXG4gICAgYmFzZVNpdGVzOiBCYXNlU2l0ZVtdIHwgdW5kZWZpbmVkLFxuICAgIGN1cnJlbnRVcmw6IHN0cmluZ1xuICApOiBPY2NMb2FkZWRDb25maWcge1xuICAgIGNvbnN0IGJhc2VTaXRlID0gYmFzZVNpdGVzPy5maW5kKChzaXRlOiBhbnkpID0+XG4gICAgICB0aGlzLmlzQ3VycmVudEJhc2VTaXRlKHNpdGUsIGN1cnJlbnRVcmwpXG4gICAgKTtcbiAgICBpZiAoIWJhc2VTaXRlKSB7XG4gICAgICB0aHJvdyB0aGlzLmdldEVycm9yKFxuICAgICAgICBgQ3VycmVudCB1cmwgKCR7Y3VycmVudFVybH0pIGRvZXNuJ3QgbWF0Y2ggd2l0aCBhbnkgb2YgdXJsIHBhdHRlcm5zIG9mIGFueSBiYXNlIHNpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBBbHRob3VnaCBgc3RvcmVzYCBwcm9wZXJ0eSBpcyBhbiBhcnJheSwgdHlwaWNhbGx5IHRoZXJlIGlzIG9ubHkgb25lIHN0b3JlLiBTbyB3ZSByZXR1cm4gdGhlIGZpcnN0IHN0b3JlIGZyb20gdGhlIGxpc3QuXG4gICAgY29uc3QgYmFzZVN0b3JlID0gYmFzZVNpdGUuc3RvcmVzICYmIGJhc2VTaXRlLnN0b3Jlc1swXTtcbiAgICBpZiAoIWJhc2VTdG9yZSkge1xuICAgICAgdGhyb3cgdGhpcy5nZXRFcnJvcihcbiAgICAgICAgYEN1cnJlbnQgYmFzZSBzaXRlICgke2Jhc2VTaXRlLnVpZH0pIGRvZXNuJ3QgaGF2ZSBhbnkgYmFzZSBzdG9yZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBiYXNlU2l0ZTogYmFzZVNpdGUudWlkLFxuICAgICAgbGFuZ3VhZ2VzOiB0aGlzLmdldElzb0NvZGVzKFxuICAgICAgICBiYXNlU3RvcmUubGFuZ3VhZ2VzLFxuICAgICAgICBiYXNlU2l0ZS5kZWZhdWx0TGFuZ3VhZ2UgfHwgYmFzZVN0b3JlLmRlZmF1bHRMYW5ndWFnZVxuICAgICAgKSxcbiAgICAgIGN1cnJlbmNpZXM6IHRoaXMuZ2V0SXNvQ29kZXMoXG4gICAgICAgIGJhc2VTdG9yZS5jdXJyZW5jaWVzLFxuICAgICAgICBiYXNlU3RvcmUuZGVmYXVsdEN1cnJlbmN5XG4gICAgICApLFxuICAgICAgdXJsUGFyYW1ldGVyczogdGhpcy5nZXRVcmxQYXJhbXMoYmFzZVNpdGUudXJsRW5jb2RpbmdBdHRyaWJ1dGVzKSxcbiAgICAgIHRoZW1lOiBiYXNlU2l0ZS50aGVtZSxcbiAgICB9O1xuICB9XG5cbiAgdG9TaXRlQ29udGV4dENvbmZpZyh7XG4gICAgYmFzZVNpdGUsXG4gICAgbGFuZ3VhZ2VzLFxuICAgIGN1cnJlbmNpZXMsXG4gICAgdXJsUGFyYW1ldGVyczogdXJsRW5jb2RpbmdBdHRyaWJ1dGVzLFxuICAgIHRoZW1lLFxuICB9OiBPY2NMb2FkZWRDb25maWcpOiBTaXRlQ29udGV4dENvbmZpZyB7XG4gICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgY29udGV4dDoge1xuICAgICAgICB1cmxQYXJhbWV0ZXJzOiB1cmxFbmNvZGluZ0F0dHJpYnV0ZXMsXG4gICAgICAgIFtCQVNFX1NJVEVfQ09OVEVYVF9JRF06IFtiYXNlU2l0ZV0sXG4gICAgICAgIFtMQU5HVUFHRV9DT05URVhUX0lEXTogbGFuZ3VhZ2VzLFxuICAgICAgICBbQ1VSUkVOQ1lfQ09OVEVYVF9JRF06IGN1cnJlbmNpZXMsXG4gICAgICAgIFtUSEVNRV9DT05URVhUX0lEXTogW3RoZW1lXSxcbiAgICAgIH0sXG4gICAgfTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgdG9JMThuQ29uZmlnKHsgbGFuZ3VhZ2VzIH06IE9jY0xvYWRlZENvbmZpZyk6IEkxOG5Db25maWcge1xuICAgIHJldHVybiB7IGkxOG46IHsgZmFsbGJhY2tMYW5nOiBsYW5ndWFnZXNbMF0gfSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBpc0N1cnJlbnRCYXNlU2l0ZShzaXRlOiBPY2MuQmFzZVNpdGUsIGN1cnJlbnRVcmw6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGluZGV4ID0gKHNpdGUudXJsUGF0dGVybnMgfHwgW10pLmZpbmRJbmRleCgoamF2YVJlZ2V4cCkgPT4ge1xuICAgICAgY29uc3QganNSZWdleHAgPSB0aGlzLmphdmFSZWdFeHBDb252ZXJ0ZXIudG9Kc1JlZ0V4cChqYXZhUmVnZXhwKTtcbiAgICAgIGlmIChqc1JlZ2V4cCkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBqc1JlZ2V4cC50ZXN0KGN1cnJlbnRVcmwpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGluZGV4ICE9PSAtMTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIHVybCBlbmNvZGVkIHNpdGUgY29udGV4dCBwYXJhbWV0ZXJzLlxuICAgKlxuICAgKiBJdCBtYXBzIHRoZSBzdHJpbmcgXCJzdG9yZWZyb250XCIgKHVzZWQgaW4gT0NDKSB0byB0aGUgXCJiYXNlU2l0ZVwiICh1c2VkIGluIFNwYXJ0YWN1cylcbiAgICovXG4gIHByaXZhdGUgZ2V0VXJsUGFyYW1zKHBhcmFtczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgU1RPUkVGUk9OVF9QQVJBTSA9ICdzdG9yZWZyb250JztcblxuICAgIHJldHVybiAocGFyYW1zIHx8IFtdKS5tYXAoKHBhcmFtKSA9PlxuICAgICAgcGFyYW0gPT09IFNUT1JFRlJPTlRfUEFSQU0gPyBCQVNFX1NJVEVfQ09OVEVYVF9JRCA6IHBhcmFtXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGlzbyBjb2RlcyBpbiBhIGFycmF5LCB3aGVyZSB0aGUgZmlyc3QgZWxlbWVudCBpcyB0aGUgZGVmYXVsdCBpc28gY29kZS5cbiAgICovXG4gIHByaXZhdGUgZ2V0SXNvQ29kZXMoXG4gICAgZWxlbWVudHM6IHsgaXNvY29kZT86IHN0cmluZyB9W10sXG4gICAgZGVmYXVsdEVsZW1lbnQ6IHsgaXNvY29kZT86IHN0cmluZyB9XG4gICkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMubW92ZVRvRmlyc3QoXG4gICAgICBlbGVtZW50cyxcbiAgICAgIChlbCkgPT4gZWwuaXNvY29kZSA9PT0gZGVmYXVsdEVsZW1lbnQuaXNvY29kZVxuICAgICkubWFwKChlbCkgPT4gZWwuaXNvY29kZSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBNb3ZlcyB0byB0aGUgc3RhcnQgb2YgdGhlIGFycmF5IHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgc2F0aXNmaWVzIHRoZSBnaXZlbiBwcmVkaWNhdGUuXG4gICAqXG4gICAqIEBwYXJhbSBhcnJheSBhcnJheSB0byBtb2RpZnlcbiAgICogQHBhcmFtIHByZWRpY2F0ZSBmdW5jdGlvbiBjYWxsZWQgb24gZWxlbWVudHNcbiAgICovXG4gIHByaXZhdGUgbW92ZVRvRmlyc3QoYXJyYXk6IGFueVtdLCBwcmVkaWNhdGU6IChlbDogYW55KSA9PiBib29sZWFuKTogYW55W10ge1xuICAgIGFycmF5ID0gWy4uLmFycmF5XTtcbiAgICBjb25zdCBpbmRleCA9IGFycmF5LmZpbmRJbmRleChwcmVkaWNhdGUpO1xuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgIGNvbnN0IFtlbF0gPSBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgYXJyYXkudW5zaGlmdChlbCk7XG4gICAgfVxuICAgIHJldHVybiBhcnJheTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RXJyb3IobWVzc2FnZTogc3RyaW5nKTogRXJyb3Ige1xuICAgIHJldHVybiBuZXcgRXJyb3IoYEVycm9yOiBDYW5ub3QgZ2V0IGJhc2Ugc2l0ZSBjb25maWchICR7bWVzc2FnZX1gKTtcbiAgfVxufVxuIl19