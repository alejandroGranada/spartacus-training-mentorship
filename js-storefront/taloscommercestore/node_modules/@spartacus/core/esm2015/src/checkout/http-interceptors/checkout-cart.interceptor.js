import { HttpErrorResponse, } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { throwError } from 'rxjs';
import { catchError, switchMap, take } from 'rxjs/operators';
import { MultiCartService } from '../../cart/facade/multi-cart.service';
import { RoutingService } from '../../routing/index';
import * as i0 from "@angular/core";
import * as i1 from "../../routing/facade/routing.service";
import * as i2 from "../../cart/facade/multi-cart.service";
/**
 * Interceptor that handles "Cart not found" errors while a user is in a checkout step.
 *
 * When a user doing a checkout has a "Cart not found" error, he is redirected to checkout and the cart is reloaded.
 * If a "Cart not found" error happens and the user is not on checkout, this interceptor does not perform any actions.
 */
export class CheckoutCartInterceptor {
    constructor(routingService, multiCartService) {
        this.routingService = routingService;
        this.multiCartService = multiCartService;
    }
    intercept(request, next) {
        return this.routingService.getRouterState().pipe(take(1), switchMap((state) => {
            return next.handle(request).pipe(catchError((response) => {
                var _a;
                if (response instanceof HttpErrorResponse &&
                    this.isUserInCheckoutRoute((_a = state.state) === null || _a === void 0 ? void 0 : _a.semanticRoute)) {
                    if (this.isCartNotFoundError(response)) {
                        this.routingService.go({ cxRoute: 'cart' });
                        const cartCode = this.getCartIdFromError(response);
                        if (cartCode) {
                            this.multiCartService.reloadCart(cartCode);
                        }
                    }
                }
                return throwError(response);
            }));
        }));
    }
    /**
     * Returns true if the parameter semantic route is part of "checkout"
     * Checkout semantic routes:
     * checkout
     * checkoutPaymentType
     * CheckoutShippingAddress
     * checkoutDeliveryMode
     * checkoutPaymentDetails
     * checkoutReviewOrder
     * checkoutLogin
     * @param semanticRoute
     */
    isUserInCheckoutRoute(semanticRoute) {
        return semanticRoute === null || semanticRoute === void 0 ? void 0 : semanticRoute.toLowerCase().startsWith('checkout');
    }
    /**
     * Checks of the error is for a cart not found, i.e. the cart doesn't exist anymore
     *
     * @param response
     */
    isCartNotFoundError(response) {
        var _a, _b, _c, _d, _e, _f;
        return (response.status === 400 &&
            ((_c = (_b = (_a = response.error) === null || _a === void 0 ? void 0 : _a.errors) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.type) === 'CartError' &&
            ((_f = (_e = (_d = response.error) === null || _d === void 0 ? void 0 : _d.errors) === null || _e === void 0 ? void 0 : _e[0]) === null || _f === void 0 ? void 0 : _f.reason) === 'notFound');
    }
    getCartIdFromError(response) {
        var _a, _b, _c;
        return (_c = (_b = (_a = response.error) === null || _a === void 0 ? void 0 : _a.errors) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.subject;
    }
}
CheckoutCartInterceptor.ɵprov = i0.ɵɵdefineInjectable({ factory: function CheckoutCartInterceptor_Factory() { return new CheckoutCartInterceptor(i0.ɵɵinject(i1.RoutingService), i0.ɵɵinject(i2.MultiCartService)); }, token: CheckoutCartInterceptor, providedIn: "root" });
CheckoutCartInterceptor.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
CheckoutCartInterceptor.ctorParameters = () => [
    { type: RoutingService },
    { type: MultiCartService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tvdXQtY2FydC5pbnRlcmNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9QYXRyeWsvRGVza3RvcC9zcGFydGFjdXMvcHJvamVjdHMvY29yZS8iLCJzb3VyY2VzIjpbInNyYy9jaGVja291dC9odHRwLWludGVyY2VwdG9ycy9jaGVja291dC1jYXJ0LmludGVyY2VwdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxpQkFBaUIsR0FLbEIsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDeEUsT0FBTyxFQUFlLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBRWxFOzs7OztHQUtHO0FBRUgsTUFBTSxPQUFPLHVCQUF1QjtJQUNsQyxZQUNZLGNBQThCLEVBQzlCLGdCQUFrQztRQURsQyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtJQUMzQyxDQUFDO0lBRUosU0FBUyxDQUNQLE9BQXlCLEVBQ3pCLElBQWlCO1FBRWpCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxJQUFJLENBQzlDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDUCxTQUFTLENBQUMsQ0FBQyxLQUFrQixFQUFFLEVBQUU7WUFDL0IsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDOUIsVUFBVSxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7O2dCQUMzQixJQUNFLFFBQVEsWUFBWSxpQkFBaUI7b0JBQ3JDLElBQUksQ0FBQyxxQkFBcUIsT0FBQyxLQUFLLENBQUMsS0FBSywwQ0FBRSxhQUFhLENBQUMsRUFDdEQ7b0JBQ0EsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLEVBQUU7d0JBQ3RDLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7d0JBRTVDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDbkQsSUFBSSxRQUFRLEVBQUU7NEJBQ1osSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQzt5QkFDNUM7cUJBQ0Y7aUJBQ0Y7Z0JBQ0QsT0FBTyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDOUIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7Ozs7Ozs7O09BV0c7SUFDTyxxQkFBcUIsQ0FBQyxhQUFxQjtRQUNuRCxPQUFPLGFBQWEsYUFBYixhQUFhLHVCQUFiLGFBQWEsQ0FBRSxXQUFXLEdBQUcsVUFBVSxDQUFDLFVBQVUsRUFBRTtJQUM3RCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNPLG1CQUFtQixDQUFDLFFBQTJCOztRQUN2RCxPQUFPLENBQ0wsUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHO1lBQ3ZCLG1CQUFBLFFBQVEsQ0FBQyxLQUFLLDBDQUFFLE1BQU0sMENBQUcsQ0FBQywyQ0FBRyxJQUFJLE1BQUssV0FBVztZQUNqRCxtQkFBQSxRQUFRLENBQUMsS0FBSywwQ0FBRSxNQUFNLDBDQUFHLENBQUMsMkNBQUcsTUFBTSxNQUFLLFVBQVUsQ0FDbkQsQ0FBQztJQUNKLENBQUM7SUFFUyxrQkFBa0IsQ0FBQyxRQUEyQjs7UUFDdEQseUJBQU8sUUFBUSxDQUFDLEtBQUssMENBQUUsTUFBTSwwQ0FBRyxDQUFDLDJDQUFHLE9BQU8sQ0FBQztJQUM5QyxDQUFDOzs7O1lBbkVGLFVBQVUsU0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUU7OztZQVJaLGNBQWM7WUFEM0IsZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSHR0cEVycm9yUmVzcG9uc2UsXG4gIEh0dHBFdmVudCxcbiAgSHR0cEhhbmRsZXIsXG4gIEh0dHBJbnRlcmNlcHRvcixcbiAgSHR0cFJlcXVlc3QsXG59IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHN3aXRjaE1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE11bHRpQ2FydFNlcnZpY2UgfSBmcm9tICcuLi8uLi9jYXJ0L2ZhY2FkZS9tdWx0aS1jYXJ0LnNlcnZpY2UnO1xuaW1wb3J0IHsgUm91dGVyU3RhdGUsIFJvdXRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vcm91dGluZy9pbmRleCc7XG5cbi8qKlxuICogSW50ZXJjZXB0b3IgdGhhdCBoYW5kbGVzIFwiQ2FydCBub3QgZm91bmRcIiBlcnJvcnMgd2hpbGUgYSB1c2VyIGlzIGluIGEgY2hlY2tvdXQgc3RlcC5cbiAqXG4gKiBXaGVuIGEgdXNlciBkb2luZyBhIGNoZWNrb3V0IGhhcyBhIFwiQ2FydCBub3QgZm91bmRcIiBlcnJvciwgaGUgaXMgcmVkaXJlY3RlZCB0byBjaGVja291dCBhbmQgdGhlIGNhcnQgaXMgcmVsb2FkZWQuXG4gKiBJZiBhIFwiQ2FydCBub3QgZm91bmRcIiBlcnJvciBoYXBwZW5zIGFuZCB0aGUgdXNlciBpcyBub3Qgb24gY2hlY2tvdXQsIHRoaXMgaW50ZXJjZXB0b3IgZG9lcyBub3QgcGVyZm9ybSBhbnkgYWN0aW9ucy5cbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBDaGVja291dENhcnRJbnRlcmNlcHRvciBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCByb3V0aW5nU2VydmljZTogUm91dGluZ1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIG11bHRpQ2FydFNlcnZpY2U6IE11bHRpQ2FydFNlcnZpY2VcbiAgKSB7fVxuXG4gIGludGVyY2VwdChcbiAgICByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LFxuICAgIG5leHQ6IEh0dHBIYW5kbGVyXG4gICk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICByZXR1cm4gdGhpcy5yb3V0aW5nU2VydmljZS5nZXRSb3V0ZXJTdGF0ZSgpLnBpcGUoXG4gICAgICB0YWtlKDEpLFxuICAgICAgc3dpdGNoTWFwKChzdGF0ZTogUm91dGVyU3RhdGUpID0+IHtcbiAgICAgICAgcmV0dXJuIG5leHQuaGFuZGxlKHJlcXVlc3QpLnBpcGUoXG4gICAgICAgICAgY2F0Y2hFcnJvcigocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICByZXNwb25zZSBpbnN0YW5jZW9mIEh0dHBFcnJvclJlc3BvbnNlICYmXG4gICAgICAgICAgICAgIHRoaXMuaXNVc2VySW5DaGVja291dFJvdXRlKHN0YXRlLnN0YXRlPy5zZW1hbnRpY1JvdXRlKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIGlmICh0aGlzLmlzQ2FydE5vdEZvdW5kRXJyb3IocmVzcG9uc2UpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3V0aW5nU2VydmljZS5nbyh7IGN4Um91dGU6ICdjYXJ0JyB9KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGNhcnRDb2RlID0gdGhpcy5nZXRDYXJ0SWRGcm9tRXJyb3IocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIGlmIChjYXJ0Q29kZSkge1xuICAgICAgICAgICAgICAgICAgdGhpcy5tdWx0aUNhcnRTZXJ2aWNlLnJlbG9hZENhcnQoY2FydENvZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IocmVzcG9uc2UpO1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXJhbWV0ZXIgc2VtYW50aWMgcm91dGUgaXMgcGFydCBvZiBcImNoZWNrb3V0XCJcbiAgICogQ2hlY2tvdXQgc2VtYW50aWMgcm91dGVzOlxuICAgKiBjaGVja291dFxuICAgKiBjaGVja291dFBheW1lbnRUeXBlXG4gICAqIENoZWNrb3V0U2hpcHBpbmdBZGRyZXNzXG4gICAqIGNoZWNrb3V0RGVsaXZlcnlNb2RlXG4gICAqIGNoZWNrb3V0UGF5bWVudERldGFpbHNcbiAgICogY2hlY2tvdXRSZXZpZXdPcmRlclxuICAgKiBjaGVja291dExvZ2luXG4gICAqIEBwYXJhbSBzZW1hbnRpY1JvdXRlXG4gICAqL1xuICBwcm90ZWN0ZWQgaXNVc2VySW5DaGVja291dFJvdXRlKHNlbWFudGljUm91dGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzZW1hbnRpY1JvdXRlPy50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoJ2NoZWNrb3V0Jyk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIG9mIHRoZSBlcnJvciBpcyBmb3IgYSBjYXJ0IG5vdCBmb3VuZCwgaS5lLiB0aGUgY2FydCBkb2Vzbid0IGV4aXN0IGFueW1vcmVcbiAgICpcbiAgICogQHBhcmFtIHJlc3BvbnNlXG4gICAqL1xuICBwcm90ZWN0ZWQgaXNDYXJ0Tm90Rm91bmRFcnJvcihyZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgcmVzcG9uc2Uuc3RhdHVzID09PSA0MDAgJiZcbiAgICAgIHJlc3BvbnNlLmVycm9yPy5lcnJvcnM/LlswXT8udHlwZSA9PT0gJ0NhcnRFcnJvcicgJiZcbiAgICAgIHJlc3BvbnNlLmVycm9yPy5lcnJvcnM/LlswXT8ucmVhc29uID09PSAnbm90Rm91bmQnXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDYXJ0SWRGcm9tRXJyb3IocmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcmVzcG9uc2UuZXJyb3I/LmVycm9ycz8uWzBdPy5zdWJqZWN0O1xuICB9XG59XG4iXX0=