import { Injectable } from '@angular/core';
import { BehaviorSubject, EMPTY, iif, isObservable, merge, of, Subscription, using, } from 'rxjs';
import { catchError, distinctUntilChanged, filter, pluck, share, switchMapTo, takeUntil, tap, } from 'rxjs/operators';
import { EventService } from '../../event/event.service';
import * as i0 from "@angular/core";
import * as i1 from "../../event/event.service";
export class QueryService {
    constructor(eventService) {
        this.eventService = eventService;
        this.subscriptions = new Subscription();
    }
    create(loaderFactory, options) {
        var _a, _b, _c;
        const state$ = new BehaviorSubject({
            data: undefined,
            error: false,
            loading: false,
        });
        // if query will be unsubscribed when data is loaded, we will end up with loading flag set to true
        // we want to retry this load on next subscription
        const retryInterruptedLoad$ = iif(() => state$.value.loading, of(undefined));
        const loadTrigger$ = this.getTriggersStream([
            state$.pipe(filter(({ data, loading, error }) => data === undefined && !loading && !error)),
            ...((_a = options === null || options === void 0 ? void 0 : options.reloadOn) !== null && _a !== void 0 ? _a : []),
            retryInterruptedLoad$,
        ]);
        const resetTrigger$ = this.getTriggersStream((_b = options === null || options === void 0 ? void 0 : options.resetOn) !== null && _b !== void 0 ? _b : []);
        const load$ = loadTrigger$.pipe(tap(() => state$.next(Object.assign(Object.assign({}, state$.value), { loading: true }))), switchMapTo(loaderFactory().pipe(takeUntil(resetTrigger$))), tap((data) => {
            state$.next({ loading: false, error: false, data });
        }), catchError((error) => {
            state$.next({ loading: false, error, data: undefined });
            return EMPTY;
        }), share());
        // reset logic
        if ((_c = options === null || options === void 0 ? void 0 : options.resetOn) === null || _c === void 0 ? void 0 : _c.length) {
            this.subscriptions.add(resetTrigger$.subscribe(() => {
                if (state$.value.data !== undefined ||
                    state$.value.error !== false ||
                    state$.value.loading !== false) {
                    state$.next({
                        data: undefined,
                        error: false,
                        loading: false,
                    });
                }
            }));
        }
        const query$ = using(() => load$.subscribe(), () => state$);
        const data$ = query$.pipe(pluck('data'), distinctUntilChanged());
        return { get: () => data$, getState: () => query$ };
    }
    getTriggersStream(triggers) {
        if (!triggers.length) {
            return EMPTY;
        }
        const observables = triggers.map((trigger) => {
            if (isObservable(trigger)) {
                return trigger;
            }
            return this.eventService.get(trigger);
        });
        return merge(...observables);
    }
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
}
QueryService.ɵprov = i0.ɵɵdefineInjectable({ factory: function QueryService_Factory() { return new QueryService(i0.ɵɵinject(i1.EventService)); }, token: QueryService, providedIn: "root" });
QueryService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
QueryService.ctorParameters = () => [
    { type: EventService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9QYXRyeWsvRGVza3RvcC9zcGFydGFjdXMvcHJvamVjdHMvY29yZS8iLCJzb3VyY2VzIjpbInNyYy91dGlsL2NvbW1hbmQtcXVlcnkvcXVlcnkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFtQixNQUFNLGVBQWUsQ0FBQztBQUM1RCxPQUFPLEVBQ0wsZUFBZSxFQUNmLEtBQUssRUFDTCxHQUFHLEVBQ0gsWUFBWSxFQUNaLEtBQUssRUFFTCxFQUFFLEVBQ0YsWUFBWSxFQUNaLEtBQUssR0FDTixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFDTCxVQUFVLEVBQ1Ysb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixLQUFLLEVBQ0wsS0FBSyxFQUNMLFdBQVcsRUFDWCxTQUFTLEVBQ1QsR0FBRyxHQUNKLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDOzs7QUFtQnpELE1BQU0sT0FBTyxZQUFZO0lBR3ZCLFlBQXNCLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBRnRDLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztJQUVNLENBQUM7SUFFcEQsTUFBTSxDQUNKLGFBQWtDLEVBQ2xDLE9BR0M7O1FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxlQUFlLENBQWdCO1lBQ2hELElBQUksRUFBRSxTQUFTO1lBQ2YsS0FBSyxFQUFFLEtBQUs7WUFDWixPQUFPLEVBQUUsS0FBSztTQUNmLENBQUMsQ0FBQztRQUVILGtHQUFrRztRQUNsRyxrREFBa0Q7UUFDbEQsTUFBTSxxQkFBcUIsR0FBRyxHQUFHLENBQy9CLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUMxQixFQUFFLENBQUMsU0FBUyxDQUFDLENBQ2QsQ0FBQztRQUVGLE1BQU0sWUFB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T0FBTyxPQUFPLENBQUM7YUFDaEI7WUFDRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxLQUFLLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbkMsQ0FBQzs7OztZQWpHRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQWxCUSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25EZXN0cm95LCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBCZWhhdmlvclN1YmplY3QsXG4gIEVNUFRZLFxuICBpaWYsXG4gIGlzT2JzZXJ2YWJsZSxcbiAgbWVyZ2UsXG4gIE9ic2VydmFibGUsXG4gIG9mLFxuICBTdWJzY3JpcHRpb24sXG4gIHVzaW5nLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGNhdGNoRXJyb3IsXG4gIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxuICBmaWx0ZXIsXG4gIHBsdWNrLFxuICBzaGFyZSxcbiAgc3dpdGNoTWFwVG8sXG4gIHRha2VVbnRpbCxcbiAgdGFwLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBFdmVudFNlcnZpY2UgfSBmcm9tICcuLi8uLi9ldmVudC9ldmVudC5zZXJ2aWNlJztcbmltcG9ydCB7IEN4RXZlbnQgfSBmcm9tICcuLi8uLi9ldmVudC9jeC1ldmVudCc7XG5cbmV4cG9ydCB0eXBlIFF1ZXJ5Tm90aWZpZXIgPSBPYnNlcnZhYmxlPGFueT4gfCBUeXBlPEN4RXZlbnQ+O1xuXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5U3RhdGU8VD4ge1xuICBsb2FkaW5nOiBib29sZWFuO1xuICBlcnJvcjogZmFsc2UgfCBFcnJvcjtcbiAgZGF0YTogVCB8IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBRdWVyeTxULCBQIGV4dGVuZHMgYW55W10gPSBbXT4ge1xuICBnZXQoLi4ucGFyYW1zOiBQKTogT2JzZXJ2YWJsZTxUIHwgdW5kZWZpbmVkPjtcbiAgZ2V0U3RhdGUoLi4ucGFyYW1zOiBQKTogT2JzZXJ2YWJsZTxRdWVyeVN0YXRlPFQ+Pjtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFF1ZXJ5U2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHByb3RlY3RlZCBzdWJzY3JpcHRpb25zID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBldmVudFNlcnZpY2U6IEV2ZW50U2VydmljZSkge31cblxuICBjcmVhdGU8VD4oXG4gICAgbG9hZGVyRmFjdG9yeTogKCkgPT4gT2JzZXJ2YWJsZTxUPixcbiAgICBvcHRpb25zPzoge1xuICAgICAgcmVsb2FkT24/OiBRdWVyeU5vdGlmaWVyW107XG4gICAgICByZXNldE9uPzogUXVlcnlOb3RpZmllcltdO1xuICAgIH1cbiAgKTogUXVlcnk8VD4ge1xuICAgIGNvbnN0IHN0YXRlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UXVlcnlTdGF0ZTxUPj4oe1xuICAgICAgZGF0YTogdW5kZWZpbmVkLFxuICAgICAgZXJyb3I6IGZhbHNlLFxuICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgfSk7XG5cbiAgICAvLyBpZiBxdWVyeSB3aWxsIGJlIHVuc3Vic2NyaWJlZCB3aGVuIGRhdGEgaXMgbG9hZGVkLCB3ZSB3aWxsIGVuZCB1cCB3aXRoIGxvYWRpbmcgZmxhZyBzZXQgdG8gdHJ1ZVxuICAgIC8vIHdlIHdhbnQgdG8gcmV0cnkgdGhpcyBsb2FkIG9uIG5leHQgc3Vic2NyaXB0aW9uXG4gICAgY29uc3QgcmV0cnlJbnRlcnJ1cHRlZExvYWQkID0gaWlmKFxuICAgICAgKCkgPT4gc3RhdGUkLnZhbHVlLmxvYWRpbmcsXG4gICAgICBvZih1bmRlZmluZWQpXG4gICAgKTtcblxuICAgIGNvbnN0IGxvYWRUcmlnZ2VyJCA9IHRoaXMuZ2V0VHJpZ2dlcnNTdHJlYW0oW1xuICAgICAgc3RhdGUkLnBpcGUoXG4gICAgICAgIGZpbHRlcihcbiAgICAgICAgICAoeyBkYXRhLCBsb2FkaW5nLCBlcnJvciB9KSA9PiBkYXRhID09PSB1bmRlZmluZWQgJiYgIWxvYWRpbmcgJiYgIWVycm9yXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICAuLi4ob3B0aW9ucz8ucmVsb2FkT24gPz8gW10pLFxuICAgICAgcmV0cnlJbnRlcnJ1cHRlZExvYWQkLFxuICAgIF0pO1xuXG4gICAgY29uc3QgcmVzZXRUcmlnZ2VyJCA9IHRoaXMuZ2V0VHJpZ2dlcnNTdHJlYW0ob3B0aW9ucz8ucmVzZXRPbiA/PyBbXSk7XG5cbiAgICBjb25zdCBsb2FkJCA9IGxvYWRUcmlnZ2VyJC5waXBlKFxuICAgICAgdGFwKCgpID0+IHN0YXRlJC5uZXh0KHsgLi4uc3RhdGUkLnZhbHVlLCBsb2FkaW5nOiB0cnVlIH0pKSxcbiAgICAgIHN3aXRjaE1hcFRvKGxvYWRlckZhY3RvcnkoKS5waXBlKHRha2VVbnRpbChyZXNldFRyaWdnZXIkKSkpLFxuICAgICAgdGFwKChkYXRhKSA9PiB7XG4gICAgICAgIHN0YXRlJC5uZXh0KHsgbG9hZGluZzogZmFsc2UsIGVycm9yOiBmYWxzZSwgZGF0YSB9KTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgICAgc3RhdGUkLm5leHQoeyBsb2FkaW5nOiBmYWxzZSwgZXJyb3IsIGRhdGE6IHVuZGVmaW5lZCB9KTtcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgfSksXG4gICAgICBzaGFyZSgpXG4gICAgKTtcblxuICAgIC8vIHJlc2V0IGxvZ2ljXG4gICAgaWYgKG9wdGlvbnM/LnJlc2V0T24/Lmxlbmd0aCkge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgICAgcmVzZXRUcmlnZ2VyJC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHN0YXRlJC52YWx1ZS5kYXRhICE9PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgIHN0YXRlJC52YWx1ZS5lcnJvciAhPT0gZmFsc2UgfHxcbiAgICAgICAgICAgIHN0YXRlJC52YWx1ZS5sb2FkaW5nICE9PSBmYWxzZVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgc3RhdGUkLm5leHQoe1xuICAgICAgICAgICAgICBkYXRhOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgIGVycm9yOiBmYWxzZSxcbiAgICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHF1ZXJ5JCA9IHVzaW5nKFxuICAgICAgKCkgPT4gbG9hZCQuc3Vic2NyaWJlKCksXG4gICAgICAoKSA9PiBzdGF0ZSRcbiAgICApO1xuXG4gICAgY29uc3QgZGF0YSQgPSBxdWVyeSQucGlwZShwbHVjaygnZGF0YScpLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcblxuICAgIHJldHVybiB7IGdldDogKCkgPT4gZGF0YSQsIGdldFN0YXRlOiAoKSA9PiBxdWVyeSQgfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRUcmlnZ2Vyc1N0cmVhbSh0cmlnZ2VyczogUXVlcnlOb3RpZmllcltdKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAoIXRyaWdnZXJzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBvYnNlcnZhYmxlcyA9IHRyaWdnZXJzLm1hcCgodHJpZ2dlcikgPT4ge1xuICAgICAgaWYgKGlzT2JzZXJ2YWJsZSh0cmlnZ2VyKSkge1xuICAgICAgICByZXR1cm4gdHJpZ2dlcjtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLmV2ZW50U2VydmljZS5nZXQodHJpZ2dlcik7XG4gICAgfSk7XG4gICAgcmV0dXJuIG1lcmdlKC4uLm9ic2VydmFibGVzKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=