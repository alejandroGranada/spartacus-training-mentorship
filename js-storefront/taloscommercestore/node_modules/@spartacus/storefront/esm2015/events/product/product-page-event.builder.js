import { Injectable } from '@angular/core';
import { createFrom, EventService, FeatureConfigService, ProductSearchService, ProductService, } from '@spartacus/core';
import { EMPTY } from 'rxjs';
import { filter, map, skip, switchMap, take } from 'rxjs/operators';
import { NavigationEvent } from '../navigation/navigation.event';
import { CategoryPageResultsEvent, ProductDetailsPageEvent, SearchPageResultsEvent, } from './product-page.events';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
export class ProductPageEventBuilder {
    constructor(eventService, productService, productSearchService, 
    // TODO: #10896 - remove this
    /** @deprecated @since 3.1 - this will be removed in 4.0 */ featureConfigService) {
        this.eventService = eventService;
        this.productService = productService;
        this.productSearchService = productSearchService;
        this.featureConfigService = featureConfigService;
        this.register();
    }
    register() {
        this.eventService.register(SearchPageResultsEvent, this.buildSearchPageResultsEvent());
        this.eventService.register(ProductDetailsPageEvent, this.buildProductDetailsPageEvent());
        this.eventService.register(CategoryPageResultsEvent, this.buildCategoryResultsPageEvent());
    }
    buildProductDetailsPageEvent() {
        return this.eventService.get(NavigationEvent).pipe(filter((navigationEvent) => navigationEvent.semanticRoute === 'product'), switchMap((navigationEvent) => this.productService.get(navigationEvent.context.id).pipe(filter((product) => Boolean(product)), take(1), map((product) => createFrom(ProductDetailsPageEvent, Object.assign(Object.assign({}, this.createDeprecatedPageEvent(navigationEvent)), { navigation: Object.assign({}, navigationEvent), categories: product.categories, code: product.code, name: product.name, price: product.price }))))));
    }
    buildCategoryResultsPageEvent() {
        const searchResults$ = this.productSearchService.getResults().pipe(
        // skipping the initial value, and preventing emission of the previous search state
        skip(1));
        return this.eventService.get(NavigationEvent).pipe(switchMap((navigationEvent) => {
            if ((navigationEvent === null || navigationEvent === void 0 ? void 0 : navigationEvent.semanticRoute) !== 'category') {
                return EMPTY;
            }
            return searchResults$.pipe(map((searchResults) => {
                var _a, _b, _c;
                return createFrom(CategoryPageResultsEvent, Object.assign(Object.assign(Object.assign({}, this.createDeprecatedPageEvent(navigationEvent)), { navigation: Object.assign({}, navigationEvent) }), {
                    categoryCode: (_a = navigationEvent === null || navigationEvent === void 0 ? void 0 : navigationEvent.context) === null || _a === void 0 ? void 0 : _a.id,
                    numberOfResults: (_b = searchResults === null || searchResults === void 0 ? void 0 : searchResults.pagination) === null || _b === void 0 ? void 0 : _b.totalResults,
                    categoryName: (_c = searchResults.breadcrumbs) === null || _c === void 0 ? void 0 : _c[0].facetValueName,
                }));
            }));
        }));
    }
    buildSearchPageResultsEvent() {
        const searchResults$ = this.productSearchService.getResults().pipe(
        // skipping the initial value, and preventing emission of the previous search state
        skip(1));
        return this.eventService.get(NavigationEvent).pipe(switchMap((navigationEvent) => {
            if ((navigationEvent === null || navigationEvent === void 0 ? void 0 : navigationEvent.semanticRoute) !== 'search') {
                return EMPTY;
            }
            return searchResults$.pipe(map((searchResults) => {
                var _a;
                return createFrom(SearchPageResultsEvent, Object.assign(Object.assign(Object.assign({}, this.createDeprecatedPageEvent(navigationEvent)), { navigation: Object.assign({}, navigationEvent) }), {
                    searchTerm: searchResults === null || searchResults === void 0 ? void 0 : searchResults.freeTextSearch,
                    numberOfResults: (_a = searchResults === null || searchResults === void 0 ? void 0 : searchResults.pagination) === null || _a === void 0 ? void 0 : _a.totalResults,
                }));
            }));
        }));
    }
    // TODO: #10896 - remove this method
    createDeprecatedPageEvent(navigationEvent) {
        if (!this.featureConfigService ||
            this.featureConfigService.isLevel('!3.1')) {
            return Object.assign({}, navigationEvent);
        }
        return undefined;
    }
}
ProductPageEventBuilder.ɵprov = i0.ɵɵdefineInjectable({ factory: function ProductPageEventBuilder_Factory() { return new ProductPageEventBuilder(i0.ɵɵinject(i1.EventService), i0.ɵɵinject(i1.ProductService), i0.ɵɵinject(i1.ProductSearchService), i0.ɵɵinject(i1.FeatureConfigService)); }, token: ProductPageEventBuilder, providedIn: "root" });
ProductPageEventBuilder.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
ProductPageEventBuilder.ctorParameters = () => [
    { type: EventService },
    { type: ProductService },
    { type: ProductSearchService },
    { type: FeatureConfigService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZHVjdC1wYWdlLWV2ZW50LmJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvUGF0cnlrL0Rlc2t0b3Avc3BhcnRhY3VzL3Byb2plY3RzL3N0b3JlZnJvbnRsaWIvc3JjLyIsInNvdXJjZXMiOlsiZXZlbnRzL3Byb2R1Y3QvcHJvZHVjdC1wYWdlLWV2ZW50LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsVUFBVSxFQUNWLFlBQVksRUFDWixvQkFBb0IsRUFDcEIsb0JBQW9CLEVBQ3BCLGNBQWMsR0FDZixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxLQUFLLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekMsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFakUsT0FBTyxFQUNMLHdCQUF3QixFQUN4Qix1QkFBdUIsRUFDdkIsc0JBQXNCLEdBQ3ZCLE1BQU0sdUJBQXVCLENBQUM7OztBQUsvQixNQUFNLE9BQU8sdUJBQXVCO0lBQ2xDLFlBQ1ksWUFBMEIsRUFDMUIsY0FBOEIsRUFDOUIsb0JBQTBDO0lBQ3BELDZCQUE2QjtJQUM3QiwyREFBMkQsQ0FBVyxvQkFBMkM7UUFKdkcsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFFa0IseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF1QjtRQUVqSCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUVTLFFBQVE7UUFDaEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQ3hCLHNCQUFzQixF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QUEsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLGFBQWEsTUFBSyxRQUFRLEVBQUU7Z0JBQy9DLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFFRCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQ3hCLEdBQUcsQ0FBQyxDQUFDLGFBQWEsRUFBRSxFQUFFOztnQkFDcEIsT0FBQSxVQUFVLENBQUMsc0JBQXNCLGdEQUM1QixJQUFJLENBQUMseUJBQXlCLENBQUMsZUFBZSxDQUFDLEtBQ2xELFVBQVUsb0JBQU8sZUFBZSxNQUM3QjtvQkFDRCxVQUFVLEVBQUUsYUFBYSxhQUFiLGFBQWEsdUJBQWIsYUFBYSxDQUFFLGNBQWM7b0JBQ3pDLGVBQWUsUUFBRSxhQUFhLGFBQWIsYUFBYSx1QkFBYixhQUFhLENBQUUsVUFBVSwwQ0FBRSxZQUFZO2lCQUN6RCxFQUNELENBQUE7YUFBQSxDQUNILENBQ0YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQsb0NBQW9DO0lBQzVCLHlCQUF5QixDQUMvQixlQUFnQztRQUVoQyxJQUNFLENBQUMsSUFBSSxDQUFDLG9CQUFvQjtZQUMxQixJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUN6QztZQUNBLHlCQUFZLGVBQWUsRUFBRztTQUMvQjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Ozs7WUF2SEYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUFqQkMsWUFBWTtZQUdaLGNBQWM7WUFEZCxvQkFBb0I7WUFEcEIsb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgY3JlYXRlRnJvbSxcbiAgRXZlbnRTZXJ2aWNlLFxuICBGZWF0dXJlQ29uZmlnU2VydmljZSxcbiAgUHJvZHVjdFNlYXJjaFNlcnZpY2UsXG4gIFByb2R1Y3RTZXJ2aWNlLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBza2lwLCBzd2l0Y2hNYXAsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uRXZlbnQgfSBmcm9tICcuLi9uYXZpZ2F0aW9uL25hdmlnYXRpb24uZXZlbnQnO1xuaW1wb3J0IHsgUGFnZUV2ZW50IH0gZnJvbSAnLi4vcGFnZS9wYWdlLmV2ZW50cyc7XG5pbXBvcnQge1xuICBDYXRlZ29yeVBhZ2VSZXN1bHRzRXZlbnQsXG4gIFByb2R1Y3REZXRhaWxzUGFnZUV2ZW50LFxuICBTZWFyY2hQYWdlUmVzdWx0c0V2ZW50LFxufSBmcm9tICcuL3Byb2R1Y3QtcGFnZS5ldmVudHMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgUHJvZHVjdFBhZ2VFdmVudEJ1aWxkZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgZXZlbnRTZXJ2aWNlOiBFdmVudFNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHByb2R1Y3RTZXJ2aWNlOiBQcm9kdWN0U2VydmljZSxcbiAgICBwcm90ZWN0ZWQgcHJvZHVjdFNlYXJjaFNlcnZpY2U6IFByb2R1Y3RTZWFyY2hTZXJ2aWNlLFxuICAgIC8vIFRPRE86ICMxMDg5NiAtIHJlbW92ZSB0aGlzXG4gICAgLyoqIEBkZXByZWNhdGVkIEBzaW5jZSAzLjEgLSB0aGlzIHdpbGwgYmUgcmVtb3ZlZCBpbiA0LjAgKi8gcHJvdGVjdGVkIGZlYXR1cmVDb25maWdTZXJ2aWNlPzogRmVhdHVyZUNvbmZpZ1NlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5yZWdpc3RlcigpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHJlZ2lzdGVyKCk6IHZvaWQge1xuICAgIHRoaXMuZXZlbnRTZXJ2aWNlLnJlZ2lzdGVyKFxuICAgICAgU2VhcmNoUGFnZVJlc3VsdHNFdmVudCxcbiAgICAgIHRoaXMuYnVpbGRTZWFyY2hQYWdlUmVzdWx0c0V2ZW50KClcbiAgICApO1xuICAgIHRoaXMuZXZlbnRTZXJ2aWNlLnJlZ2lzdGVyKFxuICAgICAgUHJvZHVjdERldGFpbHNQYWdlRXZlbnQsXG4gICAgICB0aGlzLmJ1aWxkUHJvZHVjdERldGFpbHNQYWdlRXZlbnQoKVxuICAgICk7XG4gICAgdGhpcy5ldmVudFNlcnZpY2UucmVnaXN0ZXIoXG4gICAgICBDYXRlZ29yeVBhZ2VSZXN1bHRzRXZlbnQsXG4gICAgICB0aGlzLmJ1aWxkQ2F0ZWdvcnlSZXN1bHRzUGFnZUV2ZW50KClcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGJ1aWxkUHJvZHVjdERldGFpbHNQYWdlRXZlbnQoKTogT2JzZXJ2YWJsZTxQcm9kdWN0RGV0YWlsc1BhZ2VFdmVudD4ge1xuICAgIHJldHVybiB0aGlzLmV2ZW50U2VydmljZS5nZXQoTmF2aWdhdGlvbkV2ZW50KS5waXBlKFxuICAgICAgZmlsdGVyKChuYXZpZ2F0aW9uRXZlbnQpID0+IG5hdmlnYXRpb25FdmVudC5zZW1hbnRpY1JvdXRlID09PSAncHJvZHVjdCcpLFxuICAgICAgc3dpdGNoTWFwKChuYXZpZ2F0aW9uRXZlbnQpID0+XG4gICAgICAgIHRoaXMucHJvZHVjdFNlcnZpY2UuZ2V0KG5hdmlnYXRpb25FdmVudC5jb250ZXh0LmlkKS5waXBlKFxuICAgICAgICAgIGZpbHRlcigocHJvZHVjdCkgPT4gQm9vbGVhbihwcm9kdWN0KSksXG4gICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICBtYXAoKHByb2R1Y3QpID0+XG4gICAgICAgICAgICBjcmVhdGVGcm9tKFByb2R1Y3REZXRhaWxzUGFnZUV2ZW50LCB7XG4gICAgICAgICAgICAgIC4uLnRoaXMuY3JlYXRlRGVwcmVjYXRlZFBhZ2VFdmVudChuYXZpZ2F0aW9uRXZlbnQpLFxuICAgICAgICAgICAgICBuYXZpZ2F0aW9uOiB7IC4uLm5hdmlnYXRpb25FdmVudCB9LFxuICAgICAgICAgICAgICBjYXRlZ29yaWVzOiBwcm9kdWN0LmNhdGVnb3JpZXMsXG4gICAgICAgICAgICAgIGNvZGU6IHByb2R1Y3QuY29kZSxcbiAgICAgICAgICAgICAgbmFtZTogcHJvZHVjdC5uYW1lLFxuICAgICAgICAgICAgICBwcmljZTogcHJvZHVjdC5wcmljZSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBidWlsZENhdGVnb3J5UmVzdWx0c1BhZ2VFdmVudCgpOiBPYnNlcnZhYmxlPENhdGVnb3J5UGFnZVJlc3VsdHNFdmVudD4ge1xuICAgIGNvbnN0IHNlYXJjaFJlc3VsdHMkID0gdGhpcy5wcm9kdWN0U2VhcmNoU2VydmljZS5nZXRSZXN1bHRzKCkucGlwZShcbiAgICAgIC8vIHNraXBwaW5nIHRoZSBpbml0aWFsIHZhbHVlLCBhbmQgcHJldmVudGluZyBlbWlzc2lvbiBvZiB0aGUgcHJldmlvdXMgc2VhcmNoIHN0YXRlXG4gICAgICBza2lwKDEpXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmV2ZW50U2VydmljZS5nZXQoTmF2aWdhdGlvbkV2ZW50KS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChuYXZpZ2F0aW9uRXZlbnQpID0+IHtcbiAgICAgICAgaWYgKG5hdmlnYXRpb25FdmVudD8uc2VtYW50aWNSb3V0ZSAhPT0gJ2NhdGVnb3J5Jykge1xuICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzZWFyY2hSZXN1bHRzJC5waXBlKFxuICAgICAgICAgIG1hcCgoc2VhcmNoUmVzdWx0cykgPT5cbiAgICAgICAgICAgIGNyZWF0ZUZyb20oQ2F0ZWdvcnlQYWdlUmVzdWx0c0V2ZW50LCB7XG4gICAgICAgICAgICAgIC4uLnRoaXMuY3JlYXRlRGVwcmVjYXRlZFBhZ2VFdmVudChuYXZpZ2F0aW9uRXZlbnQpLFxuICAgICAgICAgICAgICBuYXZpZ2F0aW9uOiB7IC4uLm5hdmlnYXRpb25FdmVudCB9LFxuICAgICAgICAgICAgICAuLi57XG4gICAgICAgICAgICAgICAgY2F0ZWdvcnlDb2RlOiBuYXZpZ2F0aW9uRXZlbnQ/LmNvbnRleHQ/LmlkLFxuICAgICAgICAgICAgICAgIG51bWJlck9mUmVzdWx0czogc2VhcmNoUmVzdWx0cz8ucGFnaW5hdGlvbj8udG90YWxSZXN1bHRzLFxuICAgICAgICAgICAgICAgIGNhdGVnb3J5TmFtZTogc2VhcmNoUmVzdWx0cy5icmVhZGNydW1icz8uWzBdLmZhY2V0VmFsdWVOYW1lLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYnVpbGRTZWFyY2hQYWdlUmVzdWx0c0V2ZW50KCk6IE9ic2VydmFibGU8U2VhcmNoUGFnZVJlc3VsdHNFdmVudD4ge1xuICAgIGNvbnN0IHNlYXJjaFJlc3VsdHMkID0gdGhpcy5wcm9kdWN0U2VhcmNoU2VydmljZS5nZXRSZXN1bHRzKCkucGlwZShcbiAgICAgIC8vIHNraXBwaW5nIHRoZSBpbml0aWFsIHZhbHVlLCBhbmQgcHJldmVudGluZyBlbWlzc2lvbiBvZiB0aGUgcHJldmlvdXMgc2VhcmNoIHN0YXRlXG4gICAgICBza2lwKDEpXG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmV2ZW50U2VydmljZS5nZXQoTmF2aWdhdGlvbkV2ZW50KS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChuYXZpZ2F0aW9uRXZlbnQpID0+IHtcbiAgICAgICAgaWYgKG5hdmlnYXRpb25FdmVudD8uc2VtYW50aWNSb3V0ZSAhPT0gJ3NlYXJjaCcpIHtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc2VhcmNoUmVzdWx0cyQucGlwZShcbiAgICAgICAgICBtYXAoKHNlYXJjaFJlc3VsdHMpID0+XG4gICAgICAgICAgICBjcmVhdGVGcm9tKFNlYXJjaFBhZ2VSZXN1bHRzRXZlbnQsIHtcbiAgICAgICAgICAgICAgLi4udGhpcy5jcmVhdGVEZXByZWNhdGVkUGFnZUV2ZW50KG5hdmlnYXRpb25FdmVudCksXG4gICAgICAgICAgICAgIG5hdmlnYXRpb246IHsgLi4ubmF2aWdhdGlvbkV2ZW50IH0sXG4gICAgICAgICAgICAgIC4uLntcbiAgICAgICAgICAgICAgICBzZWFyY2hUZXJtOiBzZWFyY2hSZXN1bHRzPy5mcmVlVGV4dFNlYXJjaCxcbiAgICAgICAgICAgICAgICBudW1iZXJPZlJlc3VsdHM6IHNlYXJjaFJlc3VsdHM/LnBhZ2luYXRpb24/LnRvdGFsUmVzdWx0cyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLy8gVE9ETzogIzEwODk2IC0gcmVtb3ZlIHRoaXMgbWV0aG9kXG4gIHByaXZhdGUgY3JlYXRlRGVwcmVjYXRlZFBhZ2VFdmVudChcbiAgICBuYXZpZ2F0aW9uRXZlbnQ6IE5hdmlnYXRpb25FdmVudFxuICApOiBQYWdlRXZlbnQgfCB1bmRlZmluZWQge1xuICAgIGlmIChcbiAgICAgICF0aGlzLmZlYXR1cmVDb25maWdTZXJ2aWNlIHx8XG4gICAgICB0aGlzLmZlYXR1cmVDb25maWdTZXJ2aWNlLmlzTGV2ZWwoJyEzLjEnKVxuICAgICkge1xuICAgICAgcmV0dXJuIHsgLi4ubmF2aWdhdGlvbkV2ZW50IH07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==