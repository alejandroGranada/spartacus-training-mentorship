import { Injectable, InjectFlags, } from '@angular/core';
import { ConfigChunk, ConfigInitializerService, deepMerge, DefaultConfigChunk, LazyModulesService, } from '@spartacus/core';
import { defer, forkJoin, merge, of } from 'rxjs';
import { map, shareReplay, switchMap } from 'rxjs/operators';
import { CmsFeaturesService } from './cms-features.service';
import * as i0 from "@angular/core";
import * as i1 from "./cms-features.service";
/**
 * Service responsible for resolving cms config based feature modules.
 *
 * @deprecated since 3.2, use CmsFeaturesService instead
 */
export class FeatureModulesService {
    constructor(configInitializer, lazyModules) {
        this.configInitializer = configInitializer;
        this.lazyModules = lazyModules;
        // maps componentType to feature
        this.componentFeatureMap = new Map();
        /*
         * Contains either FeatureInstance or FeatureInstance resolver for not yet
         * resolved feature modules
         */
        this.features = new Map();
        this.initFeatureMap();
    }
    initFeatureMap() {
        this.configInitializer.getStable('featureModules').subscribe((config) => {
            var _a, _b;
            this.featureModulesConfig = (_a = config.featureModules) !== null && _a !== void 0 ? _a : {};
            for (const [featureName, featureConfig] of Object.entries(this.featureModulesConfig)) {
                if ((featureConfig === null || featureConfig === void 0 ? void 0 : featureConfig.module) && ((_b = featureConfig === null || featureConfig === void 0 ? void 0 : featureConfig.cmsComponents) === null || _b === void 0 ? void 0 : _b.length)) {
                    for (const component of featureConfig.cmsComponents) {
                        this.componentFeatureMap.set(component, featureName);
                    }
                }
            }
        });
    }
    /**
     * Check if there is feature module configuration that covers specified
     * component type
     */
    hasFeatureFor(componentType) {
        return this.componentFeatureMap.has(componentType);
    }
    /**
     * Return full CmsComponent mapping defined in feature module
     */
    getCmsMapping(componentType) {
        const feature = this.componentFeatureMap.get(componentType);
        return this.resolveFeature(feature).pipe(map((featureInstance) => featureInstance.componentsMappings[componentType]));
    }
    /**
     * Resolves feature module for provided component type
     *
     * @param componentType
     */
    getModule(componentType) {
        var _a;
        const feature = this.componentFeatureMap.get(componentType);
        let module;
        // we are returning injectors only for already resolved features
        (_a = this.features
            .get(feature)) === null || _a === void 0 ? void 0 : _a.subscribe((featureInstance) => {
            module = featureInstance.moduleRef;
        }).unsubscribe();
        return module;
    }
    /**
     * Resolve feature based on feature name, if feature was not yet resolved
     *
     * It will first resolve all module dependencies if defined
     */
    resolveFeature(featureName) {
        return defer(() => {
            var _a;
            if (!this.features.has(featureName)) {
                const featureConfig = this.featureModulesConfig[featureName];
                if (!(featureConfig === null || featureConfig === void 0 ? void 0 : featureConfig.module)) {
                    throw new Error('No module defined for Feature Module ' + featureName);
                }
                // resolve dependencies first (if any)
                const depsResolve = ((_a = featureConfig.dependencies) === null || _a === void 0 ? void 0 : _a.length) ? forkJoin(featureConfig.dependencies.map((depModuleFunc) => {
                    return typeof depModuleFunc === 'string'
                        ? this.resolveFeature(depModuleFunc).pipe(map((feature) => feature.moduleRef))
                        : this.lazyModules.resolveDependencyModuleInstance(depModuleFunc);
                }))
                    : of(undefined);
                this.features.set(featureName, depsResolve.pipe(switchMap((deps) => this.resolveFeatureModule(featureConfig, deps, featureName)), shareReplay()));
            }
            return this.features.get(featureName);
        });
    }
    /**
     * Initialize feature module by returning feature instance
     */
    resolveFeatureModule(featureConfig, dependencyModuleRefs = [], feature) {
        return this.lazyModules
            .resolveModuleInstance(featureConfig === null || featureConfig === void 0 ? void 0 : featureConfig.module, feature, dependencyModuleRefs)
            .pipe(map((moduleRef) => {
            var _a, _b;
            const featureInstance = Object.assign(Object.assign({}, featureConfig), { moduleRef,
                dependencyModuleRefs, componentsMappings: {} });
            // resolve configuration for feature module
            const resolvedConfiguration = this.resolveFeatureConfiguration(moduleRef.injector);
            // extract cms components configuration from feature config
            for (const componentType of featureInstance.cmsComponents) {
                featureInstance.componentsMappings[componentType] = (_b = (_a = resolvedConfiguration.cmsComponents) === null || _a === void 0 ? void 0 : _a[componentType]) !== null && _b !== void 0 ? _b : {};
            }
            return featureInstance;
        }));
    }
    /**
     * Returns configuration provided in feature module
     */
    resolveFeatureConfiguration(featureInjector) {
        // get config chunks from feature lib
        const featureConfigChunks = featureInjector.get(ConfigChunk, [], InjectFlags.Self);
        // get default config chunks from feature lib
        const featureDefaultConfigChunks = featureInjector.get(DefaultConfigChunk, [], InjectFlags.Self);
        return deepMerge({}, ...(featureDefaultConfigChunks !== null && featureDefaultConfigChunks !== void 0 ? featureDefaultConfigChunks : []), ...(featureConfigChunks !== null && featureConfigChunks !== void 0 ? featureConfigChunks : []));
    }
    ngOnDestroy() {
        // clean up all initialized features
        merge(...Array.from(this.features.values())).subscribe((featureInstance) => { var _a; return (_a = featureInstance.moduleRef) === null || _a === void 0 ? void 0 : _a.destroy(); });
    }
}
FeatureModulesService.ɵprov = i0.ɵɵdefineInjectable({ factory: function FeatureModulesService_Factory() { return i0.ɵɵinject(i1.CmsFeaturesService); }, token: FeatureModulesService, providedIn: "root" });
FeatureModulesService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
                useExisting: CmsFeaturesService,
            },] }
];
FeatureModulesService.ctorParameters = () => [
    { type: ConfigInitializerService },
    { type: LazyModulesService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmVhdHVyZS1tb2R1bGVzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvUGF0cnlrL0Rlc2t0b3Avc3BhcnRhY3VzL3Byb2plY3RzL3N0b3JlZnJvbnRsaWIvc3JjLyIsInNvdXJjZXMiOlsiY21zLXN0cnVjdHVyZS9zZXJ2aWNlcy9mZWF0dXJlLW1vZHVsZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsVUFBVSxFQUNWLFdBQVcsR0FJWixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBSUwsV0FBVyxFQUNYLHdCQUF3QixFQUN4QixTQUFTLEVBQ1Qsa0JBQWtCLEVBRWxCLGtCQUFrQixHQUNuQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUQsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7OztBQVE1RDs7OztHQUlHO0FBS0gsTUFBTSxPQUFPLHFCQUFxQjtJQWVoQyxZQUNZLGlCQUEyQyxFQUMzQyxXQUErQjtRQUQvQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO1FBQzNDLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQVgzQyxnQ0FBZ0M7UUFDeEIsd0JBQW1CLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUM7UUFFN0Q7OztXQUdHO1FBQ0ssYUFBUSxHQUE2QyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBTXJFLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRU8sY0FBYztRQUNwQixJQUFJLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7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QztJQUNOLENBQUM7SUFFRDs7T0FFRztJQUNLLDJCQUEyQixDQUFDLGVBQXlCO1FBQzNELHFDQUFxQztRQUNyQyxNQUFNLG1CQUFtQixHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQzdDLFdBQVcsRUFDWCxFQUFFLEVBQ0YsV0FBVyxDQUFDLElBQUksQ0FDakIsQ0FBQztRQUNGLDZDQUE2QztRQUM3QyxNQUFNLDBCQUEwQixHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQ3BELGtCQUFrQixFQUNsQixFQUFFLEVBQ0YsV0FBVyxDQUFDLElBQUksQ0FDakIsQ0FBQztRQUVGLE9BQU8sU0FBUyxDQUNkLEVBQUUsRUFDRixHQUFHLENBQUMsMEJBQTBCLGFBQTFCLDBCQUEwQixjQUExQiwwQkFBMEIsR0FBSSxFQUFFLENBQUMsRUFDckMsR0FBRyxDQUFDLG1CQUFtQixhQUFuQixtQkFBbUIsY0FBbkIsbUJBQW1CLEdBQUksRUFBRSxDQUFDLENBQ2xCLENBQUM7SUFDakIsQ0FBQztJQUVELFdBQVc7UUFDVCxvQ0FBb0M7UUFDcEMsS0FBSyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxlQUFlLEVBQUUsRUFBRSx3QkFDekUsZUFBZSxDQUFDLFNBQVMsMENBQUUsT0FBTyxLQUFFLENBQ3JDLENBQUM7SUFDSixDQUFDOzs7O1lBbk1GLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTtnQkFDbEIsV0FBVyxFQUFFLGtCQUFrQjthQUNoQzs7O1lBeEJDLHdCQUF3QjtZQUl4QixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlLFxuICBJbmplY3RGbGFncyxcbiAgSW5qZWN0b3IsXG4gIE5nTW9kdWxlUmVmLFxuICBPbkRlc3Ryb3ksXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQ01TQ29tcG9uZW50Q29uZmlnLFxuICBDbXNDb21wb25lbnRNYXBwaW5nLFxuICBDbXNDb25maWcsXG4gIENvbmZpZ0NodW5rLFxuICBDb25maWdJbml0aWFsaXplclNlcnZpY2UsXG4gIGRlZXBNZXJnZSxcbiAgRGVmYXVsdENvbmZpZ0NodW5rLFxuICBGZWF0dXJlTW9kdWxlQ29uZmlnLFxuICBMYXp5TW9kdWxlc1NlcnZpY2UsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBkZWZlciwgZm9ya0pvaW4sIG1lcmdlLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBzaGFyZVJlcGxheSwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ21zRmVhdHVyZXNTZXJ2aWNlIH0gZnJvbSAnLi9jbXMtZmVhdHVyZXMuc2VydmljZSc7XG5cbmludGVyZmFjZSBGZWF0dXJlSW5zdGFuY2UgZXh0ZW5kcyBGZWF0dXJlTW9kdWxlQ29uZmlnIHtcbiAgbW9kdWxlUmVmPzogTmdNb2R1bGVSZWY8YW55PjtcbiAgZGVwZW5kZW5jeU1vZHVsZVJlZnM/OiBOZ01vZHVsZVJlZjxhbnk+W107XG4gIGNvbXBvbmVudHNNYXBwaW5ncz86IENNU0NvbXBvbmVudENvbmZpZztcbn1cblxuLyoqXG4gKiBTZXJ2aWNlIHJlc3BvbnNpYmxlIGZvciByZXNvbHZpbmcgY21zIGNvbmZpZyBiYXNlZCBmZWF0dXJlIG1vZHVsZXMuXG4gKlxuICogQGRlcHJlY2F0ZWQgc2luY2UgMy4yLCB1c2UgQ21zRmVhdHVyZXNTZXJ2aWNlIGluc3RlYWRcbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG4gIHVzZUV4aXN0aW5nOiBDbXNGZWF0dXJlc1NlcnZpY2UsXG59KVxuZXhwb3J0IGNsYXNzIEZlYXR1cmVNb2R1bGVzU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIC8vIGZlYXR1cmUgbW9kdWxlcyBjb25maWd1cmF0aW9uXG4gIHByaXZhdGUgZmVhdHVyZU1vZHVsZXNDb25maWc/OiB7XG4gICAgW2ZlYXR1cmVOYW1lOiBzdHJpbmddOiBGZWF0dXJlTW9kdWxlQ29uZmlnO1xuICB9O1xuXG4gIC8vIG1hcHMgY29tcG9uZW50VHlwZSB0byBmZWF0dXJlXG4gIHByaXZhdGUgY29tcG9uZW50RmVhdHVyZU1hcDogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoKTtcblxuICAvKlxuICAgKiBDb250YWlucyBlaXRoZXIgRmVhdHVyZUluc3RhbmNlIG9yIEZlYXR1cmVJbnN0YW5jZSByZXNvbHZlciBmb3Igbm90IHlldFxuICAgKiByZXNvbHZlZCBmZWF0dXJlIG1vZHVsZXNcbiAgICovXG4gIHByaXZhdGUgZmVhdHVyZXM6IE1hcDxzdHJpbmcsIE9ic2VydmFibGU8RmVhdHVyZUluc3RhbmNlPj4gPSBuZXcgTWFwKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGNvbmZpZ0luaXRpYWxpemVyOiBDb25maWdJbml0aWFsaXplclNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGxhenlNb2R1bGVzOiBMYXp5TW9kdWxlc1NlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5pbml0RmVhdHVyZU1hcCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmVhdHVyZU1hcCgpOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZ0luaXRpYWxpemVyLmdldFN0YWJsZSgnZmVhdHVyZU1vZHVsZXMnKS5zdWJzY3JpYmUoKGNvbmZpZykgPT4ge1xuICAgICAgdGhpcy5mZWF0dXJlTW9kdWxlc0NvbmZpZyA9IGNvbmZpZy5mZWF0dXJlTW9kdWxlcyA/PyB7fTtcblxuICAgICAgZm9yIChjb25zdCBbZmVhdHVyZU5hbWUsIGZlYXR1cmVDb25maWddIG9mIE9iamVjdC5lbnRyaWVzKFxuICAgICAgICB0aGlzLmZlYXR1cmVNb2R1bGVzQ29uZmlnXG4gICAgICApKSB7XG4gICAgICAgIGlmIChmZWF0dXJlQ29uZmlnPy5tb2R1bGUgJiYgZmVhdHVyZUNvbmZpZz8uY21zQ29tcG9uZW50cz8ubGVuZ3RoKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBjb21wb25lbnQgb2YgZmVhdHVyZUNvbmZpZy5jbXNDb21wb25lbnRzKSB7XG4gICAgICAgICAgICB0aGlzLmNvbXBvbmVudEZlYXR1cmVNYXAuc2V0KGNvbXBvbmVudCwgZmVhdHVyZU5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHRoZXJlIGlzIGZlYXR1cmUgbW9kdWxlIGNvbmZpZ3VyYXRpb24gdGhhdCBjb3ZlcnMgc3BlY2lmaWVkXG4gICAqIGNvbXBvbmVudCB0eXBlXG4gICAqL1xuICBoYXNGZWF0dXJlRm9yKGNvbXBvbmVudFR5cGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNvbXBvbmVudEZlYXR1cmVNYXAuaGFzKGNvbXBvbmVudFR5cGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBmdWxsIENtc0NvbXBvbmVudCBtYXBwaW5nIGRlZmluZWQgaW4gZmVhdHVyZSBtb2R1bGVcbiAgICovXG4gIGdldENtc01hcHBpbmcoY29tcG9uZW50VHlwZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxDbXNDb21wb25lbnRNYXBwaW5nPiB7XG4gICAgY29uc3QgZmVhdHVyZSA9IHRoaXMuY29tcG9uZW50RmVhdHVyZU1hcC5nZXQoY29tcG9uZW50VHlwZSk7XG5cbiAgICByZXR1cm4gdGhpcy5yZXNvbHZlRmVhdHVyZShmZWF0dXJlKS5waXBlKFxuICAgICAgbWFwKFxuICAgICAgICAoZmVhdHVyZUluc3RhbmNlKSA9PiBmZWF0dXJlSW5zdGFuY2UuY29tcG9uZW50c01hcHBpbmdzW2NvbXBvbmVudFR5cGVdXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNvbHZlcyBmZWF0dXJlIG1vZHVsZSBmb3IgcHJvdmlkZWQgY29tcG9uZW50IHR5cGVcbiAgICpcbiAgICogQHBhcmFtIGNvbXBvbmVudFR5cGVcbiAgICovXG4gIGdldE1vZHVsZShjb21wb25lbnRUeXBlOiBzdHJpbmcpOiBOZ01vZHVsZVJlZjxhbnk+IHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBmZWF0dXJlID0gdGhpcy5jb21wb25lbnRGZWF0dXJlTWFwLmdldChjb21wb25lbnRUeXBlKTtcbiAgICBsZXQgbW9kdWxlO1xuXG4gICAgLy8gd2UgYXJlIHJldHVybmluZyBpbmplY3RvcnMgb25seSBmb3IgYWxyZWFkeSByZXNvbHZlZCBmZWF0dXJlc1xuICAgIHRoaXMuZmVhdHVyZXNcbiAgICAgIC5nZXQoZmVhdHVyZSlcbiAgICAgID8uc3Vic2NyaWJlKChmZWF0dXJlSW5zdGFuY2UpID0+IHtcbiAgICAgICAgbW9kdWxlID0gZmVhdHVyZUluc3RhbmNlLm1vZHVsZVJlZjtcbiAgICAgIH0pXG4gICAgICAudW5zdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gbW9kdWxlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc29sdmUgZmVhdHVyZSBiYXNlZCBvbiBmZWF0dXJlIG5hbWUsIGlmIGZlYXR1cmUgd2FzIG5vdCB5ZXQgcmVzb2x2ZWRcbiAgICpcbiAgICogSXQgd2lsbCBmaXJzdCByZXNvbHZlIGFsbCBtb2R1bGUgZGVwZW5kZW5jaWVzIGlmIGRlZmluZWRcbiAgICovXG4gIHJlc29sdmVGZWF0dXJlKGZlYXR1cmVOYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEZlYXR1cmVJbnN0YW5jZT4ge1xuICAgIHJldHVybiBkZWZlcigoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuZmVhdHVyZXMuaGFzKGZlYXR1cmVOYW1lKSkge1xuICAgICAgICBjb25zdCBmZWF0dXJlQ29uZmlnID0gdGhpcy5mZWF0dXJlTW9kdWxlc0NvbmZpZ1tmZWF0dXJlTmFtZV07XG5cbiAgICAgICAgaWYgKCFmZWF0dXJlQ29uZmlnPy5tb2R1bGUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAnTm8gbW9kdWxlIGRlZmluZWQgZm9yIEZlYXR1cmUgTW9kdWxlICcgKyBmZWF0dXJlTmFtZVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyByZXNvbHZlIGRlcGVuZGVuY2llcyBmaXJzdCAoaWYgYW55KVxuICAgICAgICBjb25zdCBkZXBzUmVzb2x2ZSA9IGZlYXR1cmVDb25maWcuZGVwZW5kZW5jaWVzPy5sZW5ndGhcbiAgICAgICAgICA/IGZvcmtKb2luKFxuICAgICAgICAgICAgICBmZWF0dXJlQ29uZmlnLmRlcGVuZGVuY2llcy5tYXAoKGRlcE1vZHVsZUZ1bmMpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIGRlcE1vZHVsZUZ1bmMgPT09ICdzdHJpbmcnXG4gICAgICAgICAgICAgICAgICA/IHRoaXMucmVzb2x2ZUZlYXR1cmUoZGVwTW9kdWxlRnVuYykucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICBtYXAoKGZlYXR1cmUpID0+IGZlYXR1cmUubW9kdWxlUmVmKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICA6IHRoaXMubGF6eU1vZHVsZXMucmVzb2x2ZURlcGVuZGVuY3lNb2R1bGVJbnN0YW5jZShcbiAgICAgICAgICAgICAgICAgICAgICBkZXBNb2R1bGVGdW5jXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgOiBvZih1bmRlZmluZWQpO1xuXG4gICAgICAgIHRoaXMuZmVhdHVyZXMuc2V0KFxuICAgICAgICAgIGZlYXR1cmVOYW1lLFxuICAgICAgICAgIGRlcHNSZXNvbHZlLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGRlcHMpID0+XG4gICAgICAgICAgICAgIHRoaXMucmVzb2x2ZUZlYXR1cmVNb2R1bGUoZmVhdHVyZUNvbmZpZywgZGVwcywgZmVhdHVyZU5hbWUpXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgc2hhcmVSZXBsYXkoKVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXMuZ2V0KGZlYXR1cmVOYW1lKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIGZlYXR1cmUgbW9kdWxlIGJ5IHJldHVybmluZyBmZWF0dXJlIGluc3RhbmNlXG4gICAqL1xuICBwcml2YXRlIHJlc29sdmVGZWF0dXJlTW9kdWxlKFxuICAgIGZlYXR1cmVDb25maWc6IEZlYXR1cmVNb2R1bGVDb25maWcsXG4gICAgZGVwZW5kZW5jeU1vZHVsZVJlZnM6IE5nTW9kdWxlUmVmPGFueT5bXSA9IFtdLFxuICAgIGZlYXR1cmU6IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPEZlYXR1cmVJbnN0YW5jZT4ge1xuICAgIHJldHVybiB0aGlzLmxhenlNb2R1bGVzXG4gICAgICAucmVzb2x2ZU1vZHVsZUluc3RhbmNlKFxuICAgICAgICBmZWF0dXJlQ29uZmlnPy5tb2R1bGUsXG4gICAgICAgIGZlYXR1cmUsXG4gICAgICAgIGRlcGVuZGVuY3lNb2R1bGVSZWZzXG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChtb2R1bGVSZWY6IE5nTW9kdWxlUmVmPGFueT4pID0+IHtcbiAgICAgICAgICBjb25zdCBmZWF0dXJlSW5zdGFuY2U6IEZlYXR1cmVJbnN0YW5jZSA9IHtcbiAgICAgICAgICAgIC4uLmZlYXR1cmVDb25maWcsXG4gICAgICAgICAgICBtb2R1bGVSZWYsXG4gICAgICAgICAgICBkZXBlbmRlbmN5TW9kdWxlUmVmcyxcbiAgICAgICAgICAgIGNvbXBvbmVudHNNYXBwaW5nczoge30sXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIC8vIHJlc29sdmUgY29uZmlndXJhdGlvbiBmb3IgZmVhdHVyZSBtb2R1bGVcbiAgICAgICAgICBjb25zdCByZXNvbHZlZENvbmZpZ3VyYXRpb24gPSB0aGlzLnJlc29sdmVGZWF0dXJlQ29uZmlndXJhdGlvbihcbiAgICAgICAgICAgIG1vZHVsZVJlZi5pbmplY3RvclxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBleHRyYWN0IGNtcyBjb21wb25lbnRzIGNvbmZpZ3VyYXRpb24gZnJvbSBmZWF0dXJlIGNvbmZpZ1xuICAgICAgICAgIGZvciAoY29uc3QgY29tcG9uZW50VHlwZSBvZiBmZWF0dXJlSW5zdGFuY2UuY21zQ29tcG9uZW50cykge1xuICAgICAgICAgICAgZmVhdHVyZUluc3RhbmNlLmNvbXBvbmVudHNNYXBwaW5nc1tjb21wb25lbnRUeXBlXSA9XG4gICAgICAgICAgICAgIHJlc29sdmVkQ29uZmlndXJhdGlvbi5jbXNDb21wb25lbnRzPy5bY29tcG9uZW50VHlwZV0gPz8ge307XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmZWF0dXJlSW5zdGFuY2U7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgY29uZmlndXJhdGlvbiBwcm92aWRlZCBpbiBmZWF0dXJlIG1vZHVsZVxuICAgKi9cbiAgcHJpdmF0ZSByZXNvbHZlRmVhdHVyZUNvbmZpZ3VyYXRpb24oZmVhdHVyZUluamVjdG9yOiBJbmplY3Rvcik6IENtc0NvbmZpZyB7XG4gICAgLy8gZ2V0IGNvbmZpZyBjaHVua3MgZnJvbSBmZWF0dXJlIGxpYlxuICAgIGNvbnN0IGZlYXR1cmVDb25maWdDaHVua3MgPSBmZWF0dXJlSW5qZWN0b3IuZ2V0PGFueVtdPihcbiAgICAgIENvbmZpZ0NodW5rLFxuICAgICAgW10sXG4gICAgICBJbmplY3RGbGFncy5TZWxmXG4gICAgKTtcbiAgICAvLyBnZXQgZGVmYXVsdCBjb25maWcgY2h1bmtzIGZyb20gZmVhdHVyZSBsaWJcbiAgICBjb25zdCBmZWF0dXJlRGVmYXVsdENvbmZpZ0NodW5rcyA9IGZlYXR1cmVJbmplY3Rvci5nZXQ8YW55W10+KFxuICAgICAgRGVmYXVsdENvbmZpZ0NodW5rLFxuICAgICAgW10sXG4gICAgICBJbmplY3RGbGFncy5TZWxmXG4gICAgKTtcblxuICAgIHJldHVybiBkZWVwTWVyZ2UoXG4gICAgICB7fSxcbiAgICAgIC4uLihmZWF0dXJlRGVmYXVsdENvbmZpZ0NodW5rcyA/PyBbXSksXG4gICAgICAuLi4oZmVhdHVyZUNvbmZpZ0NodW5rcyA/PyBbXSlcbiAgICApIGFzIENtc0NvbmZpZztcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIC8vIGNsZWFuIHVwIGFsbCBpbml0aWFsaXplZCBmZWF0dXJlc1xuICAgIG1lcmdlKC4uLkFycmF5LmZyb20odGhpcy5mZWF0dXJlcy52YWx1ZXMoKSkpLnN1YnNjcmliZSgoZmVhdHVyZUluc3RhbmNlKSA9PlxuICAgICAgZmVhdHVyZUluc3RhbmNlLm1vZHVsZVJlZj8uZGVzdHJveSgpXG4gICAgKTtcbiAgfVxufVxuIl19