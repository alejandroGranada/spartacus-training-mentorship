import { ChangeDetectionStrategy, ChangeDetectorRef, Component, HostBinding, HostListener, Renderer2, TemplateRef, } from '@angular/core';
import { NavigationStart, Router } from '@angular/router';
import { filter } from 'rxjs/operators';
import { WindowRef } from '@spartacus/core';
import { Subject } from 'rxjs';
import { PopoverEvent } from './popover.model';
import { PositioningService } from '../../services/positioning/positioning.service';
import { ICON_TYPE } from '../../../cms-components/misc/icon/icon.model';
export class PopoverComponent {
    constructor(positioningService, winRef, changeDetectionRef, renderer, router) {
        this.positioningService = positioningService;
        this.winRef = winRef;
        this.changeDetectionRef = changeDetectionRef;
        this.renderer = renderer;
        this.router = router;
        /**
         * Icon types for close button icon.
         */
        this.iconTypes = ICON_TYPE;
        /**
         * Subject which emits specific type of `PopoverEvent`.
         */
        this.eventSubject = new Subject();
    }
    /**
     * Listens for click inside popover component wrapper.
     */
    insideClick() {
        this.eventSubject.next(PopoverEvent.INSIDE_CLICK);
        this.insideClicked = true;
    }
    /**
     * Listens for every document click and ignores clicks
     * inside component.
     */
    outsideClick() {
        if (!this.insideClicked) {
            this.eventSubject.next(PopoverEvent.OUTSIDE_CLICK);
        }
        this.insideClicked = false;
    }
    /**
     * Listens for `escape` keyodwn event.
     */
    escapeKeydown() {
        this.eventSubject.next(PopoverEvent.ESCAPE_KEYDOWN);
    }
    /**
     * Emits close event trigger.
     */
    close(event) {
        if (event instanceof MouseEvent)
            this.eventSubject.next(PopoverEvent.CLOSE_BUTTON_CLICK);
        else
            this.eventSubject.next(PopoverEvent.CLOSE_BUTTON_KEYDOWN);
    }
    /**
     * Method uses `Renderer2` service to listen window scroll event.
     *
     * Registered only if property `positionOnScroll` is set to `true`.
     */
    triggerScrollEvent() {
        this.scrollEventUnlistener = this.renderer.listen(this.winRef.nativeWindow, 'scroll', () => this.positionPopover());
    }
    /**
     * Method uses positioning service calculation and based on that
     * updates class name for popover component instance.
     */
    positionPopover() {
        this.popoverClass = this.positioningService.positionElements(this.triggerElement.nativeElement, this.popoverInstance.location.nativeElement, this.positioningService.getPositioningClass(this.position, this.autoPositioning), this.appendToBody);
        this.changeDetectionRef.markForCheck();
        this.baseClass = `${this.customClass} ${this.popoverClass} opened`;
    }
    ngOnInit() {
        this.isTemplate = this.content instanceof TemplateRef;
        if (!this.customClass)
            this.customClass = 'cx-popover';
        if (!this.position)
            this.position = 'top';
        if (this.autoPositioning === undefined)
            this.autoPositioning = true;
        this.baseClass = `${this.customClass}`;
        this.resizeSub = this.winRef.resize$.subscribe(() => {
            this.positionPopover();
        });
        this.routeChangeSub = this.router.events
            .pipe(filter((event) => event instanceof NavigationStart))
            .subscribe(() => {
            this.eventSubject.next(PopoverEvent.ROUTE_CHANGE);
        });
        if (this.positionOnScroll) {
            this.triggerScrollEvent();
        }
    }
    ngAfterViewChecked() {
        this.positionPopover();
    }
    ngOnDestroy() {
        if (this.resizeSub) {
            this.resizeSub.unsubscribe();
        }
        if (this.routeChangeSub) {
            this.routeChangeSub.unsubscribe();
        }
        if (this.scrollEventUnlistener) {
            this.scrollEventUnlistener();
        }
    }
}
PopoverComponent.decorators = [
    { type: Component, args: [{
                selector: 'cx-popover',
                template: "<div class=\"arrow\"></div>\n<div class=\"popover-body\" [cxFocus]=\"focusConfig\">\n  <button\n    *ngIf=\"displayCloseButton\"\n    type=\"button\"\n    class=\"close\"\n    (keydown.enter)=\"close($event)\"\n    (keydown.space)=\"close($event)\"\n    (click)=\"close($event)\"\n  >\n    <cx-icon [type]=\"iconTypes.CLOSE\"></cx-icon>\n  </button>\n  <ng-container *ngIf=\"isTemplate\">\n    <ng-container *ngTemplateOutlet=\"content\"></ng-container>\n  </ng-container>\n  <span *ngIf=\"!isTemplate\">{{ content }}</span>\n</div>\n",
                changeDetection: ChangeDetectionStrategy.OnPush
            },] }
];
PopoverComponent.ctorParameters = () => [
    { type: PositioningService },
    { type: WindowRef },
    { type: ChangeDetectorRef },
    { type: Renderer2 },
    { type: Router }
];
PopoverComponent.propDecorators = {
    baseClass: [{ type: HostBinding, args: ['className',] }],
    insideClick: [{ type: HostListener, args: ['click',] }],
    outsideClick: [{ type: HostListener, args: ['document:click',] }],
    escapeKeydown: [{ type: HostListener, args: ['keydown.escape',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wb3Zlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvUGF0cnlrL0Rlc2t0b3Avc3BhcnRhY3VzL3Byb2plY3RzL3N0b3JlZnJvbnRsaWIvc3JjLyIsInNvdXJjZXMiOlsic2hhcmVkL2NvbXBvbmVudHMvcG9wb3Zlci9wb3BvdmVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixTQUFTLEVBR1QsV0FBVyxFQUNYLFlBQVksRUFHWixTQUFTLEVBQ1QsV0FBVyxHQUNaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUM3QyxPQUFPLEVBQUUsWUFBWSxFQUFtQixNQUFNLGlCQUFpQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdEQUFnRCxDQUFDO0FBRXBGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQU96RSxNQUFNLE9BQU8sZ0JBQWdCO0lBZ08zQixZQUNZLGtCQUFzQyxFQUN0QyxNQUFpQixFQUNqQixrQkFBcUMsRUFDckMsUUFBbUIsRUFDbkIsTUFBYztRQUpkLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNqQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW1CO1FBQ3JDLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQTlJMUI7O1dBRUc7UUFDSCxjQUFTLEdBQUcsU0FBUyxDQUFDO1FBT3RCOztX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LENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BELENBQUMsQ0FBQyxDQUFDO1FBRUwsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDekIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7U0FDM0I7SUFDSCxDQUFDO0lBRUQsa0JBQWtCO1FBQ2hCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQsV0FBVztRQUNULElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQzlCO1FBRUQsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDbkM7UUFFRCxJQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtZQUM5QixJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztTQUM5QjtJQUNILENBQUM7OztZQW5PRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLGtpQkFBdUM7Z0JBQ3ZDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO2FBQ2hEOzs7WUFSUSxrQkFBa0I7WUFIbEIsU0FBUztZQWJoQixpQkFBaUI7WUFRakIsU0FBUztZQUdlLE1BQU07Ozt3QkE0SDdCLFdBQVcsU0FBQyxXQUFXOzBCQUt2QixZQUFZLFNBQUMsT0FBTzsyQkFVcEIsWUFBWSxTQUFDLGdCQUFnQjs0QkFXN0IsWUFBWSxTQUFDLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyVmlld0NoZWNrZWQsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBDb21wb25lbnRSZWYsXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3RCaW5kaW5nLFxuICBIb3N0TGlzdGVuZXIsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBSZW5kZXJlcjIsXG4gIFRlbXBsYXRlUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5hdmlnYXRpb25TdGFydCwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFdpbmRvd1JlZiB9IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBvcG92ZXJFdmVudCwgUG9wb3ZlclBvc2l0aW9uIH0gZnJvbSAnLi9wb3BvdmVyLm1vZGVsJztcbmltcG9ydCB7IFBvc2l0aW9uaW5nU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3Bvc2l0aW9uaW5nL3Bvc2l0aW9uaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9jdXNDb25maWcgfSBmcm9tICcuLi8uLi8uLi9sYXlvdXQvYTExeS9rZXlib2FyZC1mb2N1cy9rZXlib2FyZC1mb2N1cy5tb2RlbCc7XG5pbXBvcnQgeyBJQ09OX1RZUEUgfSBmcm9tICcuLi8uLi8uLi9jbXMtY29tcG9uZW50cy9taXNjL2ljb24vaWNvbi5tb2RlbCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2N4LXBvcG92ZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vcG9wb3Zlci5jb21wb25lbnQuaHRtbCcsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBQb3BvdmVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0NoZWNrZWQge1xuICAvKipcbiAgICogU3RyaW5nIG9yIHRlbXBsYXRlIHRvIGJlIHJlbmRlcmVkIGluc2lkZSBwb3BvdmVyIHdyYXBwZXIgY29tcG9uZW50LlxuICAgKi9cbiAgY29udGVudDogc3RyaW5nIHwgVGVtcGxhdGVSZWY8YW55PjtcblxuICAvKipcbiAgICogRWxlbWVudCB3aGljaCB0cmlnZ2VycyBkaXNwbGF5aW5nIHBvcG92ZXIgY29tcG9uZW50LlxuICAgKiBUaGlzIHByb3BlcnR5IGlzIG5lZWRlZCB0byBjYWxjdWxhdGUgdmFsaWQgcG9zaXRpb24gZm9yIHBvcG92ZXIuXG4gICAqL1xuICB0cmlnZ2VyRWxlbWVudDogRWxlbWVudFJlZjtcblxuICAvKipcbiAgICogQ3VycmVudCBpbml0aWF0ZWQgcG9wb3ZlciBpbnN0YW5jZS5cbiAgICovXG4gIHBvcG92ZXJJbnN0YW5jZTogQ29tcG9uZW50UmVmPFBvcG92ZXJDb21wb25lbnQ+O1xuXG4gIC8qKlxuICAgKiBGbGFnIHdoaWNoIGluZm9ybXMgcG9zaXRpb25pbmcgc2VydmljZSBpZiBwb3BvdmVyIGNvbXBvbmVudFxuICAgKiBzaG91bGQgYmUgYXBwZW5kZWQgdG8gYm9keS4gT3RoZXJ3aXNlIHBvcG92ZXIgaXMgZGlzcGxheWVkIHJpZ2h0IGFmdGVyXG4gICAqIHRyaWdnZXIgZWxlbWVudCBpbiBET00uXG4gICAqL1xuICBhcHBlbmRUb0JvZHk/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBUaGUgcHJlZmVycmVkIHBsYWNlbWVudCBvZiB0aGUgcG9wb3Zlci4gRGVmYXVsdCBwb3BvdmVyIHBvc2l0aW9uIGlzICd0b3AnLlxuICAgKlxuICAgKiBBbGxvd2VkIHBvcG92ZXIgcG9zaXRpb25zOiAnYXV0bycsICd0b3AnLCAnYm90dG9tJywgJ2xlZnQnLCAncmlnaHQnLFxuICAgKiAndG9wLWxlZnQnLCAndG9wLXJpZ2h0JywgJ2JvdHRvbS1sZWZ0JywgJ2JvdHRvbS1yaWdodCcsXG4gICAqICdsZWZ0LXRvcCcsICdsZWZ0LWJvdHRvbScsICdyaWdodC10b3AnLCAncmlnaHQtYm90dG9tJy5cbiAgICovXG4gIHBvc2l0aW9uPzogUG9wb3ZlclBvc2l0aW9uO1xuXG4gIC8qKlxuICAgKiBGbGFnIHVzZWQgdG8gZGVmaW5lIGlmIHBvcG92ZXIgc2hvdWxkIGxvb2sgZm9yIHRoZSBiZXN0IHBsYWNlbWVudFxuICAgKiBpbiBjYXNlIGlmIHRoZXJlIGlzIG5vdCBlbm91Z2ggc3BhY2UgaW4gdmlld3BvcnQgZm9yIHByZWZlcnJlZCBwb3NpdGlvbi5cbiAgICpcbiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3BlcnR5IGlzIHNldCB0byBgdHJ1ZWAuXG4gICAqXG4gICAqIFZhbHVlIG9mIHRoaXMgZmxhZyBpcyBvbWl0dGVkIGlmIHByZWZlcnJlZCBwb3NpdGlvbiBpcyBzZXQgdG8gYGF1dG9gLlxuICAgKi9cbiAgYXV0b1Bvc2l0aW9uaW5nPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogQ3VzdG9tIGNsYXNzIG5hbWUgcGFzc2VkIHRvIHBvcG92ZXIgY29tcG9uZW50LlxuICAgKlxuICAgKiBJZiB0aGlzIHByb3BlcnR5IGlzIG5vdCBzZXQgdGhlIGRlZmF1bHQgcG9wb3ZlciBjbGFzcyBpcyBgY3gtcG9wb3ZlcmAuXG4gICAqL1xuICBjdXN0b21DbGFzcz86IHN0cmluZztcblxuICAvKipcbiAgICogRmxhZyB1c2VkIHRvIHNob3cvaGlkZSBjbG9zZSBidXR0b24gaW4gcG9wb3ZlciBjb21wb25lbnQuXG4gICAqL1xuICBkaXNwbGF5Q2xvc2VCdXR0b24/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBGbGFnIHdoaWNoIGluZGljYXRlcyBpZiBwYXNzZWQgY29udGVudCBpcyBhIFRlbXBsYXRlUmVmIG9yIHN0cmluZy5cbiAgICovXG4gIGlzVGVtcGxhdGU6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIEFmdGVyIHBvcG92ZXIgY29tcG9uZW50IGlzIGluaXRpYWxpemVkIHBvc2l0aW9uIG5lZWRzIHRvIGJlIGNoYW5naW5nIGR5bmFtaWNhbGx5XG4gICAqIGluIGNhc2UgaWYgYW55IHZpZXdwb3J0IGNoYW5nZXMgaGFwcGVuZWQuXG4gICAqL1xuICByZXNpemVTdWI6IFN1YnNjcmlwdGlvbjtcblxuICAvKipcbiAgICogQWZ0ZXIgcG9wb3ZlciBjb21wb25lbnQgaXMgaW5pdGlhbGl6ZWQgcG9wb3ZlciBzaG91bGQgYmUgY2xvc2VkIGluIGNhc2VcbiAgICogaWYgY3VycmVudCByb3V0ZSBoYXMgYmVlbiBjaGFuZ2VkLlxuICAgKi9cbiAgcm91dGVDaGFuZ2VTdWI6IFN1YnNjcmlwdGlvbjtcblxuICAvKipcbiAgICogQ2xhc3MgbmFtZSBnZW5lcmF0ZWQgYnkgcG9zaXRpb25pbmcgc2VydmljZSBpbmRpY2F0aW5nIHBvc2l0aW9uIG9mIHBvcG92ZXIuXG4gICAqL1xuICBwb3BvdmVyQ2xhc3M6IFBvcG92ZXJQb3NpdGlvbjtcblxuICAvKipcbiAgICogQ29uZmlndXJhdGlvbiBmb3IgYTExeSBpbXByb3ZlbWVudHMuXG4gICAqL1xuICBmb2N1c0NvbmZpZzogRm9jdXNDb25maWc7XG5cbiAgLyoqXG4gICAqIEZsYWcgaW5kaWNhdGVzIGlmIHBvcG92ZXIgc2hvdWxkIGJlIHJlLXBvc2l0aW9uZWQgb24gc2Nyb2xsIGV2ZW50LlxuICAgKi9cbiAgcG9zaXRpb25PblNjcm9sbD86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIEljb24gdHlwZXMgZm9yIGNsb3NlIGJ1dHRvbiBpY29uLlxuICAgKi9cbiAgaWNvblR5cGVzID0gSUNPTl9UWVBFO1xuXG4gIC8qKlxuICAgKiBGbGFnIGluZGljYXRlcyBpZiBtb3VzZSBjbGljayBldmVudCB3YXMgZmlyZWQgaW5zaWRlIGNvbXBvbmVudC5cbiAgICovXG4gIGluc2lkZUNsaWNrZWQ6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFN1YmplY3Qgd2hpY2ggZW1pdHMgc3BlY2lmaWMgdHlwZSBvZiBgUG9wb3ZlckV2ZW50YC5cbiAgICovXG4gIGV2ZW50U3ViamVjdDogU3ViamVjdDxQb3BvdmVyRXZlbnQ+ID0gbmV3IFN1YmplY3Q8UG9wb3ZlckV2ZW50PigpO1xuXG4gIC8qKlxuICAgKiBTY3JvbGwgZXZlbnQgdW5saXN0ZW5lci5cbiAgICovXG4gIHNjcm9sbEV2ZW50VW5saXN0ZW5lcjogKCkgPT4gdm9pZDtcblxuICAvKipcbiAgICogQmluZGluZyBjbGFzcyBuYW1lIHByb3BlcnR5LlxuICAgKi9cbiAgQEhvc3RCaW5kaW5nKCdjbGFzc05hbWUnKSBiYXNlQ2xhc3M6IHN0cmluZztcblxuICAvKipcbiAgICogTGlzdGVucyBmb3IgY2xpY2sgaW5zaWRlIHBvcG92ZXIgY29tcG9uZW50IHdyYXBwZXIuXG4gICAqL1xuICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gIGluc2lkZUNsaWNrKCkge1xuICAgIHRoaXMuZXZlbnRTdWJqZWN0Lm5leHQoUG9wb3ZlckV2ZW50LklOU0lERV9DTElDSyk7XG4gICAgdGhpcy5pbnNpZGVDbGlja2VkID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0ZW5zIGZvciBldmVyeSBkb2N1bWVudCBjbGljayBhbmQgaWdub3JlcyBjbGlja3NcbiAgICogaW5zaWRlIGNvbXBvbmVudC5cbiAgICovXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmNsaWNrJylcbiAgb3V0c2lkZUNsaWNrKCkge1xuICAgIGlmICghdGhpcy5pbnNpZGVDbGlja2VkKSB7XG4gICAgICB0aGlzLmV2ZW50U3ViamVjdC5uZXh0KFBvcG92ZXJFdmVudC5PVVRTSURFX0NMSUNLKTtcbiAgICB9XG4gICAgdGhpcy5pbnNpZGVDbGlja2VkID0gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogTGlzdGVucyBmb3IgYGVzY2FwZWAga2V5b2R3biBldmVudC5cbiAgICovXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24uZXNjYXBlJylcbiAgZXNjYXBlS2V5ZG93bigpIHtcbiAgICB0aGlzLmV2ZW50U3ViamVjdC5uZXh0KFBvcG92ZXJFdmVudC5FU0NBUEVfS0VZRE9XTik7XG4gIH1cblxuICAvKipcbiAgICogRW1pdHMgY2xvc2UgZXZlbnQgdHJpZ2dlci5cbiAgICovXG4gIGNsb3NlKGV2ZW50OiBNb3VzZUV2ZW50IHwgS2V5Ym9hcmRFdmVudCkge1xuICAgIGlmIChldmVudCBpbnN0YW5jZW9mIE1vdXNlRXZlbnQpXG4gICAgICB0aGlzLmV2ZW50U3ViamVjdC5uZXh0KFBvcG92ZXJFdmVudC5DTE9TRV9CVVRUT05fQ0xJQ0spO1xuICAgIGVsc2UgdGhpcy5ldmVudFN1YmplY3QubmV4dChQb3BvdmVyRXZlbnQuQ0xPU0VfQlVUVE9OX0tFWURPV04pO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ldGhvZCB1c2VzIGBSZW5kZXJlcjJgIHNlcnZpY2UgdG8gbGlzdGVuIHdpbmRvdyBzY3JvbGwgZXZlbnQuXG4gICAqXG4gICAqIFJlZ2lzdGVyZWQgb25seSBpZiBwcm9wZXJ0eSBgcG9zaXRpb25PblNjcm9sbGAgaXMgc2V0IHRvIGB0cnVlYC5cbiAgICovXG4gIHRyaWdnZXJTY3JvbGxFdmVudCgpIHtcbiAgICB0aGlzLnNjcm9sbEV2ZW50VW5saXN0ZW5lciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKFxuICAgICAgdGhpcy53aW5SZWYubmF0aXZlV2luZG93LFxuICAgICAgJ3Njcm9sbCcsXG4gICAgICAoKSA9PiB0aGlzLnBvc2l0aW9uUG9wb3ZlcigpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2QgdXNlcyBwb3NpdGlvbmluZyBzZXJ2aWNlIGNhbGN1bGF0aW9uIGFuZCBiYXNlZCBvbiB0aGF0XG4gICAqIHVwZGF0ZXMgY2xhc3MgbmFtZSBmb3IgcG9wb3ZlciBjb21wb25lbnQgaW5zdGFuY2UuXG4gICAqL1xuICBwb3NpdGlvblBvcG92ZXIoKSB7XG4gICAgdGhpcy5wb3BvdmVyQ2xhc3MgPSB0aGlzLnBvc2l0aW9uaW5nU2VydmljZS5wb3NpdGlvbkVsZW1lbnRzKFxuICAgICAgdGhpcy50cmlnZ2VyRWxlbWVudC5uYXRpdmVFbGVtZW50LFxuICAgICAgdGhpcy5wb3BvdmVySW5zdGFuY2UubG9jYXRpb24ubmF0aXZlRWxlbWVudCxcbiAgICAgIHRoaXMucG9zaXRpb25pbmdTZXJ2aWNlLmdldFBvc2l0aW9uaW5nQ2xhc3MoXG4gICAgICAgIHRoaXMucG9zaXRpb24sXG4gICAgICAgIHRoaXMuYXV0b1Bvc2l0aW9uaW5nXG4gICAgICApLFxuICAgICAgdGhpcy5hcHBlbmRUb0JvZHlcbiAgICApO1xuXG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rpb25SZWYubWFya0ZvckNoZWNrKCk7XG4gICAgdGhpcy5iYXNlQ2xhc3MgPSBgJHt0aGlzLmN1c3RvbUNsYXNzfSAke3RoaXMucG9wb3ZlckNsYXNzfSBvcGVuZWRgO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5pc1RlbXBsYXRlID0gdGhpcy5jb250ZW50IGluc3RhbmNlb2YgVGVtcGxhdGVSZWY7XG5cbiAgICBpZiAoIXRoaXMuY3VzdG9tQ2xhc3MpIHRoaXMuY3VzdG9tQ2xhc3MgPSAnY3gtcG9wb3Zlcic7XG4gICAgaWYgKCF0aGlzLnBvc2l0aW9uKSB0aGlzLnBvc2l0aW9uID0gJ3RvcCc7XG4gICAgaWYgKHRoaXMuYXV0b1Bvc2l0aW9uaW5nID09PSB1bmRlZmluZWQpIHRoaXMuYXV0b1Bvc2l0aW9uaW5nID0gdHJ1ZTtcblxuICAgIHRoaXMuYmFzZUNsYXNzID0gYCR7dGhpcy5jdXN0b21DbGFzc31gO1xuXG4gICAgdGhpcy5yZXNpemVTdWIgPSB0aGlzLndpblJlZi5yZXNpemUkLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLnBvc2l0aW9uUG9wb3ZlcigpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yb3V0ZUNoYW5nZVN1YiA9IHRoaXMucm91dGVyLmV2ZW50c1xuICAgICAgLnBpcGUoZmlsdGVyKChldmVudCkgPT4gZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uU3RhcnQpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuZXZlbnRTdWJqZWN0Lm5leHQoUG9wb3ZlckV2ZW50LlJPVVRFX0NIQU5HRSk7XG4gICAgICB9KTtcblxuICAgIGlmICh0aGlzLnBvc2l0aW9uT25TY3JvbGwpIHtcbiAgICAgIHRoaXMudHJpZ2dlclNjcm9sbEV2ZW50KCk7XG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdDaGVja2VkKCk6IHZvaWQge1xuICAgIHRoaXMucG9zaXRpb25Qb3BvdmVyKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5yZXNpemVTdWIpIHtcbiAgICAgIHRoaXMucmVzaXplU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucm91dGVDaGFuZ2VTdWIpIHtcbiAgICAgIHRoaXMucm91dGVDaGFuZ2VTdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zY3JvbGxFdmVudFVubGlzdGVuZXIpIHtcbiAgICAgIHRoaXMuc2Nyb2xsRXZlbnRVbmxpc3RlbmVyKCk7XG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIHBvc2l0aW9uaW5nU2VydmljZTogUG9zaXRpb25pbmdTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB3aW5SZWY6IFdpbmRvd1JlZixcbiAgICBwcm90ZWN0ZWQgY2hhbmdlRGV0ZWN0aW9uUmVmOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcm90ZWN0ZWQgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcm90ZWN0ZWQgcm91dGVyOiBSb3V0ZXJcbiAgKSB7fVxufVxuIl19