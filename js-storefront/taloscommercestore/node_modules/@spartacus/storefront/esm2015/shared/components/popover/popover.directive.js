import { Directive, ElementRef, Input, ViewContainerRef, ComponentFactoryResolver, Renderer2, ChangeDetectorRef, Output, EventEmitter, HostListener, } from '@angular/core';
import { WindowRef } from '@spartacus/core';
import { skip } from 'rxjs/operators';
import { PopoverComponent } from './popover.component';
import { PopoverEvent } from './popover.model';
import { PositioningService } from '../../services/positioning/positioning.service';
import { PopoverService } from './popover.service';
/**
 * Directive to bind popover with any DOM element.
 */
export class PopoverDirective {
    constructor(element, viewContainer, componentFactoryResolver, renderer, changeDetectorRef, positioningService, popoverService, winRef) {
        this.element = element;
        this.viewContainer = viewContainer;
        this.componentFactoryResolver = componentFactoryResolver;
        this.renderer = renderer;
        this.changeDetectorRef = changeDetectorRef;
        this.positioningService = positioningService;
        this.popoverService = popoverService;
        this.winRef = winRef;
        /**
         * An event emitted when the popover is opened.
         */
        this.openPopover = new EventEmitter();
        /**
         * An event emitted when the popover is closed.
         */
        this.closePopover = new EventEmitter();
    }
    /**
     * Listen events fired on element binded to popover directive.
     *
     * Based on event type some a11y improvements can be made.
     * For example if popover was opened by `space` or `enter` key
     * dedicated `FocusConfig` can be set to autofocus first
     * focusable element in popover container.
     */
    handleOpen(event) {
        if (event.target === this.element.nativeElement)
            this.toggle(event);
    }
    /**
     * Method performs open action for popover component.
     */
    open(event) {
        var _a, _b;
        if (!((_a = this.cxPopoverOptions) === null || _a === void 0 ? void 0 : _a.disable)) {
            this.isOpen = true;
            this.focusConfig = this.popoverService.getFocusConfig(event, ((_b = this.cxPopoverOptions) === null || _b === void 0 ? void 0 : _b.appendToBody) || false);
            this.renderPopover();
            if (this.openPopover)
                this.openPopover.emit();
        }
    }
    /**
     * Method performs close action for popover component.
     */
    close() {
        this.isOpen = false;
        this.viewContainer.clear();
        if (this.closePopover)
            this.closePopover.emit();
    }
    /**
     * Method performs toggle action for popover component.
     */
    toggle(event) {
        if (event && event.target === this.element.nativeElement && !this.isOpen)
            this.open(event);
        else if (this.isOpen)
            this.close();
    }
    /**
     * Method subscribes for events emitted by popover component
     * and based on event performs specific action.
     */
    handlePopoverEvents() {
        return this.popoverContainer.instance.eventSubject
            .pipe(skip(1))
            .subscribe((event) => {
            var _a;
            if (event !== PopoverEvent.INSIDE_CLICK &&
                event !== PopoverEvent.CLOSE_BUTTON_KEYDOWN)
                this.close();
            if (event === PopoverEvent.ESCAPE_KEYDOWN ||
                event === PopoverEvent.CLOSE_BUTTON_KEYDOWN) {
                this.popoverService.setFocusOnElement(this.element, this.focusConfig, (_a = this.cxPopoverOptions) === null || _a === void 0 ? void 0 : _a.appendToBody);
            }
        });
    }
    /**
     * Method creates instance and pass parameters to popover component.
     */
    renderPopover() {
        var _a, _b, _c, _d, _e, _f, _g;
        const containerFactory = this.componentFactoryResolver.resolveComponentFactory(PopoverComponent);
        this.popoverContainer = this.viewContainer.createComponent(containerFactory);
        const componentInstance = this.popoverContainer.instance;
        if (componentInstance) {
            componentInstance.content = this.cxPopover;
            componentInstance.triggerElement = this.element;
            componentInstance.popoverInstance = this.popoverContainer;
            componentInstance.focusConfig = this.focusConfig;
            componentInstance.position = (_a = this.cxPopoverOptions) === null || _a === void 0 ? void 0 : _a.placement;
            componentInstance.customClass = (_b = this.cxPopoverOptions) === null || _b === void 0 ? void 0 : _b.class;
            componentInstance.appendToBody = (_c = this.cxPopoverOptions) === null || _c === void 0 ? void 0 : _c.appendToBody;
            componentInstance.positionOnScroll = (_d = this.cxPopoverOptions) === null || _d === void 0 ? void 0 : _d.positionOnScroll;
            componentInstance.displayCloseButton = (_e = this.cxPopoverOptions) === null || _e === void 0 ? void 0 : _e.displayCloseButton;
            componentInstance.autoPositioning = (_f = this.cxPopoverOptions) === null || _f === void 0 ? void 0 : _f.autoPositioning;
            if ((_g = this.cxPopoverOptions) === null || _g === void 0 ? void 0 : _g.appendToBody) {
                this.renderer.appendChild(this.winRef.document.body, this.popoverContainer.location.nativeElement);
            }
            this.popoverContainer.changeDetectorRef.detectChanges();
            this.handlePopoverEvents();
        }
    }
}
PopoverDirective.decorators = [
    { type: Directive, args: [{
                selector: '[cxPopover]',
            },] }
];
PopoverDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ViewContainerRef },
    { type: ComponentFactoryResolver },
    { type: Renderer2 },
    { type: ChangeDetectorRef },
    { type: PositioningService },
    { type: PopoverService },
    { type: WindowRef }
];
PopoverDirective.propDecorators = {
    cxPopover: [{ type: Input }],
    cxPopoverOptions: [{ type: Input }],
    openPopover: [{ type: Output }],
    closePopover: [{ type: Output }],
    handleOpen: [{ type: HostListener, args: ['click', ['$event'],] }, { type: HostListener, args: ['keydown.enter', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wb3Zlci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvUGF0cnlrL0Rlc2t0b3Avc3BhcnRhY3VzL3Byb2plY3RzL3N0b3JlZnJvbnRsaWIvc3JjLyIsInNvdXJjZXMiOlsic2hhcmVkL2NvbXBvbmVudHMvcG9wb3Zlci9wb3BvdmVyLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixLQUFLLEVBRUwsZ0JBQWdCLEVBQ2hCLHdCQUF3QixFQUV4QixTQUFTLEVBQ1QsaUJBQWlCLEVBQ2pCLE1BQU0sRUFDTixZQUFZLEVBQ1osWUFBWSxHQUNiLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFlBQVksRUFBa0IsTUFBTSxpQkFBaUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQztBQUNwRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFbkQ7O0dBRUc7QUFJSCxNQUFNLE9BQU8sZ0JBQWdCO0lBc0ozQixZQUNZLE9BQW1CLEVBQ25CLGFBQStCLEVBQy9CLHdCQUFrRCxFQUNsRCxRQUFtQixFQUNuQixpQkFBb0MsRUFDcEMsa0JBQXNDLEVBQ3RDLGNBQThCLEVBQzlCLE1BQWlCO1FBUGpCLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFDbkIsa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBQy9CLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNuQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLHVCQUFr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QUFFLGFBQWE7YUFDeEI7OztZQXpCQyxVQUFVO1lBR1YsZ0JBQWdCO1lBQ2hCLHdCQUF3QjtZQUV4QixTQUFTO1lBQ1QsaUJBQWlCO1lBVVYsa0JBQWtCO1lBQ2xCLGNBQWM7WUFOZCxTQUFTOzs7d0JBa0JmLEtBQUs7K0JBS0wsS0FBSzswQkFLTCxNQUFNOzJCQUtOLE1BQU07eUJBMkJOLFlBQVksU0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsY0FDaEMsWUFBWSxTQUFDLGVBQWUsRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIENvbXBvbmVudFJlZixcbiAgUmVuZGVyZXIyLFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RMaXN0ZW5lcixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBXaW5kb3dSZWYgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgc2tpcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZvY3VzQ29uZmlnIH0gZnJvbSAnLi4vLi4vLi4vbGF5b3V0L2ExMXkva2V5Ym9hcmQtZm9jdXMva2V5Ym9hcmQtZm9jdXMubW9kZWwnO1xuaW1wb3J0IHsgUG9wb3ZlckNvbXBvbmVudCB9IGZyb20gJy4vcG9wb3Zlci5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9wb3ZlckV2ZW50LCBQb3BvdmVyT3B0aW9ucyB9IGZyb20gJy4vcG9wb3Zlci5tb2RlbCc7XG5pbXBvcnQgeyBQb3NpdGlvbmluZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wb3NpdGlvbmluZy9wb3NpdGlvbmluZy5zZXJ2aWNlJztcbmltcG9ydCB7IFBvcG92ZXJTZXJ2aWNlIH0gZnJvbSAnLi9wb3BvdmVyLnNlcnZpY2UnO1xuXG4vKipcbiAqIERpcmVjdGl2ZSB0byBiaW5kIHBvcG92ZXIgd2l0aCBhbnkgRE9NIGVsZW1lbnQuXG4gKi9cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tjeFBvcG92ZXJdJyxcbn0pXG5leHBvcnQgY2xhc3MgUG9wb3ZlckRpcmVjdGl2ZSB7XG4gIC8qKlxuICAgKiBUZW1wbGF0ZSBvciBzdHJpbmcgdG8gYmUgcmVuZGVyZWQgaW5zaWRlIHBvcG92ZXIgd3JhcHBlciBjb21wb25lbnQuXG4gICAqL1xuICBASW5wdXQoKSBjeFBvcG92ZXI6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT47XG5cbiAgLyoqXG4gICAqIE9wdGlvbnMgc2V0IGZvciBwb3BvdmVyIGNvbXBvbmVudC5cbiAgICovXG4gIEBJbnB1dCgpIGN4UG9wb3Zlck9wdGlvbnM/OiBQb3BvdmVyT3B0aW9ucztcblxuICAvKipcbiAgICogQW4gZXZlbnQgZW1pdHRlZCB3aGVuIHRoZSBwb3BvdmVyIGlzIG9wZW5lZC5cbiAgICovXG4gIEBPdXRwdXQoKSBvcGVuUG9wb3Zlcj86IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAvKipcbiAgICogQW4gZXZlbnQgZW1pdHRlZCB3aGVuIHRoZSBwb3BvdmVyIGlzIGNsb3NlZC5cbiAgICovXG4gIEBPdXRwdXQoKSBjbG9zZVBvcG92ZXI/OiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgLyoqXG4gICAqIEZsYWcgdXNlZCB0byBpbmZvcm0gYWJvdXQgY3VycmVudCBzdGF0ZSBvZiBwb3BvdmVyIGNvbXBvbmVudC5cbiAgICogUG9wb3ZlciBpcyBjbG9zZWQgYnkgZGVmYXVsdCwgc28gdmFsdWUgaXMgc2V0IHRvIGZhbHNlLlxuICAgKi9cbiAgaXNPcGVuOiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBQb3BvdmVyIGNvbXBvbmVudCBpbnN0YW5jZS5cbiAgICovXG4gIHBvcG92ZXJDb250YWluZXI6IENvbXBvbmVudFJlZjxQb3BvdmVyQ29tcG9uZW50PjtcblxuICAvKipcbiAgICogQ29uZmlndXJhdGlvbiBmb3IgYTExeSBpbXByb3ZlbWVudHMuXG4gICAqL1xuICBmb2N1c0NvbmZpZzogRm9jdXNDb25maWc7XG5cbiAgLyoqXG4gICAqIExpc3RlbiBldmVudHMgZmlyZWQgb24gZWxlbWVudCBiaW5kZWQgdG8gcG9wb3ZlciBkaXJlY3RpdmUuXG4gICAqXG4gICAqIEJhc2VkIG9uIGV2ZW50IHR5cGUgc29tZSBhMTF5IGltcHJvdmVtZW50cyBjYW4gYmUgbWFkZS5cbiAgICogRm9yIGV4YW1wbGUgaWYgcG9wb3ZlciB3YXMgb3BlbmVkIGJ5IGBzcGFjZWAgb3IgYGVudGVyYCBrZXlcbiAgICogZGVkaWNhdGVkIGBGb2N1c0NvbmZpZ2AgY2FuIGJlIHNldCB0byBhdXRvZm9jdXMgZmlyc3RcbiAgICogZm9jdXNhYmxlIGVsZW1lbnQgaW4gcG9wb3ZlciBjb250YWluZXIuXG4gICAqL1xuXG4gIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5lbnRlcicsIFsnJGV2ZW50J10pXG4gIGhhbmRsZU9wZW4oZXZlbnQ6IE1vdXNlRXZlbnQgfCBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpIHRoaXMudG9nZ2xlKGV2ZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2QgcGVyZm9ybXMgb3BlbiBhY3Rpb24gZm9yIHBvcG92ZXIgY29tcG9uZW50LlxuICAgKi9cbiAgb3BlbihldmVudDogTW91c2VFdmVudCB8IEtleWJvYXJkRXZlbnQpIHtcbiAgICBpZiAoIXRoaXMuY3hQb3BvdmVyT3B0aW9ucz8uZGlzYWJsZSkge1xuICAgICAgdGhpcy5pc09wZW4gPSB0cnVlO1xuICAgICAgdGhpcy5mb2N1c0NvbmZpZyA9IHRoaXMucG9wb3ZlclNlcnZpY2UuZ2V0Rm9jdXNDb25maWcoXG4gICAgICAgIGV2ZW50LFxuICAgICAgICB0aGlzLmN4UG9wb3Zlck9wdGlvbnM/LmFwcGVuZFRvQm9keSB8fCBmYWxzZVxuICAgICAgKTtcblxuICAgICAgdGhpcy5yZW5kZXJQb3BvdmVyKCk7XG5cbiAgICAgIGlmICh0aGlzLm9wZW5Qb3BvdmVyKSB0aGlzLm9wZW5Qb3BvdmVyLmVtaXQoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTWV0aG9kIHBlcmZvcm1zIGNsb3NlIGFjdGlvbiBmb3IgcG9wb3ZlciBjb21wb25lbnQuXG4gICAqL1xuICBjbG9zZSgpIHtcbiAgICB0aGlzLmlzT3BlbiA9IGZhbHNlO1xuICAgIHRoaXMudmlld0NvbnRhaW5lci5jbGVhcigpO1xuXG4gICAgaWYgKHRoaXMuY2xvc2VQb3BvdmVyKSB0aGlzLmNsb3NlUG9wb3Zlci5lbWl0KCk7XG4gIH1cblxuICAvKipcbiAgICogTWV0aG9kIHBlcmZvcm1zIHRvZ2dsZSBhY3Rpb24gZm9yIHBvcG92ZXIgY29tcG9uZW50LlxuICAgKi9cbiAgdG9nZ2xlKGV2ZW50OiBNb3VzZUV2ZW50IHwgS2V5Ym9hcmRFdmVudCkge1xuICAgIGlmIChldmVudCAmJiBldmVudC50YXJnZXQgPT09IHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50ICYmICF0aGlzLmlzT3BlbilcbiAgICAgIHRoaXMub3BlbihldmVudCk7XG4gICAgZWxzZSBpZiAodGhpcy5pc09wZW4pIHRoaXMuY2xvc2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2Qgc3Vic2NyaWJlcyBmb3IgZXZlbnRzIGVtaXR0ZWQgYnkgcG9wb3ZlciBjb21wb25lbnRcbiAgICogYW5kIGJhc2VkIG9uIGV2ZW50IHBlcmZvcm1zIHNwZWNpZmljIGFjdGlvbi5cbiAgICovXG4gIGhhbmRsZVBvcG92ZXJFdmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMucG9wb3ZlckNvbnRhaW5lci5pbnN0YW5jZS5ldmVudFN1YmplY3RcbiAgICAgIC5waXBlKHNraXAoMSkpXG4gICAgICAuc3Vic2NyaWJlKChldmVudDogUG9wb3ZlckV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBldmVudCAhPT0gUG9wb3ZlckV2ZW50LklOU0lERV9DTElDSyAmJlxuICAgICAgICAgIGV2ZW50ICE9PSBQb3BvdmVyRXZlbnQuQ0xPU0VfQlVUVE9OX0tFWURPV05cbiAgICAgICAgKVxuICAgICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGV2ZW50ID09PSBQb3BvdmVyRXZlbnQuRVNDQVBFX0tFWURPV04gfHxcbiAgICAgICAgICBldmVudCA9PT0gUG9wb3ZlckV2ZW50LkNMT1NFX0JVVFRPTl9LRVlET1dOXG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMucG9wb3ZlclNlcnZpY2Uuc2V0Rm9jdXNPbkVsZW1lbnQoXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQsXG4gICAgICAgICAgICB0aGlzLmZvY3VzQ29uZmlnLFxuICAgICAgICAgICAgdGhpcy5jeFBvcG92ZXJPcHRpb25zPy5hcHBlbmRUb0JvZHlcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2QgY3JlYXRlcyBpbnN0YW5jZSBhbmQgcGFzcyBwYXJhbWV0ZXJzIHRvIHBvcG92ZXIgY29tcG9uZW50LlxuICAgKi9cbiAgcmVuZGVyUG9wb3ZlcigpIHtcbiAgICBjb25zdCBjb250YWluZXJGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoXG4gICAgICBQb3BvdmVyQ29tcG9uZW50XG4gICAgKTtcbiAgICB0aGlzLnBvcG92ZXJDb250YWluZXIgPSB0aGlzLnZpZXdDb250YWluZXIuY3JlYXRlQ29tcG9uZW50KFxuICAgICAgY29udGFpbmVyRmFjdG9yeVxuICAgICk7XG5cbiAgICBjb25zdCBjb21wb25lbnRJbnN0YW5jZSA9IHRoaXMucG9wb3ZlckNvbnRhaW5lci5pbnN0YW5jZTtcbiAgICBpZiAoY29tcG9uZW50SW5zdGFuY2UpIHtcbiAgICAgIGNvbXBvbmVudEluc3RhbmNlLmNvbnRlbnQgPSB0aGlzLmN4UG9wb3ZlcjtcbiAgICAgIGNvbXBvbmVudEluc3RhbmNlLnRyaWdnZXJFbGVtZW50ID0gdGhpcy5lbGVtZW50O1xuICAgICAgY29tcG9uZW50SW5zdGFuY2UucG9wb3Zlckluc3RhbmNlID0gdGhpcy5wb3BvdmVyQ29udGFpbmVyO1xuICAgICAgY29tcG9uZW50SW5zdGFuY2UuZm9jdXNDb25maWcgPSB0aGlzLmZvY3VzQ29uZmlnO1xuICAgICAgY29tcG9uZW50SW5zdGFuY2UucG9zaXRpb24gPSB0aGlzLmN4UG9wb3Zlck9wdGlvbnM/LnBsYWNlbWVudDtcbiAgICAgIGNvbXBvbmVudEluc3RhbmNlLmN1c3RvbUNsYXNzID0gdGhpcy5jeFBvcG92ZXJPcHRpb25zPy5jbGFzcztcbiAgICAgIGNvbXBvbmVudEluc3RhbmNlLmFwcGVuZFRvQm9keSA9IHRoaXMuY3hQb3BvdmVyT3B0aW9ucz8uYXBwZW5kVG9Cb2R5O1xuICAgICAgY29tcG9uZW50SW5zdGFuY2UucG9zaXRpb25PblNjcm9sbCA9IHRoaXMuY3hQb3BvdmVyT3B0aW9ucz8ucG9zaXRpb25PblNjcm9sbDtcbiAgICAgIGNvbXBvbmVudEluc3RhbmNlLmRpc3BsYXlDbG9zZUJ1dHRvbiA9IHRoaXMuY3hQb3BvdmVyT3B0aW9ucz8uZGlzcGxheUNsb3NlQnV0dG9uO1xuICAgICAgY29tcG9uZW50SW5zdGFuY2UuYXV0b1Bvc2l0aW9uaW5nID0gdGhpcy5jeFBvcG92ZXJPcHRpb25zPy5hdXRvUG9zaXRpb25pbmc7XG5cbiAgICAgIGlmICh0aGlzLmN4UG9wb3Zlck9wdGlvbnM/LmFwcGVuZFRvQm9keSkge1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKFxuICAgICAgICAgIHRoaXMud2luUmVmLmRvY3VtZW50LmJvZHksXG4gICAgICAgICAgdGhpcy5wb3BvdmVyQ29udGFpbmVyLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnRcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5wb3BvdmVyQ29udGFpbmVyLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICAgIHRoaXMuaGFuZGxlUG9wb3ZlckV2ZW50cygpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBlbGVtZW50OiBFbGVtZW50UmVmLFxuICAgIHByb3RlY3RlZCB2aWV3Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByb3RlY3RlZCBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcm90ZWN0ZWQgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcm90ZWN0ZWQgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByb3RlY3RlZCBwb3NpdGlvbmluZ1NlcnZpY2U6IFBvc2l0aW9uaW5nU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgcG9wb3ZlclNlcnZpY2U6IFBvcG92ZXJTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB3aW5SZWY6IFdpbmRvd1JlZlxuICApIHt9XG59XG4iXX0=